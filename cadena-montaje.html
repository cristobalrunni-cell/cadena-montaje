<!DOCTYPE html><html lang="es"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadena de Montaje</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #191919;
  min-height: 100vh;
  color: #e0e0e0;
  display: flex;
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: 240px; min-height: 100vh; background: #202020;
  border-right: 1px solid #2a2a2a; padding: 16px 10px;
  display: flex; flex-direction: column; gap: 4px;
  position: fixed; left: 0; top: 0; bottom: 0; z-index: 100;
}
.sidebar-title {
  font-size: 11px; font-weight: 600; color: #6b6b6b;
  text-transform: uppercase; letter-spacing: 0.5px;
  padding: 8px 10px 6px; margin-top: 8px;
}
.sidebar-item {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; border-radius: 4px; cursor: pointer;
  font-size: 13px; color: #9a9a9a; transition: background 0.15s;
}
.sidebar-item:hover { background: #2a2a2a; color: #e0e0e0; }
.sidebar-item.active { background: #2a2a2a; color: #e0e0e0; }
.sidebar-item .icon { font-size: 14px; width: 20px; text-align: center; }

/* Brand dropdown */
.brand-dropdown {
  position: relative; margin: 0 6px;
}
.brand-dropdown-btn {
  display: flex; align-items: center; justify-content: space-between;
  width: 100%; padding: 7px 10px; border-radius: 4px;
  background: transparent; border: none; color: #e0e0e0;
  font-size: 13px; font-family: inherit; cursor: pointer;
  transition: background 0.15s;
}
.brand-dropdown-btn:hover { background: #2a2a2a; }
.brand-dropdown-btn .arrow { font-size: 10px; color: #6b6b6b; transition: transform 0.2s; }
.brand-dropdown-btn.open .arrow { transform: rotate(180deg); }
.brand-dropdown-list {
  display: none; padding: 2px 0; margin-top: 2px;
}
.brand-dropdown-list.open { display: block; }
.brand-option {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 10px 6px 28px; border-radius: 4px; cursor: pointer;
  font-size: 13px; color: #8a8a8a; transition: all 0.15s;
}
.brand-option:hover { background: #2a2a2a; color: #e0e0e0; }
.brand-option.selected { color: #e0e0e0; }
.brand-option.selected::before {
  content: ''; width: 6px; height: 6px; border-radius: 50%;
  background: currentColor; margin-left: -16px; margin-right: 2px;
}
.brand-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}

/* Sidebar legend */
.sidebar-legend { padding: 8px 10px; margin-top: auto; }
.sidebar-legend-item {
  display: flex; align-items: center; gap: 8px;
  padding: 3px 0; font-size: 11px; color: #6b6b6b;
}
.sidebar-legend-dot { width: 8px; height: 8px; border-radius: 2px; }

/* â”€â”€ MAIN CONTENT â”€â”€ */
.main {
  margin-left: 240px; flex: 1; min-height: 100vh;
  display: flex; flex-direction: column;
}

/* Top bar */
.topbar {
  display: flex; align-items: center; gap: 8px;
  padding: 12px 24px; border-bottom: 1px solid #2a2a2a;
  background: #202020; position: sticky; top: 0; z-index: 50;
}
.topbar-title {
  font-size: 14px; font-weight: 600; color: #e0e0e0; margin-right: auto;
}
.topbar-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 5px 12px; border-radius: 4px;
  background: transparent; border: 1px solid #333;
  color: #9a9a9a; font-size: 12px; font-family: inherit;
  cursor: pointer; transition: all 0.15s; font-weight: 500;
}
.topbar-btn:hover { background: #2a2a2a; color: #e0e0e0; border-color: #444; }
.topbar-btn .btn-icon { font-size: 13px; }

/* â”€â”€ KANBAN â”€â”€ */
.kanban {
  display: flex; gap: 0; padding: 20px 24px; flex: 1;
  overflow-x: auto; align-items: flex-start;
}
.kanban-column {
  min-width: 220px; max-width: 260px; flex-shrink: 0;
  display: flex; flex-direction: column;
}
.kanban-column + .kanban-column { border-left: 1px solid #2a2a2a; padding-left: 16px; margin-left: 16px; }

.kanban-col-header {
  display: flex; align-items: center; gap: 8px;
  padding: 0 4px 12px; margin-bottom: 8px;
}
.kanban-col-dot { width: 8px; height: 8px; border-radius: 2px; }
.kanban-col-title {
  font-size: 12px; font-weight: 600; color: #9a9a9a;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.kanban-col-count {
  font-size: 11px; color: #555; background: #2a2a2a;
  padding: 0 6px; border-radius: 10px; margin-left: auto;
}

/* Kanban cards */
.kanban-card {
  background: #252525; border: 1px solid #2e2e2e;
  border-radius: 4px; padding: 10px 12px; margin-bottom: 6px;
  cursor: pointer; transition: background 0.15s;
}
.kanban-card:hover { background: #2a2a2a; }
.kanban-card-name { font-size: 13px; font-weight: 500; color: #e0e0e0; margin-bottom: 6px; }
.kanban-card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.kanban-card-tag {
  font-size: 10px; font-weight: 600; padding: 2px 6px;
  border-radius: 3px; text-transform: uppercase; letter-spacing: 0.3px;
}
.kanban-card-owner {
  font-size: 11px; color: #6b6b6b; margin-left: auto;
}

/* Tag colors for step types */
.tag-drum { background: #27ae6022; color: #57d48f; }
.tag-buffer { background: #2980b922; color: #5dade2; }
.tag-reu { background: #8e44ad22; color: #bb86fc; }

/* Construction placeholder */
.kanban-construction {
  padding: 24px 12px; text-align: center; color: #444;
  font-size: 12px;
}
.kanban-construction span { display: block; margin-bottom: 4px; font-size: 18px; }

/* â”€â”€ OVERLAY / POPUPS (unchanged logic) â”€â”€ */
.overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7); z-index: 1000;
  display: none; align-items: center; justify-content: center; padding: 20px;
}
.overlay.active { display: flex; }
.popup {
  background: #252525; border-radius: 8px; border: 1px solid #333;
  max-width: 860px; width: 100%; max-height: 90vh; overflow-y: auto;
}
.popup-header {
  padding: 16px 24px; border-radius: 8px 8px 0 0;
  display: flex; justify-content: space-between; align-items: center;
}
.popup-header-title { font-size: 15px; font-weight: 700; color: #fff; }
.popup-header-sub { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; }
.popup-close {
  cursor: pointer; color: #fff; font-size: 18px; font-weight: 600;
  opacity: 0.5; padding: 0 4px; background: none; border: none;
}
.popup-close:hover { opacity: 1; }
.popup-body { padding: 20px; }
.section-label { font-size: 11px; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.8px; text-transform: uppercase; }
.section-block { margin-bottom: 16px; }
.section-item {
  border-radius: 4px; padding: 8px 12px;
  display: flex; align-items: flex-start; gap: 8px; margin-bottom: 4px;
}
.section-item-emoji { font-size: 14px; }
.section-item-text { font-size: 12px; color: #bbb; line-height: 1.5; }
.section-item-text a { color: #bb86fc; font-size: 11px; text-decoration: underline; }

/* Execute / Week / Log */
.execute-btn {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  width: 100%; padding: 12px 24px; margin-top: 8px;
  border: 1px solid #bb86fc55; border-radius: 4px;
  background: #bb86fc12; color: #bb86fc; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.execute-btn:hover { background: #bb86fc22; border-color: #bb86fc; }
.execute-btn.loading { border-color: #f39c1255; color: #f39c12; background: #f39c1212; pointer-events: none; opacity: 0.7; }
.execute-btn.success { border-color: #27ae60; color: #fff; background: #27ae60; }
.execute-btn.error { border-color: #e74c3c55; color: #e74c3c; background: #e74c3c12; }
.week-selector { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 10px 14px; background: #2a2a2a; border: 1px solid #333; border-radius: 4px; }
.week-selector label { font-size: 11px; font-weight: 600; color: #9a9a9a; text-transform: uppercase; letter-spacing: 0.5px; }
.week-selector input[type="date"] {
  background: #191919; color: #e0e0e0; border: 1px solid #333; border-radius: 4px;
  padding: 6px 10px; font-size: 13px; font-family: inherit;
}
.week-selector input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
.log-terminal {
  background: #191919; border: 1px solid #333; border-radius: 4px;
  max-height: 350px; overflow-y: auto; padding: 12px; margin-top: 8px;
  font-family: 'SF Mono', 'Fira Code', monospace; font-size: 11px;
  line-height: 1.6; color: #888; display: none;
}
.log-terminal.active { display: block; }
.log-line { white-space: pre-wrap; word-break: break-all; }
.log-line.error { color: #e74c3c; }
.log-line.success { color: #27ae60; }
.cancel-btn {
  display: none; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 10px; margin-top: 6px;
  border: 1px solid #e74c3c33; border-radius: 4px;
  background: transparent; color: #e74c3c; font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.cancel-btn.active { display: flex; }
.cancel-btn:hover { background: #e74c3c; color: #fff; }
.context-box { margin-bottom: 8px; padding: 10px 14px; background: #2a2a2a; border: 1px solid #333; border-radius: 4px; }
.context-box label { display: block; font-size: 11px; font-weight: 600; color: #9a9a9a; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.context-box .context-hint { font-size: 10px; color: #555; margin-top: 4px; }

/* Parrilla table */
.parrilla-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
.parrilla-table th {
  padding: 8px 12px; text-align: left; color: #9a9a9a;
  font-weight: 600; font-size: 10px; text-transform: uppercase;
  letter-spacing: 0.5px; border-bottom: 1px solid #333; background: #2a2a2a;
}
.parrilla-table td { padding: 8px 12px; border-bottom: 1px solid #2a2a2a; color: #bbb; font-size: 12px; }
.parrilla-table tr:hover { background: #2a2a2a; }
.parrilla-table .red-badge {
  display: inline-block; padding: 2px 8px; border-radius: 3px;
  font-size: 10px; font-weight: 600;
}
.parrilla-total { font-weight: 700; color: #e0e0e0; background: #2a2a2a; }

/* Nueva idea form */
.idea-form-field { flex: 1; min-width: 180px; }
.idea-form-field label { display: block; font-size: 10px; font-weight: 600; color: #6b6b6b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.idea-form-field input, .idea-form-field textarea {
  width: 100%; background: #191919; color: #e0e0e0; border: 1px solid #333; border-radius: 4px;
  padding: 10px 12px; font-size: 13px; font-family: inherit;
}
.idea-form-field input::placeholder, .idea-form-field textarea::placeholder { color: #555; }
.idea-form-row { display: flex; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
.tag-group { display: flex; flex-wrap: wrap; gap: 4px; }
.tag-pill {
  padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: 500;
  cursor: pointer; transition: all 0.15s; user-select: none;
  border: 1px solid #333; background: #2a2a2a; color: #888;
}
.tag-pill:hover { border-color: #555; color: #ccc; }
.tag-pill.selected { border-color: var(--tag-color, #bb86fc); background: var(--tag-bg, #bb86fc18); color: var(--tag-color, #bb86fc); font-weight: 600; }
.context-extras {
  margin-top: 14px; padding: 12px; border-radius: 4px;
  background: #2a2a2a; border: 1px dashed #3a3a3a;
}
.context-extras label { display: block; font-size: 10px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.context-extras textarea {
  width: 100%; min-height: 100px; background: #191919; color: #888; border: 1px solid #333; border-radius: 4px;
  padding: 10px 12px; font-size: 12px; font-family: inherit; resize: none;
  overflow: hidden; field-sizing: content;
}
.context-extras textarea::placeholder { color: #444; }
.context-extras .hint { font-size: 9px; color: #444; margin-top: 4px; }
.idea-submit-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 12px; margin-top: 12px;
  border: 1px solid #27ae60; border-radius: 4px;
  background: #27ae6012; color: #27ae60; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.idea-submit-btn:hover { background: #27ae60; color: #fff; }
.idea-submit-btn:disabled { opacity: 0.5; pointer-events: none; }
.idea-submit-btn.success { background: #27ae60; color: #fff; }
.idea-submit-btn.error { border-color: #e74c3c; color: #e74c3c; background: #e74c3c12; }
.idea-result { margin-top: 8px; padding: 10px; border-radius: 4px; font-size: 12px; display: none; }
.idea-result.show { display: block; }
.idea-result.success { background: #27ae6018; border: 1px solid #27ae6033; color: #27ae60; }
.idea-result.error { background: #e74c3c18; border: 1px solid #e74c3c33; color: #e74c3c; }
</style></head><body>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div style="padding:6px 10px;margin-bottom:8px">
    <div style="font-size:14px;font-weight:700;color:#e0e0e0">Cadena de Montaje</div>
  </div>

  <div class="sidebar-title">Redes Sociales</div>
  <div class="brand-dropdown">
    <button class="brand-dropdown-btn" onclick="toggleBrandDropdown()">
      <span id="brand-label">CEO Media</span>
      <span class="arrow">&#9662;</span>
    </button>
    <div class="brand-dropdown-list" id="brand-list">
      <div class="brand-option selected" data-brand="ceomedia" onclick="switchBrand('ceomedia')">
        <span class="brand-dot" style="background:#bb86fc"></span> CEO Media
      </div>
      <div class="brand-option" data-brand="runclub" onclick="switchBrand('runclub')">
        <span class="brand-dot" style="background:#00f2ea"></span> Runclub
      </div>
      <div class="brand-option" data-brand="runnerpro" onclick="switchBrand('runnerpro')">
        <span class="brand-dot" style="background:#f39c12"></span> RunnerPro
      </div>
    </div>
  </div>

  <div style="height:16px"></div>
  <div class="sidebar-title">Vistas</div>
  <div class="sidebar-item active" onclick="showView('kanban')">
    <span class="icon">&#9776;</span> Pipeline
  </div>

  <div class="sidebar-legend">
    <div class="sidebar-title" style="padding-left:0">Leyenda</div>
    <div class="sidebar-legend-item"><span class="sidebar-legend-dot" style="background:#27ae60"></span> Drum (IA)</div>
    <div class="sidebar-legend-item"><span class="sidebar-legend-dot" style="background:#2980b9"></span> Buffer (Revision)</div>
    <div class="sidebar-legend-item"><span class="sidebar-legend-dot" style="background:#8e44ad"></span> Reunion</div>
    <div class="sidebar-legend-item"><span class="sidebar-legend-dot" style="background:#555"></span> En construccion</div>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="main-title">Pipeline â€” CEO Media</div>
    <button class="topbar-btn" onclick="openParrilla()"><span class="btn-icon">&#128197;</span> Parrilla</button>
    <button class="topbar-btn" onclick="openNuevaIdea()"><span class="btn-icon">&#43;</span> Nueva idea</button>
  </div>
  <div class="kanban" id="kanban"></div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay" onclick="closePopup()">
  <div class="popup" id="popup-content" onclick="event.stopPropagation()"></div>
</div>

<script>
// â”€â”€ State â”€â”€
let currentBrand = 'ceomedia';

const brandConfig = {
  ceomedia: { label: "CEO Media", profile: "cristobal running", defaultPilar: "ğŸƒğŸ» EducaciÃ³n", defaultRedes: ["Instagram","TikTok"] },
  runclub:  { label: "Runclub",   profile: "Runclub",           defaultPilar: "ğŸŸï¸ Comunidad",    defaultRedes: ["Instagram"] },
  runnerpro:{ label: "RunnerPro", profile: "RunnerPro",         defaultPilar: "ğŸƒğŸ» EducaciÃ³n",   defaultRedes: ["Instagram","TikTok","YouTube"] },
};

// Phase data â€” IDEA is always #1B4F72 (blue)
const brandPhases = {
  ceomedia: [
    { id:"idea", title:"IDEA", color:"#1B4F72", steps:[
      { name:"Crea Idea", type:"drum", popupId:"crea-idea", owner:"Lucia Â· Runni" },
      { name:"Revisa Ideas", type:"buffer", popupId:"lucia-revisa", owner:"Lucia" },
      { name:"Reu Validacion Ideas", type:"reu", popupId:"reu-validacion", owner:"Lucia Â· Carmen Â· Cristobal" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica", owner:"Lucia" },
    ]},
    { id:"creation", title:"CREACION GUION", color:"#7D3C98", steps:[
      { name:"Guion IA", type:"drum", popupId:"guion-ia", owner:"Lucia Â· Runni" },
      { name:"Revisa Guiones", type:"buffer", popupId:"lucia-revisa-guiones", owner:"Lucia" },
      { name:"Reu Validacion Guiones", type:"reu", popupId:"reu-validacion-guiones", owner:"Lucia Â· Carmen" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica-guiones", owner:"Lucia" },
    ]},
    { id:"visual", title:"CREACION VISUAL", color:"#D35400", steps:[
      { name:"Visual IA", type:"drum", popupId:"visual-ia", owner:"Lucia Â· Runni" },
      { name:"Revisa Visuales", type:"buffer", popupId:"revisa-visuales", owner:"Lucia" },
      { name:"Reu Validacion Visuales", type:"reu", popupId:"reu-validacion-visuales", owner:"Lucia Â· Carmen" },
      { name:"Aplica Cambios", type:"buffer", popupId:"aplica-visuales", owner:"Lucia" },
    ]},
    { id:"recording", title:"GRABACION", color:"#1E8449", construction:true, steps:[] },
    { id:"editing", title:"EDICION", color:"#8E44AD", construction:true, steps:[] },
    { id:"publishing", title:"PUBLICACION", color:"#2C3E50", construction:true, steps:[] },
  ],
  runclub: [
    { id:"idea", title:"IDEA", color:"#1B4F72", steps:[
      { name:"Crea Idea", type:"drum", popupId:"crea-idea", owner:"Runni" },
      { name:"Revisa Ideas", type:"buffer", popupId:"lucia-revisa", owner:"Lucia" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica", owner:"Lucia" },
    ]},
    { id:"creation", title:"CREACION GUION", color:"#7D3C98", steps:[
      { name:"Guion IA", type:"drum", popupId:"guion-ia", owner:"Runni" },
      { name:"Revisa Guiones", type:"buffer", popupId:"lucia-revisa-guiones", owner:"Lucia" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica-guiones", owner:"Lucia" },
    ]},
    { id:"visual", title:"CREACION VISUAL", color:"#D35400", construction:true, steps:[] },
    { id:"recording", title:"GRABACION", color:"#1E8449", construction:true, steps:[] },
    { id:"editing", title:"EDICION", color:"#8E44AD", construction:true, steps:[] },
    { id:"publishing", title:"PUBLICACION", color:"#2C3E50", construction:true, steps:[] },
  ],
  runnerpro: [
    { id:"idea", title:"IDEA", color:"#1B4F72", steps:[
      { name:"Crea Idea", type:"drum", popupId:"crea-idea", owner:"Runni" },
      { name:"Revisa Ideas", type:"buffer", popupId:"lucia-revisa", owner:"Lucia" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica", owner:"Lucia" },
    ]},
    { id:"creation", title:"CREACION GUION", color:"#7D3C98", steps:[
      { name:"Guion IA", type:"drum", popupId:"guion-ia", owner:"Runni" },
      { name:"Revisa Guiones", type:"buffer", popupId:"lucia-revisa-guiones", owner:"Lucia" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica-guiones", owner:"Lucia" },
    ]},
    { id:"visual", title:"CREACION VISUAL", color:"#D35400", construction:true, steps:[] },
    { id:"recording", title:"GRABACION", color:"#1E8449", construction:true, steps:[] },
    { id:"editing", title:"EDICION", color:"#8E44AD", construction:true, steps:[] },
    { id:"publishing", title:"PUBLICACION", color:"#2C3E50", construction:true, steps:[] },
  ],
};

const typeLabels = { drum: "DRUM", buffer: "BUFFER", reu: "REU" };
const typeTags = { drum: "tag-drum", buffer: "tag-buffer", reu: "tag-reu" };

// â”€â”€ Brand switching â”€â”€
function toggleBrandDropdown() {
  const list = document.getElementById('brand-list');
  const btn = document.querySelector('.brand-dropdown-btn');
  list.classList.toggle('open');
  btn.classList.toggle('open');
}

function switchBrand(brand) {
  currentBrand = brand;
  document.getElementById('brand-label').textContent = brandConfig[brand].label;
  document.getElementById('main-title').textContent = 'Pipeline â€” ' + brandConfig[brand].label;
  // Update selected state
  document.querySelectorAll('.brand-option').forEach(o => o.classList.remove('selected'));
  document.querySelector(`.brand-option[data-brand="${brand}"]`).classList.add('selected');
  // Close dropdown
  document.getElementById('brand-list').classList.remove('open');
  document.querySelector('.brand-dropdown-btn').classList.remove('open');
  renderKanban();
}

function showView() { /* future views */ }

// â”€â”€ Kanban render â”€â”€
function renderKanban() {
  const kanban = document.getElementById('kanban');
  kanban.innerHTML = '';
  const phases = brandPhases[currentBrand];
  phases.forEach(phase => {
    const col = document.createElement('div');
    col.className = 'kanban-column';

    // Header
    const header = document.createElement('div');
    header.className = 'kanban-col-header';
    header.innerHTML = `
      <span class="kanban-col-dot" style="background:${phase.color}"></span>
      <span class="kanban-col-title">${phase.title}</span>
      ${!phase.construction ? `<span class="kanban-col-count">${phase.steps.length}</span>` : ''}
    `;
    col.appendChild(header);

    if (phase.construction) {
      col.innerHTML += '<div class="kanban-construction"><span>&#128679;</span>Proximamente</div>';
    } else {
      phase.steps.forEach(step => {
        const card = document.createElement('div');
        card.className = 'kanban-card';
        card.onclick = () => openPopup(step.popupId);
        card.innerHTML = `
          <div class="kanban-card-name">${step.name}</div>
          <div class="kanban-card-meta">
            <span class="kanban-card-tag ${typeTags[step.type]}">${typeLabels[step.type]}</span>
            <span class="kanban-card-owner">${step.owner}</span>
          </div>
        `;
        col.appendChild(card);
      });
    }
    kanban.appendChild(col);
  });
}
renderKanban();

// â”€â”€ Popup system â”€â”€
function sectionHTML(section, color, items) {
  return `<div class="section-block"><div class="section-label" style="color:${color}">${section}</div>${items.map(item => `<div class="section-item" style="background:${color}12;border:1px solid ${color}22"><span class="section-item-emoji">${item.emoji}</span><span class="section-item-text">${item.text}${item.link ? ` <a href="${item.link}" target="_blank">(Notion Prompt)</a>` : ''}</span></div>`).join('')}</div>`;
}

function getNextMonday() {
  const d = new Date(); const day = d.getDay();
  d.setDate(d.getDate() + (day === 0 ? 1 : 8 - day));
  return d.toISOString().split('T')[0];
}

function executeButtonHTML(apiEndpoint, label, showContext) {
  const defaultDate = getNextMonday();
  let contextHTML = '';
  if (showContext) {
    const pilares = ['veneno','victor_heras','andrea','post_personal','stories'];
    const pilarLabels = { veneno:'Veneno', victor_heras:'Victor Heras', andrea:'Andrea', post_personal:'Post Personal', stories:'Stories' };
    const contextFields = pilares.map(p =>
      `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="min-width:100px;font-size:11px;font-weight:500;color:#9a9a9a">${pilarLabels[p]}</span><input type="text" id="ctx-${apiEndpoint}-${p}" placeholder="contexto opcional" style="flex:1;background:#191919;color:#e0e0e0;border:1px solid #333;border-radius:4px;padding:6px 8px;font-size:11px;font-family:inherit"></div>`
    ).join('');
    contextHTML = `<div class="context-box"><label>Contexto por pilar <span style="font-weight:400;text-transform:none;color:#555">(opcional)</span></label>${contextFields}<div class="context-hint">Deja vacio para que la IA decida libremente.</div></div>`;
  }
  return `<div class="week-selector"><label>Semana del lunes:</label><input type="date" id="semana-${apiEndpoint}" value="${defaultDate}"></div>${contextHTML}<button class="execute-btn" id="btn-${apiEndpoint}" onclick="executeProcess('${apiEndpoint}', this)">EJECUTAR: ${label}</button><button class="cancel-btn" id="cancel-${apiEndpoint}" onclick="cancelProcess('${apiEndpoint}')">CANCELAR</button><div class="log-terminal" id="log-${apiEndpoint}"></div><div style="height:12px"></div>`;
}

const popups = {
"crea-idea": () => `<div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)"><div><div class="popup-header-title">Crea Idea â€” ${brandConfig[currentBrand].label}</div><div class="popup-header-sub">40+ piezas/semana</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ“…",text:"Parrilla Semanal â€” distribucion de formatos, frecuencias y plataformas"},{emoji:"ğŸ™ï¸",text:"Embeddings BBDD Historico â€” videos propios publicados"},{emoji:"ğŸ”",text:"Embeddings BBDD Creadores Referentes â€” busqueda semantica en 20K+ escenas"},{emoji:"ğŸ“Š",text:"Excel Moneyball por Creador â€” patrones ganadores con % exito"},{emoji:"ğŸ¯",text:"Estrategia â€” objetivo de cada tipo de video y posicionamiento de marca"},])}${sectionHTML("PROCESO","#bb86fc",[])}${executeButtonHTML("crea-idea","CREA IDEA",true)}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ“",text:"Por cada hueco de la parrilla, la IA genera una primera idea de contenido con hook, semantica, probabilidad de exito y un comentario de por que es ganadora."},])}</div>`,
"lucia-revisa": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Revisa Ideas</div><div class="popup-header-sub">Revision previa a la reunion</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ¤–",text:"Ideas generadas por Runni en el Calendario Social Media de Notion"},{emoji:"ğŸ“…",text:"Calendario de la semana con los huecos ya asignados"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ğŸ‘€",text:"Lucia revisa cada idea generada por la IA"},{emoji:"âœï¸",text:"Anade comentarios en Notion sobre cada idea"},{emoji:"ğŸ’¡",text:"Apunta ideas propias que se le ocurran al revisar"},{emoji:"âš ï¸",text:"Marca las ideas que ve mas flojas"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ“‹",text:"Calendario con comentarios de Lucia â€” listo para la reu de validacion"},{emoji:"ğŸ’¡",text:"Lista de ideas propias como alternativas o complementos"},])}</div>`,
"reu-validacion": () => `<div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)"><div><div class="popup-header-title">Reu Validacion Ideas</div><div class="popup-header-sub">Maximo 30 minutos</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ¤–",text:"Ideas de Runni ya escritas en el Calendario"},{emoji:"âœï¸",text:"Comentarios de Lucia en cada idea"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ğŸ—£ï¸",text:"Reu de maximo 30 minutos"},{emoji:"âœ…",text:"Por cada idea: aprobar, modificar o descartar con razon concreta"},{emoji:"ğŸ“",text:"Se apuntan cambios directos y contexto especifico"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ™ï¸",text:"Reunion transcrita automaticamente"},{emoji:"ğŸ“‹",text:"Lista de cambios concisos sobre cada idea"},])}</div>`,
"lucia-aplica": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Aplica Cambios</div><div class="popup-header-sub">Transcripcion de reu â†’ IA aplica â†’ Lucia revisa</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ™ï¸",text:"Transcripcion de la reunion de validacion"},{emoji:"ğŸ“…",text:"Calendario Social Media actual"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ğŸ¤–",text:"Notion Prompt recibe la transcripcion + calendario â†’ aplica cambios"},{emoji:"ğŸ‘€",text:"Lucia revisa los cambios aplicados por la IA"},{emoji:"âœï¸",text:"Ajustes finales manuales si algo no cuadra"},{emoji:"ğŸš€",text:"Activar Notion Prompt para fase CREACION",link:"https://www.notion.so/Guion-IA-CEO-Media-303a67fd29b280188115cd8bd2fb4c87"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ“…",text:"Calendario de la semana cerrado con ideas finales"},{emoji:"ğŸ¤–",text:"Runni empieza a rodar â€” genera automaticamente Guion IA"},{emoji:"ğŸ”’",text:"Ciclo IDEA cerrado â†’ las ideas pasan a CREACION"},])}</div>`,
"guion-ia": () => `<div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)"><div><div class="popup-header-title">Guion IA</div><div class="popup-header-sub">6 inputs â†’ Runni genera guion completo</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ“…",text:"Parrilla Semanal"},{emoji:"ğŸ™ï¸",text:"Embeddings BBDD Historico"},{emoji:"ğŸ”",text:"Embeddings BBDD Creadores Referentes"},{emoji:"ğŸ“Š",text:"Excel Moneyball por Creador"},{emoji:"ğŸ¯",text:"Estrategia â€” objetivo de cada tipo de video"},{emoji:"ğŸ’¡",text:"Ideas y Comentarios del Calendario Notion"},])}${sectionHTML("PROCESO","#bb86fc",[])}${executeButtonHTML("guion-ia","GUION IA")}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ“",text:"En cada pagina de Notion: guion completo del video con hook detallado + guion narrativo"},{emoji:"ğŸ“‹",text:"Descripcion de la publicacion"},])}</div>`,
"lucia-revisa-guiones": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Revisa Guiones</div><div class="popup-header-sub">Revision de cada guion generado</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ“",text:"Guiones de Runni escritos en cada pagina de Notion"},{emoji:"ğŸ“…",text:"Calendario semanal con las ideas validadas"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ğŸ‘ï¸",text:"Lucia lee cada guion y compara con la idea original"},{emoji:"ğŸ’¬",text:"Anade comentarios en Notion"},{emoji:"âš ï¸",text:"Marca los guiones que necesitan cambios fuertes"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ“‹",text:"Guiones con comentarios listos para la reu de validacion"},])}</div>`,
"reu-validacion-guiones": () => `<div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)"><div><div class="popup-header-title">Reu Validacion Guiones</div><div class="popup-header-sub">Maximo 30 minutos</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ“",text:"Guiones generados por Runni con comentarios"},{emoji:"ğŸ’¬",text:"Comentarios de Lucia en cada guion"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ğŸ—£ï¸",text:"Reu de maximo 30 minutos"},{emoji:"âœ…",text:"Por cada guion: aprobar, modificar o descartar"},{emoji:"ğŸ“",text:"Se apuntan cambios directos"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ™ï¸",text:"Reunion transcrita automaticamente"},{emoji:"ğŸ“‹",text:"Lista de cambios concisos sobre cada guion"},])}</div>`,
"lucia-aplica-guiones": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Aplica Cambios Guiones</div><div class="popup-header-sub">Aplica los cambios de la reu en los guiones</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ™ï¸",text:"Transcripcion de la reu de validacion de guiones"},{emoji:"ğŸ“",text:"Guiones actuales en Notion"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ğŸ¤–",text:"Notion Prompt recibe transcripcion + guiones â†’ aplica cambios"},{emoji:"ğŸ‘ï¸",text:"Lucia revisa los cambios aplicados"},{emoji:"âœï¸",text:"Ajustes manuales si es necesario"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"âœ…",text:"Guiones cerrados y listos para crear Visual IA"},{emoji:"ğŸ¤–",text:"Runni empieza a rodar â€” genera automaticamente Visual IA"},])}</div>`,
"visual-ia": () => `<div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)"><div><div class="popup-header-title">Visual IA</div><div class="popup-header-sub">Guion cerrado â†’ storyboard â†’ PDF</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ“…",text:"Parrilla Semanal"},{emoji:"ğŸ™ï¸",text:"Embeddings BBDD Historico"},{emoji:"ğŸ”",text:"Embeddings BBDD Creadores Referentes â€” 20K+ escenas"},{emoji:"ğŸ“Š",text:"Excel Moneyball por Creador"},{emoji:"ğŸ“",text:"Guion de cada video (viene de CREACION GUION)"},])}${sectionHTML("PROCESO","#bb86fc",[])}${executeButtonHTML("visual-ia","VISUAL IA")}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ¬",text:"Google Doc con Visual y Storyboard subido a Drive, linkeado en Notion"},])}</div>`,
"revisa-visuales": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Revisa Visuales</div><div class="popup-header-sub">Revision de storyboards visuales</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ¬",text:"Storyboards visuales PDF generados por Visual IA"},{emoji:"ğŸ“",text:"Guiones cerrados de Notion como referencia"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ğŸ‘ï¸",text:"Revisa cada storyboard y compara con el guion cerrado"},{emoji:"ğŸ’¬",text:"Anade comentarios sobre planos, transiciones, overlays"},{emoji:"âš ï¸",text:"Marca los que necesitan cambios fuertes"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ“‹",text:"Storyboards con comentarios listos para la reu"},])}</div>`,
"reu-validacion-visuales": () => `<div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)"><div><div class="popup-header-title">Reu Validacion Visuales</div><div class="popup-header-sub">Maximo 30 minutos</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ¬",text:"Storyboards visuales con comentarios de la revision"},{emoji:"ğŸ’¬",text:"Notas y ajustes propuestos"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ğŸ—£ï¸",text:"Reu de maximo 30 minutos"},{emoji:"âœ…",text:"Por cada visual: aprobar, modificar o descartar"},{emoji:"ğŸ“",text:"Se apuntan cambios directos"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"ğŸ™ï¸",text:"Reunion transcrita automaticamente"},{emoji:"ğŸ“‹",text:"Lista de cambios concisos sobre cada storyboard"},])}</div>`,
"aplica-visuales": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Aplica Cambios Visuales</div><div class="popup-header-sub">Aplica los cambios de la reu en los storyboards</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ğŸ™ï¸",text:"Transcripcion de la reu de validacion visual"},{emoji:"ğŸ¬",text:"Storyboards actuales con los comentarios previos"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"âœï¸",text:"Aplica cambios manuales en los storyboards segun la reu"},{emoji:"ğŸ‘ï¸",text:"Revision final de coherencia guion â†” visual"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"âœ…",text:"Storyboards cerrados y listos para grabar"},{emoji:"ğŸ”’",text:"Ciclo CREACION cerrado â†’ pasan a GRABACION"},])}</div>`,
};

function openPopup(popupId) {
  if (popups[popupId]) {
    document.getElementById('popup-content').innerHTML = popups[popupId]();
    document.getElementById('overlay').classList.add('active');
  }
}
function closePopup() { document.getElementById('overlay').classList.remove('active'); }

// â”€â”€ Execute process (SSE) â”€â”€
let currentRunId = null;
let currentEventSource = null;

async function executeProcess(endpoint, btn) {
  const semanaInput = document.getElementById('semana-' + endpoint);
  const semana = semanaInput ? semanaInput.value : null;
  const logDiv = document.getElementById('log-' + endpoint);
  const cancelBtn = document.getElementById('cancel-' + endpoint);
  const label = endpoint.replace(/-/g,' ').toUpperCase();
  const context = {};
  ['veneno','victor_heras','andrea','post_personal','stories'].forEach(p => {
    const input = document.getElementById('ctx-' + endpoint + '-' + p);
    if (input && input.value.trim()) context[p] = input.value.trim();
  });
  btn.className = 'execute-btn loading'; btn.textContent = 'Ejecutando...';
  logDiv.innerHTML = ''; logDiv.classList.add('active'); cancelBtn.classList.add('active');
  try {
    const res = await fetch('/api/cadena/run', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({process:endpoint,semana,context}) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Error desconocido');
    currentRunId = data.runId;
    addLogLine(logDiv, 'â–¶ Proceso: '+endpoint+' | Semana: '+(semana||'auto')+' | Run: '+data.runId, 'success');
    if (currentEventSource) currentEventSource.close();
    currentEventSource = new EventSource('/api/pipeline/stream/'+data.runId);
    currentEventSource.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === 'log') { addLogLine(logDiv, msg.text, msg.text.includes('âŒ')||msg.text.includes('[stderr]')?'error':msg.text.includes('âœ…')?'success':''); }
      else if (msg.type === 'done') {
        currentEventSource.close(); currentEventSource=null; currentRunId=null; cancelBtn.classList.remove('active');
        if (msg.status==='completed') { btn.className='execute-btn success'; btn.textContent='Completado'; addLogLine(logDiv,'PROCESO COMPLETADO','success'); }
        else { btn.className='execute-btn error'; btn.textContent='Error (exit '+msg.exitCode+')'; addLogLine(logDiv,'PROCESO FALLIDO','error'); }
        setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},5000);
      }
    };
    currentEventSource.onerror = () => {
      currentEventSource.close(); currentEventSource=null; cancelBtn.classList.remove('active');
      btn.className='execute-btn error'; btn.textContent='Conexion perdida';
      setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},3000);
    };
  } catch(err) {
    btn.className='execute-btn error'; btn.textContent=err.message; cancelBtn.classList.remove('active');
    addLogLine(logDiv, err.message,'error');
    setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},3000);
  }
}
function addLogLine(logDiv, text, cls) {
  const line = document.createElement('div');
  line.className = 'log-line'+(cls?' '+cls:''); line.textContent = text;
  logDiv.appendChild(line); logDiv.scrollTop = logDiv.scrollHeight;
}
async function cancelProcess(endpoint) {
  if (!currentRunId) return;
  try { await fetch('/api/pipeline/cancel/'+currentRunId,{method:'POST'}); addLogLine(document.getElementById('log-'+endpoint),'Cancelado por el usuario','error'); } catch(e){}
}

// â”€â”€ Parrilla â”€â”€
const brandParrillas = {
  ceomedia: {
    sub:"40+ piezas/semana",
    rows:[
      {ref:"Veneno",qty:"15",tiktok:"7 nativos",ig:"5 reels + 3 resubidas",yt:"â€”",intencion:"Alcance + Viralizacion"},
      {ref:"Victor Heras",qty:"14",tiktok:"5 nativos",ig:"3 reels + 2 resubidas",yt:"3 shorts + 1 long",intencion:"Autoridad + Educacion + SEO"},
      {ref:"Andrea",qty:"7",tiktok:"4 nativos",ig:"2 reels + 1 resubida",yt:"â€”",intencion:"Lifestyle + Conexion"},
      {ref:"Post Personal",qty:"2",tiktok:"â€”",ig:"1 carrusel + 1 estatico",yt:"â€”",intencion:"Educacion + Guardados"},
      {ref:"Stories",qty:"5-7",tiktok:"â€”",ig:"5-7 stories diarias",yt:"â€”",intencion:"Cercania + Dia a dia"},
    ],
    total:{qty:"40+",tiktok:"~16",ig:"~18-20",yt:"~4"},
  },
  runclub: {
    sub:"Parrilla por definir",
    rows:[
      {ref:"Comunidad",qty:"â€”",tiktok:"â€”",ig:"â€”",yt:"â€”",intencion:"Comunidad + Engagement"},
      {ref:"Entrenos",qty:"â€”",tiktok:"â€”",ig:"â€”",yt:"â€”",intencion:"Educacion + Valor"},
      {ref:"Eventos",qty:"â€”",tiktok:"â€”",ig:"â€”",yt:"â€”",intencion:"Difusion + Captacion"},
    ],
    total:{qty:"Por definir",tiktok:"â€”",ig:"â€”",yt:"â€”"},
  },
  runnerpro: {
    sub:"Parrilla por definir",
    rows:[
      {ref:"Educacion",qty:"â€”",tiktok:"â€”",ig:"â€”",yt:"â€”",intencion:"Educacion + SEO"},
      {ref:"Producto",qty:"â€”",tiktok:"â€”",ig:"â€”",yt:"â€”",intencion:"Conversion + Features"},
      {ref:"Comunidad",qty:"â€”",tiktok:"â€”",ig:"â€”",yt:"â€”",intencion:"Community + Engagement"},
    ],
    total:{qty:"Por definir",tiktok:"â€”",ig:"â€”",yt:"â€”"},
  },
};

function openParrilla() {
  const p = brandParrillas[currentBrand];
  const bl = brandConfig[currentBrand].label;
  const rowsHTML = p.rows.map(r => `<tr><td style="font-weight:600">${r.ref}</td><td style="text-align:center;font-weight:600">${r.qty}</td><td style="text-align:center${r.tiktok==='â€”'?';color:#555':''}">${r.tiktok}</td><td style="text-align:center${r.ig==='â€”'?';color:#555':''}">${r.ig}</td><td style="text-align:center${r.yt==='â€”'?';color:#555':''}">${r.yt}</td><td>${r.intencion}</td></tr>`).join('');
  document.getElementById('popup-content').innerHTML = `
    <div class="popup-header" style="background:#2a2a2a"><div><div class="popup-header-title">Parrilla â€” ${bl}</div><div class="popup-header-sub">${p.sub}</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div>
    <div class="popup-body" style="overflow-x:auto"><table class="parrilla-table"><tr><th>Referente</th><th style="text-align:center">Qty/Sem</th><th style="text-align:center">TikTok</th><th style="text-align:center">Instagram</th><th style="text-align:center">YouTube</th><th>Intencion</th></tr>${rowsHTML}<tr class="parrilla-total"><td>TOTAL</td><td style="text-align:center">${p.total.qty}</td><td style="text-align:center">${p.total.tiktok}</td><td style="text-align:center">${p.total.ig}</td><td style="text-align:center">${p.total.yt}</td><td></td></tr></table></div>`;
  document.getElementById('overlay').classList.add('active');
}

// â”€â”€ Nueva Idea â”€â”€
const CALENDARIO_DB = '13da67fd-29b2-801f-bac3-c72d4fb45bf2';
function getNotionKey() {
  let key = localStorage.getItem('notion_key');
  if (!key) { key = prompt('Introduce tu Notion API Key (se guarda en tu navegador):'); if (key) localStorage.setItem('notion_key', key); }
  return key;
}

function tagHTML(group, values, color, bg, multi, preselected) {
  return values.map(v => {
    const sel = preselected && preselected.includes(v) ? ' selected' : '';
    return `<span class="tag-pill${sel}" data-group="${group}" data-value="${v}" data-multi="${multi}" style="--tag-color:${color};--tag-bg:${bg}" onclick="toggleTag(this)">${v}</span>`;
  }).join('');
}
function toggleTag(el) {
  const multi = el.dataset.multi === 'true';
  if (multi) { el.classList.toggle('selected'); }
  else { document.querySelectorAll(`.tag-pill[data-group="${el.dataset.group}"]`).forEach(t=>t.classList.remove('selected')); el.classList.add('selected'); }
}
function getTagValues(group) { return Array.from(document.querySelectorAll(`.tag-pill[data-group="${group}"].selected`)).map(t=>t.dataset.value); }

function openNuevaIdea() {
  const bc = brandConfig[currentBrand];
  const pilares = ['ğŸƒğŸ» EducaciÃ³n','â¤ï¸â€ğŸ”¥ Community','ğŸ“±âš¡ Producto','âš¡branding','trendyyy','Mario Mola','ğŸ—“ï¸ Lifestyle (Sport+Work)','ğŸŸï¸ Comunidad','ğŸ“£ Educar','ğŸŸ  WHY','â¤ï¸â€ğŸ”¥ Inspiracion','ğŸ“¹ VLOG','ğŸ¬ Andrea','âš¡ BeltrÃ¡n','ğŸ“ Script','ğŸ¯ VÃ­ctor Heras','ğŸ Veneno','ğŸ“¸ Post Personal','ğŸ“– Stories','â¤ï¸ğŸ”¥ Community'];
  const perfiles = ['cristobal running','RunnerPro','cristobal redondo','Runclub','Meta ADS','Mono Blanco','Raul IA','Lucia IA'];
  const redes = ['Instagram','TikTok','YouTube','LinkedIn','X','Threads','CristÃ³bal','Podcast','Strava','Stories','Meta ADS'];
  const tipos = ['Guion','Script','VÃ­deo','Historia','Carrusel','LinkedIn Post','Texto','Cortos'];

  document.getElementById('popup-content').innerHTML = `
    <div class="popup-header" style="background:#2a2a2a"><div><div class="popup-header-title">Nueva idea â€” ${bc.label}</div><div class="popup-header-sub">Crea una entrada en el Calendario Social Media de Notion</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div>
    <div class="popup-body">
      <div class="idea-form-field" style="margin-bottom:14px"><label>Nombre / Idea del video</label><input type="text" id="idea-nombre" placeholder="ej: Tutorial plan de entreno 10K para principiantes" style="font-size:14px;padding:10px 12px"></div>
      <div class="idea-form-field" style="margin-bottom:14px"><label>Pilar de contenido</label><div class="tag-group">${tagHTML('pilar',pilares,'#bb86fc','#bb86fc18',false,[bc.defaultPilar])}</div></div>
      <div class="idea-form-field" style="margin-bottom:14px"><label>Perfil</label><div class="tag-group">${tagHTML('perfil',perfiles,'#f39c12','#f39c1218',false,[bc.profile])}</div></div>
      <div class="idea-form-field" style="margin-bottom:14px"><label>Red Social</label><div class="tag-group">${tagHTML('red',redes,'#5dade2','#5dade218',true,bc.defaultRedes)}</div></div>
      <div class="idea-form-field" style="margin-bottom:14px"><label>Tipo de contenido</label><div class="tag-group">${tagHTML('tipo',tipos,'#e74c3c','#e74c3c18',true,['VÃ­deo'])}</div></div>
      <div class="idea-form-row"><div class="idea-form-field"><label>Fecha publicacion</label><input type="date" id="idea-fecha"></div></div>
      <div class="context-extras"><label>Comentarios extra <span style="font-weight:400;text-transform:none;color:#444">(no se sube a Notion)</span></label><textarea id="idea-contexto" placeholder="Apuntes, referencias, tono deseado..."></textarea><div class="hint">Solo notas internas, no crea campo en Notion.</div></div>
      <button class="idea-submit-btn" id="idea-submit-btn" onclick="submitIdea()">Crear en Notion</button>
      <div class="idea-result" id="idea-result"></div>
    </div>`;
  document.getElementById('overlay').classList.add('active');
}

async function submitIdea() {
  const btn = document.getElementById('idea-submit-btn');
  const result = document.getElementById('idea-result');
  const nombre = document.getElementById('idea-nombre').value.trim();
  if (!nombre) { result.className='idea-result show error'; result.textContent='Pon un nombre o idea para el video'; return; }
  const pilarArr = getTagValues('pilar'), perfilArr = getTagValues('perfil'), redes = getTagValues('red'), tipos = getTagValues('tipo');
  const fecha = document.getElementById('idea-fecha').value;
  if (!pilarArr.length) { result.className='idea-result show error'; result.textContent='Selecciona un pilar de contenido'; return; }
  if (!perfilArr.length) { result.className='idea-result show error'; result.textContent='Selecciona un perfil'; return; }
  btn.disabled = true; btn.textContent = 'Creando en Notion...'; result.className='idea-result';
  const props = {
    "Nombre":{title:[{text:{content:nombre}}]},
    "âš«Perfil (vacÃ­o = RunnerPro)":{multi_select:perfilArr.map(n=>({name:n}))},
    "âš«Red Social":{multi_select:redes.map(n=>({name:n}))},
    "ğŸŸ£Tipo de contenido":{multi_select:tipos.map(n=>({name:n}))},
    "ğŸŸ£Pilar de contenido":{select:{name:pilarArr[0]}},
    "âš«Estado":{status:{name:"Idea"}},
  };
  if (fecha) props["âš«PublicaciÃ³n"] = {date:{start:fecha}};
  try {
    const res = await fetch('https://api.notion.com/v1/pages',{method:'POST',headers:{'Authorization':'Bearer '+getNotionKey(),'Notion-Version':'2022-06-28','Content-Type':'application/json'},body:JSON.stringify({parent:{database_id:CALENDARIO_DB},properties:props})});
    const data = await res.json();
    if (res.ok) {
      btn.className='idea-submit-btn success'; btn.textContent='Creado en Notion!';
      result.className='idea-result show success';
      result.innerHTML = '<strong>'+nombre+'</strong> â€” <a href="'+data.url+'" target="_blank" style="color:#27ae60;text-decoration:underline">Abrir en Notion</a>';
      setTimeout(()=>{btn.className='idea-submit-btn';btn.textContent='Crear en Notion';btn.disabled=false;},4000);
    } else { throw new Error(data.message||'Error de Notion'); }
  } catch(err) {
    btn.className='idea-submit-btn error'; btn.textContent='Error';
    result.className='idea-result show error'; result.textContent=err.message;
    setTimeout(()=>{btn.className='idea-submit-btn';btn.textContent='Crear en Notion';btn.disabled=false;},3000);
  }
}

// Escape to close
document.addEventListener('keydown', e => { if (e.key==='Escape') closePopup(); });
// Close dropdown on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.brand-dropdown')) {
    document.getElementById('brand-list').classList.remove('open');
    document.querySelector('.brand-dropdown-btn').classList.remove('open');
  }
});

// Auto-reconnect
(async function reconnectActive() {
  try {
    const res = await fetch('/api/cadena/active'); const data = await res.json();
    if (!data.runId) return;
    const endpoint = data.process; openPopup(endpoint);
    await new Promise(r=>setTimeout(r,100));
    const btn=document.getElementById('btn-'+endpoint), logDiv=document.getElementById('log-'+endpoint), cancelBtn=document.getElementById('cancel-'+endpoint);
    const label=endpoint.replace(/-/g,' ').toUpperCase();
    if (!btn||!logDiv) return;
    logDiv.innerHTML=''; logDiv.classList.add('active');
    if (data.status==='running') {
      btn.className='execute-btn loading'; btn.textContent='Ejecutando...';
      if(cancelBtn) cancelBtn.classList.add('active');
      currentRunId=data.runId;
      addLogLine(logDiv,'Reconectado al proceso en curso...','success');
      if(currentEventSource) currentEventSource.close();
      currentEventSource=new EventSource('/api/pipeline/stream/'+data.runId);
      currentEventSource.onmessage=(event)=>{const msg=JSON.parse(event.data);if(msg.type==='log'){addLogLine(logDiv,msg.text,msg.text.includes('âŒ')?'error':msg.text.includes('âœ…')?'success':'');}else if(msg.type==='done'){currentEventSource.close();currentEventSource=null;currentRunId=null;if(cancelBtn)cancelBtn.classList.remove('active');if(msg.status==='completed'){btn.className='execute-btn success';btn.textContent='Completado';addLogLine(logDiv,'PROCESO COMPLETADO','success');}else{btn.className='execute-btn error';btn.textContent='Error (exit '+msg.exitCode+')';addLogLine(logDiv,'PROCESO FALLIDO','error');}setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},5000);}};
      currentEventSource.onerror=()=>{currentEventSource.close();currentEventSource=null;if(cancelBtn)cancelBtn.classList.remove('active');btn.className='execute-btn error';btn.textContent='Conexion perdida';setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},3000);};
    } else {
      (data.output||[]).forEach(line=>{addLogLine(logDiv,line,line.includes('âŒ')?'error':line.includes('âœ…')?'success':'');});
      if(data.exitCode===0||data.status==='completed'){btn.className='execute-btn success';btn.textContent='Completado';addLogLine(logDiv,'PROCESO COMPLETADO','success');}
      else{btn.className='execute-btn error';btn.textContent='Error (exit '+(data.exitCode||'?')+')';addLogLine(logDiv,'PROCESO FALLIDO','error');}
      setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},5000);
    }
  } catch(e){}
})();
</script></body></html>
