<!DOCTYPE html><html lang="es"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadena de Montaje â€” CEO Media</title>
<style>    * { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
background: #0f1419;
min-height: 100vh;
padding: 60px 20px 24px;
color: #e8e8e8;
overflow-x: auto;
display: flex;
flex-direction: column;
align-items: center;
}
.header { margin-bottom: 24px; text-align: center; }
.header h1 { font-size: 22px; font-weight: 800; color: #fff; margin-bottom: 8px; }
.legend { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: 6px; }
.legend-dot { width: 10px; height: 10px; border-radius: 3px; }
.legend-label { font-size: 11px; color: #888; }
.parrilla-btn {
  display: inline-flex; align-items: center; gap: 8px;
  margin-top: 14px; padding: 10px 24px;
  background: linear-gradient(135deg, #1a0f2e, #2d1b4e);
  border: 2px solid #bb86fc; border-radius: 10px;
  color: #bb86fc; font-size: 13px; font-weight: 800;
  cursor: pointer; transition: all 0.3s; letter-spacing: 0.5px;
}
.parrilla-btn:hover {
  background: linear-gradient(135deg, #bb86fc, #9c5ce0);
  color: #fff; transform: scale(1.03);
  box-shadow: 0 0 20px #bb86fc44;
}
.parrilla-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 12px; }
.parrilla-table th {
  padding: 10px 12px; text-align: left; color: #bb86fc;
  font-weight: 800; font-size: 10px; text-transform: uppercase;
  letter-spacing: 0.5px; border-bottom: 2px solid #bb86fc44;
  background: #1a0f2e;
}
.parrilla-table td {
  padding: 10px 12px; border-bottom: 1px solid #222; color: #ccc; font-size: 12px;
}
.parrilla-table tr:hover { background: #bb86fc0a; }
.parrilla-table .red-badge {
  display: inline-block; padding: 2px 8px; border-radius: 6px;
  font-size: 10px; font-weight: 700; margin: 1px 2px;
}
.parrilla-total { font-weight: 800; color: #bb86fc; background: #1a0f2e; }
.parrilla-section-title {
  font-size: 14px; font-weight: 800; color: #fff; margin-bottom: 4px;
  padding: 12px 0 8px; border-bottom: 1px solid #333;
}
.chain { display: flex; gap: 0; align-items: flex-start; min-width: fit-content; overflow-x: auto; padding-bottom: 20px; transform: scale(1.1); transform-origin: top center; margin-top: 10px; }
.phase-group { display: flex; align-items: stretch; }
.phase {
min-width: 190px; max-width: 210px; min-height: 200px;
background: #111518; border-radius: 14px;
overflow: visible; display: flex; flex-direction: column;
}
.phase.construction { min-width: 140px; max-width: 160px; }
.phase-header {
padding: 8px 12px; text-align: center;
border-bottom-width: 2px; border-bottom-style: solid;
}
.phase-emoji { font-size: 16px; }
.phase-title { font-size: 12px; font-weight: 800; color: #fff; letter-spacing: 0.5px; }
.phase-steps { padding: 10px 8px; flex: 1; display: flex; flex-direction: column; gap: 0; }
.construction-placeholder {
flex: 1; display: flex; flex-direction: column;
align-items: center; justify-content: center; gap: 6px; opacity: 0.4;
}
.construction-placeholder span:first-child { font-size: 24px; }
.construction-placeholder span:last-child {
font-size: 10px; font-weight: 700; color: #666;
text-transform: uppercase; letter-spacing: 1px;
}
.step {
border-radius: 8px; padding: 7px 10px;
position: relative; transition: all 0.2s; cursor: pointer;
border-width: 2px; border-style: solid;
}
.step:hover { transform: scale(1.03); }
.step-badge {
position: absolute; top: -7px; right: 6px;
color: #fff; font-size: 8px; font-weight: 900;
letter-spacing: 0.5px; padding: 1px 6px; border-radius: 8px;
}
.step-name { font-size: 11px; font-weight: 700; color: #fff; line-height: 1.3; margin-top: 2px; }
.step-owner { font-size: 9px; color: #aaa; margin-top: 3px; opacity: 0.8; }
.step-connector { display: flex; justify-content: center; padding: 4px 0; }
.step-connector-line { width: 2px; height: 16px; }
.chain-connector { display: flex; align-items: center; padding: 0 2px; align-self: center; }
/* Overlay */    .overlay {
position: fixed; top: 0; left: 0; right: 0; bottom: 0;
background: rgba(0,0,0,0.75); z-index: 1000;
display: none; align-items: center; justify-content: center; padding: 20px;
}
.overlay.active { display: flex; }
.popup {
background: #1a1f25; border-radius: 16px;
max-width: 860px; width: 100%; max-height: 90vh; overflow-y: auto;
}
.popup-header {
padding: 16px 24px; border-radius: 16px 16px 0 0;
display: flex; justify-content: space-between; align-items: center;
}
.popup-header-title { font-size: 16px; font-weight: 800; color: #fff; }
.popup-header-sub { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 2px; }
.popup-close {
cursor: pointer; color: #fff; font-size: 20px;
font-weight: 700; opacity: 0.7; padding: 0 4px;
background: none; border: none;
}
.popup-body { padding: 20px; }
.section-label { font-size: 11px; font-weight: 800; margin-bottom: 8px; letter-spacing: 1px; }
.section-block { margin-bottom: 16px; }
.section-item {
border-radius: 8px; padding: 8px 12px;
display: flex; align-items: flex-start; gap: 8px; margin-bottom: 6px;
}
.section-item-emoji { font-size: 14px; }
.section-item-text { font-size: 12px; color: #ccc; line-height: 1.5; }
.section-item-text a { color: #bb86fc; font-size: 11px; text-decoration: underline; font-weight: 600; }
/* Execute button base */    .execute-btn {
display: flex; align-items: center; justify-content: center; gap: 10px;
width: 100%; padding: 14px 24px; margin-top: 8px;
border: 2px solid #bb86fc; border-radius: 12px;
background: linear-gradient(135deg, #1a0f2e, #2d1b4e);
color: #bb86fc; font-size: 14px; font-weight: 800;
cursor: pointer; transition: all 0.3s; letter-spacing: 0.5px;
}
.execute-btn:hover {
background: linear-gradient(135deg, #bb86fc, #9c5ce0);
color: #fff; transform: scale(1.02);
box-shadow: 0 0 20px #bb86fc44;
}
.execute-btn:active { transform: scale(0.98); }
.execute-btn.loading {
pointer-events: none; opacity: 0.7;
border-color: #f39c12; color: #f39c12;
background: linear-gradient(135deg, #2e1a0a, #4a2e1a);
}
.execute-btn.success {
border-color: #27ae60; color: #fff;
background: linear-gradient(135deg, #27ae60, #2ecc71);
}
.execute-btn.error {
border-color: #e74c3c; color: #e74c3c;
background: linear-gradient(135deg, #2e0a0a, #4a1a1a);
}
/* Table */    .grid-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.grid-table th {
padding: 8px 10px; text-align: left; color: #888;
font-weight: 700; font-size: 10px; text-transform: uppercase;
letter-spacing: 0.5px; border-bottom: 2px solid #333;
}
.grid-table td { padding: 10px; }
.grid-table tr { border-bottom: 1px solid #222; }
.grid-table tr:nth-child(even) { background: #0f141933; }
.badge {
display: inline-block; padding: 2px 8px;
border-radius: 6px; font-size: 11px; font-weight: 600;
}
.stat-cards { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
.stat-card { border-radius: 8px; padding: 8px 12px; flex: 1 1 140px; }
.stat-card-label { font-size: 10px; color: #888; font-weight: 600; }
.stat-card-value { font-size: 16px; font-weight: 800; margin-top: 2px; }
.stat-card-note { font-size: 9px; color: #666; margin-top: 2px; }
/* Week selector */
.week-selector { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 10px 14px; background: #bb86fc12; border: 1px solid #bb86fc33; border-radius: 10px; }
.week-selector label { font-size: 11px; font-weight: 700; color: #bb86fc; text-transform: uppercase; letter-spacing: 0.5px; }
.week-selector input[type="date"] {
  background: #1a1f25; color: #e8e8e8; border: 1px solid #bb86fc44; border-radius: 6px;
  padding: 6px 10px; font-size: 13px; font-family: inherit;
}
.week-selector input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
/* Log terminal */
.log-terminal {
  background: #0a0e12; border: 1px solid #bb86fc33; border-radius: 10px;
  max-height: 350px; overflow-y: auto; padding: 12px; margin-top: 8px;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 11px;
  line-height: 1.6; color: #a0a0a0; display: none;
}
.log-terminal.active { display: block; }
.log-line { white-space: pre-wrap; word-break: break-all; }
.log-line.error { color: #e74c3c; }
.log-line.success { color: #27ae60; }
.cancel-btn {
  display: none; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 10px; margin-top: 6px;
  border: 1px solid #e74c3c55; border-radius: 8px;
  background: #2e0a0a; color: #e74c3c; font-size: 12px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.cancel-btn.active { display: flex; }
.cancel-btn:hover { background: #e74c3c; color: #fff; }
/* Context box */
.context-box { margin-bottom: 8px; padding: 10px 14px; background: #bb86fc08; border: 1px solid #bb86fc22; border-radius: 10px; }
.context-box label { display: block; font-size: 11px; font-weight: 700; color: #bb86fc; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.context-box textarea {
  width: 100%; min-height: 60px; background: #1a1f25; color: #e8e8e8; border: 1px solid #bb86fc44; border-radius: 6px;
  padding: 8px 10px; font-size: 12px; font-family: inherit; resize: vertical; line-height: 1.5;
}
.context-box textarea::placeholder { color: #555; font-style: italic; }
.context-box .context-hint { font-size: 10px; color: #666; margin-top: 4px; }
/* Nueva idea form */
.idea-form-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
.idea-form-field { flex: 1; min-width: 180px; }
.idea-form-field label { display: block; font-size: 10px; font-weight: 700; color: #bb86fc; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.idea-form-field input, .idea-form-field select, .idea-form-field textarea {
  width: 100%; background: #1a1f25; color: #e8e8e8; border: 1px solid #bb86fc44; border-radius: 6px;
  padding: 8px 10px; font-size: 12px; font-family: inherit;
}
.idea-form-field textarea { min-height: 60px; resize: vertical; }
.idea-form-field select { cursor: pointer; }
.idea-form-field input::placeholder, .idea-form-field textarea::placeholder { color: #555; font-style: italic; }
.idea-submit-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 12px; margin-top: 8px;
  border: 2px solid #27ae60; border-radius: 10px;
  background: linear-gradient(135deg, #0a2e1a, #1a4a2e);
  color: #27ae60; font-size: 13px; font-weight: 800;
  cursor: pointer; transition: all 0.3s;
}
.idea-submit-btn:hover { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; transform: scale(1.02); }
.idea-submit-btn:disabled { opacity: 0.5; pointer-events: none; }
.idea-submit-btn.success { border-color: #27ae60; background: #27ae60; color: #fff; }
.idea-submit-btn.error { border-color: #e74c3c; color: #e74c3c; background: linear-gradient(135deg, #2e0a0a, #4a1a1a); }
.idea-result { margin-top: 8px; padding: 10px; border-radius: 8px; font-size: 12px; display: none; }
.idea-result.show { display: block; }
.idea-result.success { background: #27ae6022; border: 1px solid #27ae6044; color: #27ae60; }
.idea-result.error { background: #e74c3c22; border: 1px solid #e74c3c44; color: #e74c3c; }
</style></head><body>
<div class="header">
<h1>â›“ï¸ CADENA DE MONTAJE â€” CEO MEDIA</h1>
<div class="legend">
<div class="legend-item">
<div class="legend-dot" style="background:#27ae60;border:1px solid #1e8449"></div>
<span class="legend-label">ğŸ¥ Drum (IA)</span>
</div>
<div class="legend-item">
<div class="legend-dot" style="background:#2980b9;border:1px solid #2471a3"></div>
<span class="legend-label">ğŸ“¦ Buffer (Revision)</span>
</div>
<div class="legend-item">
<div class="legend-dot" style="background:#8e44ad;border:1px solid #7d3c98"></div>
<span class="legend-label">ğŸŸ£ Reunion</span>
</div>
<div class="legend-item">
<div class="legend-dot" style="background:#555;border:1px solid #444"></div>
<span class="legend-label">ğŸš§ En construccion</span>
</div>
</div>
<button class="parrilla-btn" onclick="openParrilla()">ğŸ“… VER PARRILLA DE CONTENIDO</button>
<button class="parrilla-btn" onclick="openNuevaIdea()" style="border-color:#27ae60;color:#27ae60;margin-left:8px">â• NUEVA IDEA DE VIDEO</button>
</div>
<div class="chain" id="chain"></div>
<!-- Overlay for popups -->
<div class="overlay" id="overlay" onclick="closePopup()">
<div class="popup" id="popup-content" onclick="event.stopPropagation()"></div>
</div>  <script>    // Data
const phases = [      {
id: "idea", emoji: "ğŸ’¡", title: "IDEA", color: "#1B4F72",
steps: [
  { name: "Crea Idea", type: "drum", popupId: "crea-idea", owner: "ğŸ‘© Lucia Â· ğŸ¤– Runni" },
  { name: "Revisa Ideas", type: "buffer", popupId: "lucia-revisa", owner: "ğŸ‘© Lucia" },
  { name: "Reu Validacion Ideas", type: "reu", popupId: "reu-validacion", owner: "ğŸ‘© Lucia Â· ğŸ‘©â€ğŸ’¼ Carmen Â· ğŸ‘¨ Cristobal" },
  { name: "Aplica Cambios", type: "buffer", popupId: "lucia-aplica", owner: "ğŸ‘© Lucia" },
]
},
{
id: "creation", emoji: "âœï¸", title: "CREACION GUION", color: "#7D3C98",
steps: [
  { name: "Guion IA", type: "drum", popupId: "guion-ia", owner: "ğŸ‘© Lucia Â· ğŸ¤– Runni" },
  { name: "Revisa Guiones", type: "buffer", popupId: "lucia-revisa-guiones", owner: "ğŸ‘© Lucia" },
  { name: "Reu Validacion Guiones", type: "reu", popupId: "reu-validacion-guiones", owner: "ğŸ‘© Lucia Â· ğŸ‘©â€ğŸ’¼ Carmen" },
  { name: "Aplica Cambios", type: "buffer", popupId: "lucia-aplica-guiones", owner: "ğŸ‘© Lucia" },
]
},
{
id: "traction", emoji: "ğŸ¬", title: "CREACION VISUAL", color: "#D35400",
steps: [
  { name: "Visual IA", type: "drum", popupId: "visual-ia", owner: "ğŸ‘© Lucia Â· ğŸ¤– Runni" },
  { name: "Revisa Visuales", type: "buffer", popupId: "revisa-visuales", owner: "ğŸ‘© Lucia" },
  { name: "Reu Validacion Visuales", type: "reu", popupId: "reu-validacion-visuales", owner: "ğŸ‘© Lucia Â· ğŸ‘©â€ğŸ’¼ Carmen" },
  { name: "Aplica Cambios", type: "buffer", popupId: "aplica-visuales", owner: "ğŸ‘© Lucia" },
]
},
{ id: "recording", emoji: "ğŸ“·", title: "GRABACION", color: "#1E8449", construction: true, steps: [] },
{ id: "editing", emoji: "âœ‚ï¸", title: "EDICION", color: "#8E44AD", construction: true, steps: [] },
{ id: "publishing", emoji: "ğŸš€", title: "PUBLICACION", color: "#2C3E50", construction: true, steps: [] },
];
const typeStyles = {
drum:   { bg: "#0a2e1a", border: "#27ae60", accent: "#27ae60", icon: "ğŸ¥", label: "DRUM" },
buffer: { bg: "#0f1f2e", border: "#2980b9", accent: "#2980b9", icon: "ğŸ“¦", label: "BUFFER" },
reu:    { bg: "#1a0f2e", border: "#8e44ad", accent: "#8e44ad", icon: "ğŸŸ£", label: "REU" },
};
// Render chain
const chain = document.getElementById('chain');
phases.forEach((phase, pi) => {
const group = document.createElement('div');
group.className = 'phase-group';
const phaseDiv = document.createElement('div');
phaseDiv.className = 'phase' + (phase.construction ? ' construction' : '');
phaseDiv.style.border = `2px solid ${phase.color}55`;
// Header
const header = document.createElement('div');
header.className = 'phase-header';
header.style.background = `linear-gradient(135deg, ${phase.color}, ${phase.color}cc)`;
header.style.borderBottomColor = `${phase.color}88`;
header.innerHTML = `<div class="phase-emoji">${phase.emoji}</div><div class="phase-title">${phase.title}</div>`;
phaseDiv.appendChild(header);
// Steps
const stepsDiv = document.createElement('div');
stepsDiv.className = 'phase-steps';
if (phase.construction) {
stepsDiv.innerHTML = '<div class="construction-placeholder"><span>ğŸš§</span><span>Proximamente</span></div>';
} else {
phase.steps.forEach((step, si) => {
const st = typeStyles[step.type];
const stepEl = document.createElement('div');
stepEl.className = 'step';
stepEl.style.background = st.bg;
stepEl.style.borderColor = st.border;
stepEl.style.boxShadow = `0 0 8px ${st.accent}11`;
stepEl.onclick = () => openPopup(step.popupId);
stepEl.onmouseenter = () => {
stepEl.style.borderColor = '#fff';
stepEl.style.boxShadow = `0 0 16px ${st.accent}44`;
stepEl.style.transform = 'scale(1.03)';
};
stepEl.onmouseleave = () => {
stepEl.style.borderColor = st.border;
stepEl.style.boxShadow = `0 0 8px ${st.accent}11`;
stepEl.style.transform = 'scale(1)';
};
stepEl.innerHTML = `<div class="step-badge" style="background:${st.accent}">${st.label}</div><div class="step-name">${st.icon} ${step.name}</div>${step.owner ? `<div class="step-owner">${step.owner}</div>` : ''}`;
stepsDiv.appendChild(stepEl);
if (si < phase.steps.length - 1) {
const conn = document.createElement('div');
conn.className = 'step-connector';
conn.innerHTML = `<div class="step-connector-line" style="background:${st.accent}44"></div>`;
stepsDiv.appendChild(conn);
}
});
}
phaseDiv.appendChild(stepsDiv);
group.appendChild(phaseDiv);
// Chain connector between phases
if (pi < phases.length - 1) {
const nextColor = phases[pi + 1].color;
const connDiv = document.createElement('div');
connDiv.className = 'chain-connector';
connDiv.innerHTML = `          <svg width="36" height="24" viewBox="0 0 36 24">            <defs>              <linearGradient id="chain-${pi}" x1="0%" y1="0%" x2="100%" y2="0%">                <stop offset="0%" stop-color="${phase.color}" stop-opacity="0.7"/>                <stop offset="100%" stop-color="${nextColor}" stop-opacity="0.7"/>              </linearGradient>            </defs>            <rect x="4" y="8" width="20" height="8" rx="4" fill="none" stroke="url(#chain-${pi})" stroke-width="2"/>            <polygon points="26,6 36,12 26,18" fill="${nextColor}" opacity="0.7"/>          </svg>        `;
group.appendChild(connDiv);
}
chain.appendChild(group);
});
// Popup content generators
function sectionHTML(section, color, items) {
return `        <div class="section-block">          <div class="section-label" style="color:${color}">${section}</div>          ${items.map(item => `            <div class="section-item" style="background:${color}12;border:1px solid ${color}33">              <span class="section-item-emoji">${item.emoji}</span>              <span class="section-item-text">${item.text}${item.link ? ` <a href="${item.link}" target="_blank">(Notion Prompt)</a>` : ''}</span>            </div>          `).join('')}
</div>      `;
}
function getNextMonday() {
  const d = new Date();
  const day = d.getDay();
  const diff = day === 0 ? 1 : 8 - day;
  d.setDate(d.getDate() + diff);
  return d.toISOString().split('T')[0];
}
function executeButtonHTML(apiEndpoint, label, showContext) {
  const defaultDate = getNextMonday();
  let contextHTML = '';
  if (showContext) {
    const pilares = ['veneno', 'victor_heras', 'andrea', 'post_personal', 'stories'];
    const pilarLabels = { veneno: 'ğŸ Veneno', victor_heras: 'ğŸ¯ VÃ­ctor Heras', andrea: 'ğŸ¬ Andrea', post_personal: 'ğŸ“¸ Post Personal', stories: 'ğŸ“– Stories' };
    const contextFields = pilares.map(p =>
      `<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:4px">` +
      `<span style="min-width:120px;font-size:11px;font-weight:600;color:#bb86fc;padding-top:6px">${pilarLabels[p]}</span>` +
      `<input type="text" id="ctx-${apiEndpoint}-${p}" placeholder="ej: haz uno sobre lanzamiento premium" ` +
      `style="flex:1;background:#1a1f25;color:#e8e8e8;border:1px solid #bb86fc33;border-radius:6px;padding:6px 8px;font-size:11px;font-family:inherit">` +
      `</div>`
    ).join('');
    contextHTML = `
    <div class="context-box">
      <label>ğŸ’¬ Contexto por pilar <span style="font-weight:400;text-transform:none;color:#666">(opcional)</span></label>
      ${contextFields}
      <div class="context-hint">Deja vacÃ­o para que la IA decida libremente. Si pones varias ideas separadas por coma, se reparten entre los dÃ­as.</div>
    </div>`;
  }
  return `
  <div class="week-selector">
    <label>ğŸ“… Semana del lunes:</label>
    <input type="date" id="semana-${apiEndpoint}" value="${defaultDate}">
  </div>
  ${contextHTML}
  <button class="execute-btn" id="btn-${apiEndpoint}" onclick="executeProcess('${apiEndpoint}', this)">
    ğŸš€ EJECUTAR: ${label}
  </button>
  <button class="cancel-btn" id="cancel-${apiEndpoint}" onclick="cancelProcess('${apiEndpoint}')">
    â›” CANCELAR
  </button>
  <div class="log-terminal" id="log-${apiEndpoint}"></div>
  <div style="height:16px"></div>`;
}
const popups = {
"crea-idea": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)">          <div>            <div class="popup-header-title">âœ… CREA IDEA â€” CEO MEDIA</div>            <div class="popup-header-sub">40+ piezas/semana Â· TikTok 28 nativos Â· Instagram 12 nativos + resubidas top</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ“…", text: "Parrilla Semanal â€” distribucion de formatos, frecuencias y plataformas (ver tabla abajo)" },
{ emoji: "ğŸ™ï¸", text: "Embeddings BBDD Historico â€” videos propios publicados" },
{ emoji: "ğŸ”", text: "Embeddings BBDD Creadores Referentes â€” busqueda semantica en 20K+ escenas" },
{ emoji: "ğŸ“Š", text: "Excel Moneyball por Creador â€” patrones ganadores con % exito" },
{ emoji: "ğŸ¯", text: "Estrategia â€” objetivo de cada tipo de video y posicionamiento de marca" },
])}
${sectionHTML("PROCESO", "#bb86fc", [])}
${executeButtonHTML("crea-idea", "CREA IDEA", true)}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ“", text: "Por cada hueco de la parrilla, la IA genera una primera idea de contenido con hook, semantica, probabilidad de exito y un comentario de por que es ganadora." },
])}
</div>      `,
"lucia-revisa": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#2980b9,#3498db)">          <div>            <div class="popup-header-title">ğŸ‘¤ REVISA IDEAS</div>            <div class="popup-header-sub">Revision previa a la reunion Â· Prepara comentarios y propuestas</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ¤–", text: "Ideas generadas por Runni en el Calendario Social Media de Notion" },
{ emoji: "ğŸ“…", text: "Calendario de la semana con los huecos ya asignados" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "ğŸ‘€", text: "Lucia revisa cada idea generada por la IA" },
{ emoji: "âœï¸", text: "Anade comentarios en Notion sobre cada idea" },
{ emoji: "ğŸ’¡", text: "Apunta ideas propias que se le ocurran al revisar" },
{ emoji: "âš ï¸", text: "Marca las ideas que ve mas flojas" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ“‹", text: "Calendario con comentarios de Lucia â€” listo para la reu de validacion" },
{ emoji: "ğŸ’¡", text: "Lista de ideas propias como alternativas o complementos" },
])}
</div>      `,
"reu-validacion": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)">          <div>            <div class="popup-header-title">ğŸŸ£ REU VALIDACION IDEAS</div>            <div class="popup-header-sub">Maximo 30 minutos Â· Decisiones concretas sobre cada idea</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ¤–", text: "Ideas de Runni ya escritas en el Calendario" },
{ emoji: "âœï¸", text: "Comentarios de Lucia en cada idea" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "ğŸ—£ï¸", text: "Reu de maximo 30 minutos" },
{ emoji: "âœ…", text: "Por cada idea: aprobar, modificar o descartar con razon concreta" },
{ emoji: "ğŸ“", text: "Se apuntan cambios directos y contexto especifico" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ™ï¸", text: "Reunion transcrita automaticamente" },
{ emoji: "ğŸ“‹", text: "Lista de cambios concisos sobre cada idea" },
])}
</div>      `,
"lucia-aplica": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#2980b9,#3498db)">          <div>            <div class="popup-header-title">ğŸ‘¤ APLICA CAMBIOS</div>            <div class="popup-header-sub">Transcripcion de reu â†’ IA aplica â†’ Lucia revisa â†’ activa guiones</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ™ï¸", text: "Transcripcion de la reunion de validacion" },
{ emoji: "ğŸ“…", text: "Calendario Social Media actual" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "ğŸ¤–", text: "Notion Prompt recibe la transcripcion + calendario â†’ aplica cambios" },
{ emoji: "ğŸ‘€", text: "Lucia revisa los cambios aplicados por la IA" },
{ emoji: "âœï¸", text: "Ajustes finales manuales si algo no cuadra" },
{ emoji: "ğŸš€", text: "Activar Notion Prompt para fase CREACION", link: "https://www.notion.so/Guion-IA-CEO-Media-303a67fd29b280188115cd8bd2fb4c87" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ“…", text: "Calendario de la semana cerrado con ideas finales" },
{ emoji: "ğŸ¤–", text: "Runni empieza a rodar â€” genera automaticamente Guion IA" },
{ emoji: "ğŸ”’", text: "Ciclo IDEA cerrado â†’ las ideas pasan a CREACION" },
])}
</div>      `,
"guion-ia": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)">          <div>            <div class="popup-header-title">âœ… GUION IA</div>            <div class="popup-header-sub">6 inputs â†’ Runni genera guion completo en cada pagina de Notion</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ“…", text: "Parrilla Semanal â€” distribucion de formatos, frecuencias y plataformas" },
{ emoji: "ğŸ™ï¸", text: "Embeddings BBDD Historico â€” videos propios publicados" },
{ emoji: "ğŸ”", text: "Embeddings BBDD Creadores Referentes â€” busqueda semantica en 20K+ escenas" },
{ emoji: "ğŸ“Š", text: "Excel Moneyball por Creador â€” patrones ganadores" },
{ emoji: "ğŸ¯", text: "Estrategia â€” objetivo de cada tipo de video" },
{ emoji: "ğŸ’¡", text: "Ideas y Comentarios del Calendario Notion â€” ideas validadas en reu" },
])}
${sectionHTML("PROCESO", "#bb86fc", [])}
${executeButtonHTML("guion-ia", "GUION IA")}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ“", text: "En cada pagina de Notion de cada post: guion completo del video con hook detallado + guion narrativo" },
{ emoji: "ğŸ“‹", text: "Descripcion de la publicacion" },
])}
</div>      `,
"lucia-revisa-guiones": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)">          <div>            <div class="popup-header-title">ğŸ‘¤ REVISA GUIONES</div>            <div class="popup-header-sub">Revision de cada guion generado por Runni</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ“", text: "Guiones de Runni escritos en cada pagina de Notion" },
{ emoji: "ğŸ“…", text: "Calendario semanal con las ideas validadas" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "ğŸ‘ï¸", text: "Lucia lee cada guion y compara con la idea original" },
{ emoji: "ğŸ’¬", text: "Anade comentarios en Notion" },
{ emoji: "âš ï¸", text: "Marca los guiones que necesitan cambios fuertes" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ“‹", text: "Guiones con comentarios listos para la reu de validacion" },
])}
</div>      `,
"reu-validacion-guiones": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)">          <div>            <div class="popup-header-title">ğŸŸ£ REU VALIDACION GUIONES</div>            <div class="popup-header-sub">Maximo 30 minutos Â· Decisiones concretas sobre cada guion</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ“", text: "Guiones generados por Runni con comentarios de revision" },
{ emoji: "ğŸ’¬", text: "Comentarios de Lucia en cada guion" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "ğŸ—£ï¸", text: "Reu de maximo 30 minutos" },
{ emoji: "âœ…", text: "Por cada guion: aprobar, modificar o descartar" },
{ emoji: "ğŸ“", text: "Se apuntan cambios directos" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ™ï¸", text: "Reunion transcrita automaticamente" },
{ emoji: "ğŸ“‹", text: "Lista de cambios concisos sobre cada guion" },
])}
</div>      `,
"lucia-aplica-guiones": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)">          <div>            <div class="popup-header-title">ğŸ‘¤ APLICA CAMBIOS</div>            <div class="popup-header-sub">Aplica los cambios de la reu en los guiones de Notion</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ™ï¸", text: "Transcripcion de la reu de validacion de guiones" },
{ emoji: "ğŸ“", text: "Guiones actuales en Notion" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "ğŸ¤–", text: "Notion Prompt recibe transcripcion + guiones â†’ aplica cambios" },
{ emoji: "ğŸ‘ï¸", text: "Lucia revisa los cambios aplicados" },
{ emoji: "âœï¸", text: "Ajustes manuales si es necesario" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "âœ…", text: "Guiones cerrados y listos para crear Visual IA" },
{ emoji: "ğŸ¤–", text: "Runni empieza a rodar â€” genera automaticamente Visual IA" },
])}
</div>      `,
"visual-ia": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)">          <div>            <div class="popup-header-title">âœ… VISUAL IA</div>            <div class="popup-header-sub">Guion cerrado â†’ embeddings buscan escenas similares â†’ Gemini genera storyboard â†’ PDF</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ“…", text: "Parrilla Semanal" },
{ emoji: "ğŸ™ï¸", text: "Embeddings BBDD Historico" },
{ emoji: "ğŸ”", text: "Embeddings BBDD Creadores Referentes â€” 20K+ escenas" },
{ emoji: "ğŸ“Š", text: "Excel Moneyball por Creador" },
{ emoji: "ğŸ“", text: "Guion de cada video (viene de CREACION GUION)" },
])}
${sectionHTML("PROCESO", "#bb86fc", [])}
${executeButtonHTML("visual-ia", "VISUAL IA")}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ¬", text: "Google Doc con Visual y Storyboard subido a Drive, linkeado en Notion" },
])}
</div>      `,
"revisa-visuales": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)">          <div>            <div class="popup-header-title">ğŸ‘¤ REVISA VISUALES</div>            <div class="popup-header-sub">Revision de cada storyboard visual generado</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ¬", text: "Storyboards visuales PDF generados por Visual IA" },
{ emoji: "ğŸ“", text: "Guiones cerrados de Notion como referencia" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "ğŸ‘ï¸", text: "Revisa cada storyboard y compara con el guion cerrado" },
{ emoji: "ğŸ’¬", text: "Anade comentarios: que ajustar en planos, transiciones, overlays" },
{ emoji: "âš ï¸", text: "Marca los que necesitan cambios fuertes" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ“‹", text: "Storyboards con comentarios listos para la reu" },
])}
</div>      `,
"reu-validacion-visuales": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)">          <div>            <div class="popup-header-title">ğŸŸ£ REU VALIDACION VISUALES</div>            <div class="popup-header-sub">Maximo 30 minutos Â· Decisiones concretas sobre cada storyboard</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ¬", text: "Storyboards visuales con comentarios de la revision" },
{ emoji: "ğŸ’¬", text: "Notas y ajustes propuestos" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "ğŸ—£ï¸", text: "Reu de maximo 30 minutos" },
{ emoji: "âœ…", text: "Por cada visual: aprobar, modificar o descartar" },
{ emoji: "ğŸ“", text: "Se apuntan cambios directos" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "ğŸ™ï¸", text: "Reunion transcrita automaticamente" },
{ emoji: "ğŸ“‹", text: "Lista de cambios concisos sobre cada storyboard" },
])}
</div>      `,
"aplica-visuales": () => `        <div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)">          <div>            <div class="popup-header-title">ğŸ‘¤ APLICA CAMBIOS</div>            <div class="popup-header-sub">Aplica los cambios de la reu en los storyboards</div>          </div>          <button class="popup-close" onclick="closePopup()">âœ•</button>        </div>        <div class="popup-body">          ${sectionHTML("INPUT", "#3498db", [            { emoji: "ğŸ™ï¸", text: "Transcripcion de la reu de validacion visual" },
{ emoji: "ğŸ¬", text: "Storyboards actuales con los comentarios previos" },
])}
${sectionHTML("PROCESO", "#bb86fc", [            { emoji: "âœï¸", text: "Aplica cambios manuales en los storyboards segun la reu" },
{ emoji: "ğŸ‘ï¸", text: "Revision final de coherencia guion â†” visual" },
])}
${sectionHTML("OUTPUT", "#27ae60", [            { emoji: "âœ…", text: "Storyboards cerrados y listos para grabar" },
{ emoji: "ğŸ”’", text: "Ciclo CREACION cerrado â†’ pasan a GRABACION" },
])}
</div>      `,
};
// Popup functions
function openPopup(popupId) {
if (popups[popupId]) {
document.getElementById('popup-content').innerHTML = popups[popupId]();
document.getElementById('overlay').classList.add('active');
}
}
function closePopup() {
document.getElementById('overlay').classList.remove('active');
}
// Execute process with SSE streaming
let currentRunId = null;
let currentEventSource = null;

async function executeProcess(endpoint, btn) {
  const semanaInput = document.getElementById('semana-' + endpoint);
  const semana = semanaInput ? semanaInput.value : null;
  const logDiv = document.getElementById('log-' + endpoint);
  const cancelBtn = document.getElementById('cancel-' + endpoint);
  const label = endpoint.replace(/-/g, ' ').toUpperCase();

  // Collect context per pilar
  const context = {};
  ['veneno', 'victor_heras', 'andrea', 'post_personal', 'stories'].forEach(p => {
    const input = document.getElementById('ctx-' + endpoint + '-' + p);
    if (input && input.value.trim()) context[p] = input.value.trim();
  });

  // Reset UI
  btn.className = 'execute-btn loading';
  btn.innerHTML = 'â³ Ejecutando...';
  logDiv.innerHTML = '';
  logDiv.classList.add('active');
  cancelBtn.classList.add('active');

  try {
    const res = await fetch('/api/cadena/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ process: endpoint, semana, context })
    });
    const data = await res.json();

    if (!res.ok) throw new Error(data.error || 'Error desconocido');

    currentRunId = data.runId;
    addLogLine(logDiv, `â–¶ Proceso: ${endpoint} | Semana: ${semana || 'auto'} | Run: ${data.runId}`, 'success');

    // Open SSE stream
    if (currentEventSource) currentEventSource.close();
    currentEventSource = new EventSource('/api/pipeline/stream/' + data.runId);

    currentEventSource.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === 'log') {
        const cls = msg.text.includes('âŒ') || msg.text.includes('[stderr]') ? 'error' :
                    msg.text.includes('âœ…') ? 'success' : '';
        addLogLine(logDiv, msg.text, cls);
      } else if (msg.type === 'done') {
        currentEventSource.close();
        currentEventSource = null;
        currentRunId = null;
        cancelBtn.classList.remove('active');

        if (msg.status === 'completed') {
          btn.className = 'execute-btn success';
          btn.innerHTML = 'âœ… Completado';
          addLogLine(logDiv, 'â•â•â• PROCESO COMPLETADO â•â•â•', 'success');
        } else {
          btn.className = 'execute-btn error';
          btn.innerHTML = 'âŒ Error (exit ' + msg.exitCode + ')';
          addLogLine(logDiv, 'â•â•â• PROCESO FALLIDO (exit ' + msg.exitCode + ') â•â•â•', 'error');
        }
        setTimeout(() => { btn.className = 'execute-btn'; btn.innerHTML = 'ğŸš€ EJECUTAR: ' + label; }, 5000);
      }
    };

    currentEventSource.onerror = () => {
      currentEventSource.close();
      currentEventSource = null;
      cancelBtn.classList.remove('active');
      btn.className = 'execute-btn error';
      btn.innerHTML = 'âŒ ConexiÃ³n perdida';
      addLogLine(logDiv, 'â•â•â• CONEXIÃ“N PERDIDA â•â•â•', 'error');
      setTimeout(() => { btn.className = 'execute-btn'; btn.innerHTML = 'ğŸš€ EJECUTAR: ' + label; }, 3000);
    };

  } catch (err) {
    btn.className = 'execute-btn error';
    btn.innerHTML = 'âŒ ' + err.message;
    cancelBtn.classList.remove('active');
    addLogLine(logDiv, 'âŒ ' + err.message, 'error');
    setTimeout(() => { btn.className = 'execute-btn'; btn.innerHTML = 'ğŸš€ EJECUTAR: ' + label; }, 3000);
  }
}

function addLogLine(logDiv, text, cls) {
  const line = document.createElement('div');
  line.className = 'log-line' + (cls ? ' ' + cls : '');
  line.textContent = text;
  logDiv.appendChild(line);
  logDiv.scrollTop = logDiv.scrollHeight;
}

async function cancelProcess(endpoint) {
  if (!currentRunId) return;
  try {
    await fetch('/api/pipeline/cancel/' + currentRunId, { method: 'POST' });
    const logDiv = document.getElementById('log-' + endpoint);
    addLogLine(logDiv, 'â›” Cancelado por el usuario', 'error');
  } catch (e) {}
}

// Parrilla de contenido
function openParrilla() {
  const tiktok = '<span class="red-badge" style="background:#00f2ea22;color:#00f2ea">';
  const ig = '<span class="red-badge" style="background:#E1306C22;color:#E1306C">';
  const yt = '<span class="red-badge" style="background:#FF000022;color:#FF4444">';
  const end = '</span>';
  const html = `
    <div class="popup-header" style="background:linear-gradient(90deg,#6c3483,#bb86fc)">
      <div>
        <div class="popup-header-title">ğŸ“… PARRILLA SEMANAL DE CONTENIDO â€” CEO MEDIA</div>
        <div class="popup-header-sub">40+ piezas/semana Â· Distribucion por referente, red social e intencion</div>
      </div>
      <button class="popup-close" onclick="closePopup()">âœ•</button>
    </div>
    <div class="popup-body" style="overflow-x:auto">

      <table class="parrilla-table">
        <tr>
          <th>Referente</th>
          <th style="text-align:center">Qty/Sem</th>
          <th style="text-align:center">${tiktok}TikTok${end}</th>
          <th style="text-align:center">${ig}Instagram${end}</th>
          <th style="text-align:center">${yt}YouTube${end}</th>
          <th>Intencion</th>
        </tr>
        <tr>
          <td style="font-weight:700">ğŸ Veneno</td>
          <td style="text-align:center;font-weight:700">15</td>
          <td style="text-align:center">7 nativos</td>
          <td style="text-align:center">5 reels + 3 resubidas</td>
          <td style="text-align:center;color:#555">â€”</td>
          <td>ğŸ¯ Alcance + Viralizacion + Entretenimiento</td>
        </tr>
        <tr>
          <td style="font-weight:700">ğŸ¯ Victor Heras</td>
          <td style="text-align:center;font-weight:700">14</td>
          <td style="text-align:center">5 nativos</td>
          <td style="text-align:center">3 reels + 2 resubidas</td>
          <td style="text-align:center">3 shorts + 1 long</td>
          <td>ğŸ§  Autoridad + Educacion + SEO</td>
        </tr>
        <tr>
          <td style="font-weight:700">ğŸ¬ Andrea</td>
          <td style="text-align:center;font-weight:700">7</td>
          <td style="text-align:center">4 nativos</td>
          <td style="text-align:center">2 reels + 1 resubida</td>
          <td style="text-align:center;color:#555">â€”</td>
          <td>ğŸ’œ Lifestyle + Conexion + Comunidad</td>
        </tr>
        <tr>
          <td style="font-weight:700">ğŸ“¸ Post Personal</td>
          <td style="text-align:center;font-weight:700">2</td>
          <td style="text-align:center;color:#555">â€”</td>
          <td style="text-align:center">1 carrusel + 1 estatico</td>
          <td style="text-align:center;color:#555">â€”</td>
          <td>ğŸ“š Educacion + Guardados + Engagement</td>
        </tr>
        <tr>
          <td style="font-weight:700">ğŸ“– Stories</td>
          <td style="text-align:center;font-weight:700">5-7</td>
          <td style="text-align:center;color:#555">â€”</td>
          <td style="text-align:center">5-7 stories diarias</td>
          <td style="text-align:center;color:#555">â€”</td>
          <td>ğŸ¤ Cercania + Dia a dia</td>
        </tr>
        <tr class="parrilla-total">
          <td>TOTAL</td>
          <td style="text-align:center">40+</td>
          <td style="text-align:center">~16</td>
          <td style="text-align:center">~18-20</td>
          <td style="text-align:center">~4</td>
          <td></td>
        </tr>
      </table>

      <div style="margin-top:20px;padding:16px;background:#bb86fc12;border:2px solid #bb86fc44;border-radius:12px;text-align:center">
        <div style="font-size:11px;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:1px">Total semanal</div>
        <div style="font-size:28px;font-weight:900;color:#bb86fc;margin-top:4px">40+ piezas</div>
        <div style="display:flex;gap:12px;justify-content:center;margin-top:10px;flex-wrap:wrap">
          <span class="red-badge" style="background:#00f2ea22;color:#00f2ea;padding:4px 12px;font-size:12px">TikTok ~16</span>
          <span class="red-badge" style="background:#E1306C22;color:#E1306C;padding:4px 12px;font-size:12px">Instagram ~18-20</span>
          <span class="red-badge" style="background:#FF000022;color:#FF4444;padding:4px 12px;font-size:12px">YouTube ~4</span>
        </div>
      </div>

    </div>
  `;
  document.getElementById('popup-content').innerHTML = html;
  document.getElementById('overlay').classList.add('active');
}

// Nueva Idea de Video
// Notion config - token se guarda en localStorage para no exponer en el repo
const CALENDARIO_DB = '13da67fd-29b2-801f-bac3-c72d4fb45bf2';
function getNotionKey() {
  let key = localStorage.getItem('notion_key');
  if (!key) {
    key = prompt('ğŸ”‘ Introduce tu Notion API Key (se guarda en tu navegador):');
    if (key) localStorage.setItem('notion_key', key);
  }
  return key;
}

function openNuevaIdea() {
  const html = `
    <div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)">
      <div>
        <div class="popup-header-title">â• NUEVA IDEA DE VIDEO</div>
        <div class="popup-header-sub">Crea una entrada directamente en el Calendario Social Media de Notion</div>
      </div>
      <button class="popup-close" onclick="closePopup()">âœ•</button>
    </div>
    <div class="popup-body">
      <div class="idea-form-row">
        <div class="idea-form-field" style="flex:2">
          <label>ğŸ“ Nombre / Idea del video</label>
          <input type="text" id="idea-nombre" placeholder="ej: Tutorial plan de entreno 10K para principiantes">
        </div>
      </div>
      <div class="idea-form-row">
        <div class="idea-form-field">
          <label>ğŸ‘¤ Perfil / Referente</label>
          <select id="idea-perfil">
            <option value="RunnerPro">RunnerPro</option>
            <option value="cristobal running">Cristobal Running</option>
            <option value="cristobal redondo">Cristobal Redondo</option>
            <option value="Runclub">Runclub</option>
            <option value="Lucia IA">Lucia IA</option>
            <option value="Mono Blanco">Mono Blanco</option>
          </select>
        </div>
        <div class="idea-form-field">
          <label>ğŸ“± Red Social</label>
          <select id="idea-red" multiple style="min-height:80px">
            <option value="TikTok" selected>TikTok</option>
            <option value="Instagram" selected>Instagram</option>
            <option value="YouTube">YouTube</option>
            <option value="Stories">Stories</option>
            <option value="LinkedIn">LinkedIn</option>
            <option value="Podcast">Podcast</option>
          </select>
        </div>
        <div class="idea-form-field">
          <label>ğŸ¬ Tipo de contenido</label>
          <select id="idea-tipo" multiple style="min-height:80px">
            <option value="VÃ­deo" selected>Video</option>
            <option value="Guion">Guion</option>
            <option value="Historia">Historia</option>
            <option value="Carrusel">Carrusel</option>
            <option value="Cortos">Cortos</option>
            <option value="Script">Script</option>
          </select>
        </div>
      </div>
      <div class="idea-form-row">
        <div class="idea-form-field">
          <label>ğŸŸ£ Pilar de contenido</label>
          <select id="idea-pilar">
            <option value="ğŸƒğŸ» EducaciÃ³n">ğŸƒ Educacion</option>
            <option value="â¤ï¸â€ğŸ”¥ Community">â¤ï¸â€ğŸ”¥ Community</option>
            <option value="ğŸ“±âš¡ Producto">ğŸ“± Producto</option>
            <option value="âš¡branding">âš¡ Branding</option>
            <option value="ğŸ—“ï¸ Lifestyle (Sport+Work)">ğŸ—“ï¸ Lifestyle</option>
            <option value="ğŸŸï¸ Comunidad">ğŸŸï¸ Comunidad</option>
            <option value="ğŸ“£ Educar">ğŸ“£ Educar</option>
            <option value="trendyyy">Trend</option>
          </select>
        </div>
        <div class="idea-form-field">
          <label>ğŸŸ£ Tipo de Guion</label>
          <select id="idea-guion-tipo">
            <option value="">Sin definir</option>
            <option value="PAS">PAS</option>
            <option value="Guion Viral 4P">Guion Viral 4P</option>
            <option value="Storytelling">Storytelling</option>
            <option value="BÃ¡sico">Basico</option>
            <option value="Sin guiÃ³n">Sin guion</option>
          </select>
        </div>
        <div class="idea-form-field">
          <label>ğŸ“… Fecha publicacion</label>
          <input type="date" id="idea-fecha">
        </div>
      </div>
      <div class="idea-form-row">
        <div class="idea-form-field" style="flex:2">
          <label>ğŸŸ£ Hook / Gancho</label>
          <input type="text" id="idea-hook" placeholder="ej: No hagas esto si quieres correr mas rapido...">
        </div>
        <div class="idea-form-field">
          <label>ğŸŸ£ CTA</label>
          <select id="idea-cta">
            <option value="">Sin CTA</option>
            <option value="Comentar Palabra Clave">Comentar Palabra Clave</option>
            <option value="Seguirnos para mÃ¡s">Seguirnos para mas</option>
            <option value="Link a web">Link a web</option>
          </select>
        </div>
      </div>
      <div class="idea-form-row">
        <div class="idea-form-field" style="flex:1">
          <label>ğŸ”´ Descripcion / Contexto</label>
          <textarea id="idea-descripcion" placeholder="Describe la idea, referencia, contexto..."></textarea>
        </div>
      </div>

      <button class="idea-submit-btn" id="idea-submit-btn" onclick="submitIdea()">
        ğŸš€ CREAR EN NOTION
      </button>
      <div class="idea-result" id="idea-result"></div>
    </div>
  `;
  document.getElementById('popup-content').innerHTML = html;
  document.getElementById('overlay').classList.add('active');
}

async function submitIdea() {
  const btn = document.getElementById('idea-submit-btn');
  const result = document.getElementById('idea-result');
  const nombre = document.getElementById('idea-nombre').value.trim();

  if (!nombre) {
    result.className = 'idea-result show error';
    result.textContent = 'âŒ Pon un nombre o idea para el video';
    return;
  }

  btn.disabled = true;
  btn.innerHTML = 'â³ Creando en Notion...';
  result.className = 'idea-result';

  // Collect selected multi-selects
  const redes = Array.from(document.getElementById('idea-red').selectedOptions).map(o => ({name: o.value}));
  const tipos = Array.from(document.getElementById('idea-tipo').selectedOptions).map(o => ({name: o.value}));
  const perfil = document.getElementById('idea-perfil').value;
  const pilar = document.getElementById('idea-pilar').value;
  const guionTipo = document.getElementById('idea-guion-tipo').value;
  const fecha = document.getElementById('idea-fecha').value;
  const hook = document.getElementById('idea-hook').value.trim();
  const cta = document.getElementById('idea-cta').value;
  const descripcion = document.getElementById('idea-descripcion').value.trim();

  // Build properties
  const props = {
    "Nombre": { title: [{ text: { content: nombre } }] },
    "âš«Perfil (vacÃ­o = RunnerPro)": { multi_select: [{ name: perfil }] },
    "âš«Red Social": { multi_select: redes },
    "ğŸŸ£Tipo de contenido": { multi_select: tipos },
    "ğŸŸ£Pilar de contenido": { select: { name: pilar } },
    "âš«Estado": { status: { name: "Idea" } },
  };

  if (guionTipo) props["ğŸ”´Tipo de Guion"] = { select: { name: guionTipo } };
  if (fecha) props["âš«PublicaciÃ³n"] = { date: { start: fecha } };
  if (hook) props["ğŸŸ£Hook"] = { rich_text: [{ text: { content: hook } }] };
  if (cta) props["ğŸŸ£CTA"] = { select: { name: cta } };
  if (descripcion) props["ğŸ”´DescripciÃ³n"] = { rich_text: [{ text: { content: descripcion } }] };

  try {
    const res = await fetch('https://api.notion.com/v1/pages', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + getNotionKey(),
        'Notion-Version': '2022-06-28',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        parent: { database_id: CALENDARIO_DB },
        properties: props
      })
    });

    const data = await res.json();

    if (res.ok) {
      btn.className = 'idea-submit-btn success';
      btn.innerHTML = 'âœ… Creado en Notion!';
      result.className = 'idea-result show success';
      result.innerHTML = 'âœ… Idea creada: <strong>' + nombre + '</strong> â€” <a href="' + data.url + '" target="_blank" style="color:#27ae60">Abrir en Notion</a>';
      setTimeout(() => {
        btn.className = 'idea-submit-btn';
        btn.innerHTML = 'ğŸš€ CREAR EN NOTION';
        btn.disabled = false;
      }, 3000);
    } else {
      throw new Error(data.message || 'Error de Notion');
    }
  } catch (err) {
    btn.className = 'idea-submit-btn error';
    btn.innerHTML = 'âŒ Error';
    result.className = 'idea-result show error';
    result.textContent = 'âŒ ' + err.message;
    setTimeout(() => {
      btn.className = 'idea-submit-btn';
      btn.innerHTML = 'ğŸš€ CREAR EN NOTION';
      btn.disabled = false;
    }, 3000);
  }
}

// Close popup on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closePopup();
});

// â”€â”€ Auto-reconnect on page load â”€â”€
(async function reconnectActive() {
  try {
    const res = await fetch('/api/cadena/active');
    const data = await res.json();
    if (!data.runId) return; // Nothing active

    const endpoint = data.process; // e.g. "guion-ia"
    // Auto-open the popup for this process
    openPopup(endpoint);

    // Wait a tick for the popup DOM to render
    await new Promise(r => setTimeout(r, 100));

    const btn = document.getElementById('btn-' + endpoint);
    const logDiv = document.getElementById('log-' + endpoint);
    const cancelBtn = document.getElementById('cancel-' + endpoint);
    const label = endpoint.replace(/-/g, ' ').toUpperCase();

    if (!btn || !logDiv) return;

    logDiv.innerHTML = '';
    logDiv.classList.add('active');

    if (data.status === 'running') {
      // Still running â†’ reconnect SSE (stream replays full history + new lines)
      logDiv.innerHTML = ''; // SSE will replay all output
      btn.className = 'execute-btn loading';
      btn.innerHTML = 'â³ Ejecutando...';
      if (cancelBtn) cancelBtn.classList.add('active');
      currentRunId = data.runId;

      addLogLine(logDiv, 'ğŸ”„ Reconectado al proceso en curso...', 'success');

      if (currentEventSource) currentEventSource.close();
      currentEventSource = new EventSource('/api/pipeline/stream/' + data.runId);

      currentEventSource.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'log') {
          const cls = msg.text.includes('âŒ') || msg.text.includes('[stderr]') ? 'error' :
                      msg.text.includes('âœ…') ? 'success' : '';
          addLogLine(logDiv, msg.text, cls);
        } else if (msg.type === 'done') {
          currentEventSource.close();
          currentEventSource = null;
          currentRunId = null;
          if (cancelBtn) cancelBtn.classList.remove('active');
          if (msg.status === 'completed') {
            btn.className = 'execute-btn success';
            btn.innerHTML = 'âœ… Completado';
            addLogLine(logDiv, 'â•â•â• PROCESO COMPLETADO â•â•â•', 'success');
          } else {
            btn.className = 'execute-btn error';
            btn.innerHTML = 'âŒ Error (exit ' + msg.exitCode + ')';
            addLogLine(logDiv, 'â•â•â• PROCESO FALLIDO (exit ' + msg.exitCode + ') â•â•â•', 'error');
          }
          setTimeout(() => { btn.className = 'execute-btn'; btn.innerHTML = 'ğŸš€ EJECUTAR: ' + label; }, 5000);
        }
      };

      currentEventSource.onerror = () => {
        currentEventSource.close();
        currentEventSource = null;
        if (cancelBtn) cancelBtn.classList.remove('active');
        btn.className = 'execute-btn error';
        btn.innerHTML = 'âŒ ConexiÃ³n perdida';
        setTimeout(() => { btn.className = 'execute-btn'; btn.innerHTML = 'ğŸš€ EJECUTAR: ' + label; }, 3000);
      };

    } else {
      // Already finished â†’ replay output and show result
      (data.output || []).forEach(line => {
        const cls = line.includes('âŒ') || line.includes('[stderr]') ? 'error' :
                    line.includes('âœ…') ? 'success' : '';
        addLogLine(logDiv, line, cls);
      });
      if (data.exitCode === 0 || data.status === 'completed') {
        btn.className = 'execute-btn success';
        btn.innerHTML = 'âœ… Completado';
        addLogLine(logDiv, 'â•â•â• PROCESO COMPLETADO â•â•â•', 'success');
      } else {
        btn.className = 'execute-btn error';
        btn.innerHTML = 'âŒ Error (exit ' + (data.exitCode || '?') + ')';
        addLogLine(logDiv, 'â•â•â• PROCESO FALLIDO â•â•â•', 'error');
      }
      setTimeout(() => { btn.className = 'execute-btn'; btn.innerHTML = 'ğŸš€ EJECUTAR: ' + label; }, 5000);
    }
  } catch (e) {
    // Silent fail â€” no active process or server not reachable
  }
})();
</script></body></html>