<!DOCTYPE html><html lang="es"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadena de Montaje</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #191919;
  min-height: 100vh;
  color: #e0e0e0;
  display: flex;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width: 240px; min-height: 100vh; background: #202020;
  border-right: 1px solid #2a2a2a; padding: 16px 10px;
  display: flex; flex-direction: column; gap: 4px;
  position: fixed; left: 0; top: 0; bottom: 0; z-index: 100;
}
.sidebar-title {
  font-size: 11px; font-weight: 600; color: #6b6b6b;
  text-transform: uppercase; letter-spacing: 0.5px;
  padding: 8px 10px 6px; margin-top: 8px;
}
.sidebar-item {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; border-radius: 4px; cursor: pointer;
  font-size: 13px; color: #9a9a9a; transition: background 0.15s;
}
.sidebar-item:hover { background: #2a2a2a; color: #e0e0e0; }
.sidebar-item.active { background: #2a2a2a; color: #e0e0e0; }
.sidebar-item .icon { font-size: 14px; width: 20px; text-align: center; }

/* Brand list (always visible) */
.brand-list { margin: 0 4px; }
.brand-option {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; border-radius: 4px; cursor: pointer;
  font-size: 13px; color: #8a8a8a; transition: all 0.15s;
}
.brand-option:hover { background: #2a2a2a; color: #e0e0e0; }
.brand-option.selected { background: #2a2a2a; color: #e0e0e0; font-weight: 600; }
.brand-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* Theme toggle */
.theme-btn {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 4px 10px; border-radius: 4px; background: transparent;
  border: 1px solid #333; color: #9a9a9a; font-size: 14px;
  cursor: pointer; transition: all 0.15s;
}
.theme-btn:hover { background: #2a2a2a; color: #e0e0e0; border-color: #444; }

/* Light theme */
body.light { background: #ffffff; color: #37352f; }
body.light .sidebar { background: #f7f6f3; border-color: #e8e5e0; }
body.light .sidebar-title { color: #9a9a9a; }
body.light .sidebar-item { color: #6b6b6b; }
body.light .sidebar-item:hover, body.light .sidebar-item.active { background: #eae8e4; color: #37352f; }
body.light .brand-option { color: #6b6b6b; }
body.light .brand-option:hover { background: #eae8e4; color: #37352f; }
body.light .brand-option.selected { background: #eae8e4; color: #37352f; }
body.light .sidebar-legend-item { color: #9a9a9a; }
body.light .main { background: #ffffff; }
body.light .topbar { background: #f7f6f3; border-color: #e8e5e0; }
body.light .topbar-title { color: #37352f; }
body.light .topbar-btn { border-color: #d6d3ce; color: #6b6b6b; }
body.light .topbar-btn:hover { background: #eae8e4; color: #37352f; border-color: #c4c1bc; }
body.light .theme-btn { border-color: #d6d3ce; color: #6b6b6b; }
body.light .theme-btn:hover { background: #eae8e4; color: #37352f; }
body.light .kanban-column + .kanban-column { border-color: #e8e5e0; }
body.light .kanban-col-title { color: #6b6b6b; }
body.light .kanban-col-count { background: #eae8e4; color: #9a9a9a; }
body.light .kanban-card { background: #ffffff; border-color: #e8e5e0; }
body.light .kanban-card:hover { background: #f7f6f3; }
body.light .kanban-card-name { color: #37352f; }
body.light .kanban-card-owner { color: #9a9a9a; }
body.light .kanban-construction { color: #c4c1bc; }
body.light .tag-drum { background: #27ae6018; color: #1e8449; }
body.light .tag-buffer { background: #2980b918; color: #2471a3; }
body.light .tag-reu { background: #8e44ad18; color: #7d3c98; }
body.light .overlay { background: rgba(0,0,0,0.4); }
body.light .popup { background: #ffffff; border-color: #e8e5e0; }
body.light .popup-header { color: #fff; }
body.light .popup-body { color: #37352f; }
body.light .section-item-text { color: #555; }
body.light .parrilla-table th { background: #f7f6f3; border-color: #e8e5e0; color: #6b6b6b; }
body.light .parrilla-table td { border-color: #eae8e4; color: #37352f; }
body.light .parrilla-table tr:hover { background: #f7f6f3; }
body.light .parrilla-total { background: #f7f6f3; color: #37352f; }
body.light .parrilla-table input { background: #fff; color: #37352f; border-color: #d6d3ce; }
body.light .parrilla-table select { background: #fff; color: #37352f; border-color: #d6d3ce; }

/* Sidebar legend */
.sidebar-legend { padding: 8px 10px; margin-top: auto; }
.sidebar-legend-item {
  display: flex; align-items: center; gap: 8px;
  padding: 3px 0; font-size: 11px; color: #6b6b6b;
}
.sidebar-legend-dot { width: 8px; height: 8px; border-radius: 2px; }

/* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
.main {
  margin-left: 240px; flex: 1; min-height: 100vh;
  display: flex; flex-direction: column;
}

/* Top bar */
.topbar {
  display: flex; align-items: center; gap: 8px;
  padding: 12px 24px; border-bottom: 1px solid #2a2a2a;
  background: #202020; position: sticky; top: 0; z-index: 50;
}
.topbar-title {
  font-size: 14px; font-weight: 600; color: #e0e0e0; margin-right: auto;
}
.topbar-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 5px 12px; border-radius: 4px;
  background: transparent; border: 1px solid #333;
  color: #9a9a9a; font-size: 12px; font-family: inherit;
  cursor: pointer; transition: all 0.15s; font-weight: 500;
}
.topbar-btn:hover { background: #2a2a2a; color: #e0e0e0; border-color: #444; }
.topbar-btn .btn-icon { font-size: 13px; }

/* ‚îÄ‚îÄ KANBAN ‚îÄ‚îÄ */
.kanban {
  display: flex; gap: 0; padding: 20px 24px; flex: 1;
  overflow-x: auto; align-items: flex-start;
}
.kanban-column {
  min-width: 220px; max-width: 260px; flex-shrink: 0;
  display: flex; flex-direction: column;
}
.kanban-column + .kanban-column { border-left: 1px solid #2a2a2a; padding-left: 16px; margin-left: 16px; }

.kanban-col-header {
  display: flex; align-items: center; gap: 8px;
  padding: 0 4px 12px; margin-bottom: 8px;
}
.kanban-col-dot { width: 8px; height: 8px; border-radius: 2px; }
.kanban-col-title {
  font-size: 12px; font-weight: 600; color: #9a9a9a;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.kanban-col-count {
  font-size: 11px; color: #555; background: #2a2a2a;
  padding: 0 6px; border-radius: 10px; margin-left: auto;
}

/* Kanban cards */
.kanban-card {
  background: #252525; border: 1px solid #2e2e2e;
  border-radius: 4px; padding: 10px 12px; margin-bottom: 6px;
  cursor: pointer; transition: background 0.15s;
}
.kanban-card:hover { background: #2a2a2a; }
.kanban-card-name { font-size: 13px; font-weight: 500; color: #e0e0e0; margin-bottom: 6px; }
.kanban-card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.kanban-card-tag {
  font-size: 10px; font-weight: 600; padding: 2px 6px;
  border-radius: 3px; text-transform: uppercase; letter-spacing: 0.3px;
}
.kanban-card-owner {
  font-size: 11px; color: #6b6b6b; margin-left: auto;
}

/* Tag colors for step types */
.tag-drum { background: #27ae6022; color: #57d48f; }
.tag-buffer { background: #2980b922; color: #5dade2; }
.tag-reu { background: #8e44ad22; color: #bb86fc; }

/* Construction placeholder */
.kanban-construction {
  padding: 24px 12px; text-align: center; color: #444;
  font-size: 12px;
}
.kanban-construction span { display: block; margin-bottom: 4px; font-size: 18px; }

/* ‚îÄ‚îÄ OVERLAY / POPUPS (unchanged logic) ‚îÄ‚îÄ */
.overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7); z-index: 1000;
  display: none; align-items: center; justify-content: center; padding: 20px;
}
.overlay.active { display: flex; }
.popup {
  background: #252525; border-radius: 8px; border: 1px solid #333;
  max-width: 1100px; width: 100%; max-height: 90vh; overflow-y: auto;
}
.popup-header {
  padding: 16px 24px; border-radius: 8px 8px 0 0;
  display: flex; justify-content: space-between; align-items: center;
}
.popup-header-title { font-size: 15px; font-weight: 700; color: #fff; }
.popup-header-sub { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; }
.popup-close {
  cursor: pointer; color: #fff; font-size: 18px; font-weight: 600;
  opacity: 0.5; padding: 0 4px; background: none; border: none;
}
.popup-close:hover { opacity: 1; }
.popup-body { padding: 20px; }
.section-label { font-size: 11px; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.8px; text-transform: uppercase; }
.section-block { margin-bottom: 16px; }
.section-item {
  border-radius: 4px; padding: 8px 12px;
  display: flex; align-items: flex-start; gap: 8px; margin-bottom: 4px;
}
.section-item-emoji { font-size: 14px; }
.section-item-text { font-size: 12px; color: #bbb; line-height: 1.5; }
.section-item-text a { color: #bb86fc; font-size: 11px; text-decoration: underline; }

/* Execute / Week / Log */
.execute-btn {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  width: 100%; padding: 12px 24px; margin-top: 8px;
  border: 1px solid #bb86fc55; border-radius: 4px;
  background: #bb86fc12; color: #bb86fc; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.execute-btn:hover { background: #bb86fc22; border-color: #bb86fc; }
.execute-btn.loading { border-color: #f39c1255; color: #f39c12; background: #f39c1212; pointer-events: none; opacity: 0.7; }
.execute-btn.success { border-color: #27ae60; color: #fff; background: #27ae60; }
.execute-btn.error { border-color: #e74c3c55; color: #e74c3c; background: #e74c3c12; }
.week-selector { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 10px 14px; background: #2a2a2a; border: 1px solid #333; border-radius: 4px; }
.week-selector label { font-size: 11px; font-weight: 600; color: #9a9a9a; text-transform: uppercase; letter-spacing: 0.5px; }
.week-selector input[type="date"] {
  background: #191919; color: #e0e0e0; border: 1px solid #333; border-radius: 4px;
  padding: 6px 10px; font-size: 13px; font-family: inherit;
}
.week-selector input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
.log-terminal {
  background: #191919; border: 1px solid #333; border-radius: 4px;
  max-height: 350px; overflow-y: auto; padding: 12px; margin-top: 8px;
  font-family: 'SF Mono', 'Fira Code', monospace; font-size: 11px;
  line-height: 1.6; color: #888; display: none;
}
.log-terminal.active { display: block; }
.log-line { white-space: pre-wrap; word-break: break-all; }
.log-line.error { color: #e74c3c; }
.log-line.success { color: #27ae60; }
.cancel-btn {
  display: none; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 10px; margin-top: 6px;
  border: 1px solid #e74c3c33; border-radius: 4px;
  background: transparent; color: #e74c3c; font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.cancel-btn.active { display: flex; }
.cancel-btn:hover { background: #e74c3c; color: #fff; }
.context-box { margin-bottom: 8px; padding: 10px 14px; background: #2a2a2a; border: 1px solid #333; border-radius: 4px; }
.context-box label { display: block; font-size: 11px; font-weight: 600; color: #9a9a9a; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.context-box .context-hint { font-size: 10px; color: #555; margin-top: 4px; }

/* Parrilla table */
.parrilla-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
.parrilla-table th {
  padding: 8px 12px; text-align: left; color: #9a9a9a;
  font-weight: 600; font-size: 10px; text-transform: uppercase;
  letter-spacing: 0.5px; border-bottom: 1px solid #333; background: #2a2a2a;
}
.parrilla-table td { padding: 8px 12px; border-bottom: 1px solid #2a2a2a; color: #bbb; font-size: 12px; }
.parrilla-table tr:hover { background: #2a2a2a; }
.parrilla-table .red-badge {
  display: inline-block; padding: 2px 8px; border-radius: 3px;
  font-size: 10px; font-weight: 600;
}
.parrilla-total { font-weight: 700; color: #e0e0e0; background: #2a2a2a; }
/* Editable parrilla */
.parrilla-table td input, .parrilla-table td select {
  background: transparent; color: inherit; border: 1px solid transparent;
  border-radius: 3px; padding: 4px 6px; font-size: 13px; font-family: inherit;
  width: 100%; transition: border-color 0.15s;
}
.p-pilar { min-width: 200px; font-size: 13px !important; }
.p-intencion { min-width: 200px; font-size: 13px !important; }
.parrilla-table td input:hover, .parrilla-table td select:hover { border-color: #444; }
.parrilla-table td input:focus, .parrilla-table td select:focus { border-color: #bb86fc; outline: none; background: #2a2a2a; }
.parrilla-add-row {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 5px 12px; margin-top: 8px; border-radius: 4px;
  background: transparent; border: 1px dashed #444; color: #6b6b6b;
  font-size: 12px; font-family: inherit; cursor: pointer; transition: all 0.15s;
}
.parrilla-add-row:hover { border-color: #888; color: #e0e0e0; }
.parrilla-del {
  background: none; border: none; color: #555; cursor: pointer;
  font-size: 14px; padding: 2px 4px; border-radius: 3px; transition: color 0.15s;
}
.parrilla-del:hover { color: #e74c3c; }
.parrilla-status { font-size: 10px; padding: 2px 6px; border-radius: 3px; white-space: nowrap; }
.parrilla-status.ready { background: #27ae6022; color: #57d48f; }
.parrilla-status.pending { background: #f39c1222; color: #f39c12; }
/* Day toggles */
.day-toggles { display: flex; gap: 2px; }
.day-tog {
  width: 26px; height: 26px; border-radius: 3px; border: 1px solid #333;
  background: transparent; color: #555; font-size: 10px; font-weight: 700;
  cursor: pointer; transition: all 0.15s; font-family: inherit;
  display: flex; align-items: center; justify-content: center;
}
.day-tog:hover { border-color: #666; color: #aaa; }
.day-tog.on { background: #bb86fc22; border-color: #bb86fc55; color: #bb86fc; }
body.light .day-tog { border-color: #d6d3ce; color: #bbb; }
body.light .day-tog:hover { border-color: #999; color: #666; }
body.light .day-tog.on { background: #7d3c9818; border-color: #7d3c9855; color: #7d3c98; }
/* Number inputs */
.p-num { width: 55px !important; text-align: center; }
.p-num-auto { color: #6b6b6b; font-style: italic; }
/* Save button */
.parrilla-save-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 20px; margin-top: 8px; margin-left: 12px; border-radius: 4px;
  background: #27ae6018; border: 1px solid #27ae6055;
  color: #27ae60; font-size: 13px; font-weight: 600; font-family: inherit;
  cursor: pointer; transition: all 0.2s;
}
.parrilla-save-btn:hover { background: #27ae60; color: #fff; border-color: #27ae60; }
.parrilla-save-btn.saved { background: #27ae60; color: #fff; pointer-events: none; }
body.light .parrilla-save-btn { background: #27ae6010; border-color: #27ae6044; color: #1e8449; }
body.light .parrilla-save-btn:hover { background: #27ae60; color: #fff; }

/* Nueva idea form */
.idea-form-field { flex: 1; min-width: 180px; }
.idea-form-field label { display: block; font-size: 10px; font-weight: 600; color: #6b6b6b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.idea-form-field input, .idea-form-field textarea {
  width: 100%; background: #191919; color: #e0e0e0; border: 1px solid #333; border-radius: 4px;
  padding: 10px 12px; font-size: 13px; font-family: inherit;
}
.idea-form-field input::placeholder, .idea-form-field textarea::placeholder { color: #555; }
.idea-form-row { display: flex; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
.tag-group { display: flex; flex-wrap: wrap; gap: 4px; }
.tag-pill {
  padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: 500;
  cursor: pointer; transition: all 0.15s; user-select: none;
  border: 1px solid #333; background: #2a2a2a; color: #888;
}
.tag-pill:hover { border-color: #555; color: #ccc; }
.tag-pill.selected { border-color: var(--tag-color, #bb86fc); background: var(--tag-bg, #bb86fc18); color: var(--tag-color, #bb86fc); font-weight: 600; }
.context-extras {
  margin-top: 14px; padding: 12px; border-radius: 4px;
  background: #2a2a2a; border: 1px dashed #3a3a3a;
}
.context-extras label { display: block; font-size: 10px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.context-extras textarea {
  width: 100%; min-height: 100px; background: #191919; color: #888; border: 1px solid #333; border-radius: 4px;
  padding: 10px 12px; font-size: 12px; font-family: inherit; resize: none;
  overflow: hidden; field-sizing: content;
}
.context-extras textarea::placeholder { color: #444; }
.context-extras .hint { font-size: 9px; color: #444; margin-top: 4px; }
.idea-submit-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 12px; margin-top: 12px;
  border: 1px solid #27ae60; border-radius: 4px;
  background: #27ae6012; color: #27ae60; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.idea-submit-btn:hover { background: #27ae60; color: #fff; }
.idea-submit-btn:disabled { opacity: 0.5; pointer-events: none; }
.idea-submit-btn.success { background: #27ae60; color: #fff; }
.idea-submit-btn.error { border-color: #e74c3c; color: #e74c3c; background: #e74c3c12; }
.idea-result { margin-top: 8px; padding: 10px; border-radius: 4px; font-size: 12px; display: none; }
.idea-result.show { display: block; }
.idea-result.success { background: #27ae6018; border: 1px solid #27ae6033; color: #27ae60; }
.idea-result.error { background: #e74c3c18; border: 1px solid #e74c3c33; color: #e74c3c; }

/* ‚îÄ‚îÄ FLOWCHART ‚îÄ‚îÄ */
.flowchart-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 14px; border-radius: 4px;
  background: #0f346012; border: 1px solid #0f346055;
  color: #5dade2; font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all 0.2s; margin-bottom: 12px;
}
.flowchart-btn:hover { background: #0f346022; border-color: #5dade2; }
.flowchart-container {
  display: none; padding: 20px; margin-bottom: 16px;
  background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px;
  overflow-x: auto;
}
.flowchart-container.active { display: block; }
.flowchart-svg { width: 100%; min-width: 300px; }
body.light .flowchart-btn { background: #e8f4fd; border-color: #2471a3; color: #2471a3; }
body.light .flowchart-btn:hover { background: #d4edfc; }
body.light .flowchart-container { background: #fafafa; border-color: #e8e5e0; }
</style></head><body>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div style="padding:6px 10px;margin-bottom:8px">
    <div style="font-size:14px;font-weight:700;color:#e0e0e0">Cadena de Montaje</div>
  </div>

  <div class="sidebar-title">Vistas</div>

  <!-- Pipeline (expandable) -->
  <div class="sidebar-item active" data-view="kanban" onclick="showView('kanban'); toggleExpand('pipeline')">
    <span class="icon" id="pipeline-arrow" style="font-size:10px;transition:transform 0.15s">&#9660;</span>
    <span class="icon">&#9776;</span> Pipeline
  </div>
  <div class="brand-list" id="pipeline-brands" style="padding-left:28px">
    <div class="brand-option selected" data-brand="ceomedia" onclick="switchBrand('ceomedia')">
      <span class="brand-dot" style="background:#bb86fc"></span> CEO Media
    </div>
    <div class="brand-option" data-brand="runclub" onclick="switchBrand('runclub')">
      <span class="brand-dot" style="background:#00f2ea"></span> Runclub
    </div>
    <div class="brand-option" data-brand="runnerpro" onclick="switchBrand('runnerpro')">
      <span class="brand-dot" style="background:#f39c12"></span> RunnerPro
    </div>
  </div>

  <!-- Funnel (expandable) -->
  <div class="sidebar-item" data-view="funnel" onclick="showView('funnel'); toggleExpand('funnel')">
    <span class="icon" id="funnel-arrow" style="font-size:10px;transition:transform 0.15s">&#9654;</span>
    <span class="icon">&#9698;</span> Funnel
  </div>
  <div class="brand-list" id="funnel-embudos" style="padding-left:28px;display:none">
    <div class="brand-option funnel-nav selected" data-funnel="general" onclick="switchFunnel('general')">
      <span class="brand-dot" style="background:#6b7280"></span> General
    </div>
    <div class="brand-option funnel-nav" data-funnel="ceoMedia" onclick="switchFunnel('ceoMedia')">
      <span class="brand-dot" style="background:#FF4757"></span> CEO Media
    </div>
    <div class="brand-option funnel-nav" data-funnel="socialMedia" onclick="switchFunnel('socialMedia')">
      <span class="brand-dot" style="background:#2ED573"></span> Social Media
    </div>
    <div class="brand-option funnel-nav" data-funnel="email" onclick="switchFunnel('email')">
      <span class="brand-dot" style="background:#A55EEA"></span> Email
    </div>
    <div class="brand-option funnel-nav" data-funnel="runClub" onclick="switchFunnel('runClub')">
      <span class="brand-dot" style="background:#FF9F43"></span> Run Club
    </div>
    <div class="brand-option funnel-nav" data-funnel="metaAds" onclick="switchFunnel('metaAds')">
      <span class="brand-dot" style="background:#3742FA"></span> Meta Ads
    </div>
    <div class="brand-option funnel-nav" data-funnel="googleAds" onclick="switchFunnel('googleAds')">
      <span class="brand-dot" style="background:#FECA57"></span> Google Ads
    </div>
  </div>

  <!-- Bases de datos (expandable) -->
  <div class="sidebar-item" data-view="databases" onclick="showView('databases'); toggleExpand('databases')">
    <span class="icon" id="db-arrow" style="font-size:10px;transition:transform 0.15s">&#9654;</span>
    <span class="icon">&#128451;</span> Bases de datos
  </div>
  <div class="brand-list" id="db-views" style="padding-left:28px;display:none">
    <div class="brand-option db-nav selected" data-db="overview" onclick="switchDbView('overview')">
      <span class="brand-dot" style="background:#27ae60"></span> Overview
    </div>
    <div class="brand-option db-nav" data-db="videos" onclick="switchDbView('videos')">
      <span class="brand-dot" style="background:#3498db"></span> Videos
    </div>
    <div class="brand-option db-nav" data-db="scenes" onclick="switchDbView('scenes')">
      <span class="brand-dot" style="background:#8e44ad"></span> Scenes
    </div>
    <div class="brand-option db-nav" data-db="analytics" onclick="switchDbView('analytics')">
      <span class="brand-dot" style="background:#e67e22"></span> Analytics
    </div>
    <div class="brand-option db-nav" data-db="pipeline" onclick="switchDbView('pipeline')">
      <span class="brand-dot" style="background:#e74c3c"></span> Pipeline
    </div>
  </div>

</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="main-title">Pipeline ‚Äî CEO Media</div>
    <button class="topbar-btn pipeline-only-btn" id="btn-parrilla" onclick="openParrilla()"><span class="btn-icon">&#128197;</span> Parrilla</button>
    <button class="topbar-btn pipeline-only-btn" id="btn-nueva-idea" onclick="openNuevaIdea()"><span class="btn-icon">&#43;</span> Nueva idea</button>
    <button class="theme-btn" id="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">&#9790;</button>
  </div>
  <div class="kanban" id="kanban"></div>
  <iframe id="funnel-frame" src="vertical-sankey/public/index.html" style="display:none;width:100%;height:calc(100vh - 49px);border:none;" onload="this.contentWindow.postMessage({type:'setTheme',dark:isDark},'*')"></iframe>
  <iframe id="db-frame" src="moneyball/moneyball-dashboard.html" style="display:none;width:100%;height:calc(100vh - 49px);border:none;"></iframe>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay" onclick="closePopup()">
  <div class="popup" id="popup-content" onclick="event.stopPropagation()"></div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let currentBrand = 'ceomedia';

const brandConfig = {
  ceomedia: { label: "CEO Media", profile: "cristobal running", defaultPilar: "üèÉüèª Educaci√≥n", defaultRedes: ["Instagram","TikTok"] },
  runclub:  { label: "Runclub",   profile: "Runclub",           defaultPilar: "üèüÔ∏è Comunidad",    defaultRedes: ["Instagram"] },
  runnerpro:{ label: "RunnerPro", profile: "RunnerPro",         defaultPilar: "üèÉüèª Educaci√≥n",   defaultRedes: ["Instagram","TikTok","YouTube"] },
};

// Phase data ‚Äî IDEA is always #1B4F72 (blue)
const brandPhases = {
  ceomedia: [
    { id:"idea", title:"IDEA", color:"#1B4F72", steps:[
      { name:"Crea Idea", type:"drum", popupId:"crea-idea", owner:"Lucia ¬∑ Runni" },
      { name:"Revisa Ideas", type:"buffer", popupId:"lucia-revisa", owner:"Lucia" },
      { name:"Reu Validacion Ideas", type:"reu", popupId:"reu-validacion", owner:"Lucia ¬∑ Carmen ¬∑ Cristobal" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica", owner:"Lucia" },
    ]},
    { id:"creation", title:"CREACION GUION", color:"#7D3C98", steps:[
      { name:"Guion IA", type:"drum", popupId:"guion-ia", owner:"Lucia ¬∑ Runni" },
      { name:"Revisa Guiones", type:"buffer", popupId:"lucia-revisa-guiones", owner:"Lucia" },
      { name:"Reu Validacion Guiones", type:"reu", popupId:"reu-validacion-guiones", owner:"Lucia ¬∑ Carmen" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica-guiones", owner:"Lucia" },
    ]},
    { id:"visual", title:"CREACION VISUAL", color:"#D35400", steps:[
      { name:"Visual IA", type:"drum", popupId:"visual-ia", owner:"Lucia ¬∑ Runni" },
      { name:"Revisa Visuales", type:"buffer", popupId:"revisa-visuales", owner:"Lucia" },
      { name:"Reu Validacion Visuales", type:"reu", popupId:"reu-validacion-visuales", owner:"Lucia ¬∑ Carmen" },
      { name:"Aplica Cambios", type:"buffer", popupId:"aplica-visuales", owner:"Lucia" },
    ]},
    { id:"recording", title:"GRABACION", color:"#1E8449", construction:true, steps:[] },
    { id:"editing", title:"EDICION", color:"#8E44AD", construction:true, steps:[] },
    { id:"publishing", title:"PUBLICACION", color:"#2C3E50", construction:true, steps:[] },
  ],
  runclub: [
    { id:"idea", title:"IDEA", color:"#1B4F72", steps:[
      { name:"Crea Idea", type:"drum", popupId:"crea-idea", owner:"Runni" },
      { name:"Revisa Ideas", type:"buffer", popupId:"lucia-revisa", owner:"Lucia" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica", owner:"Lucia" },
    ]},
    { id:"creation", title:"CREACION GUION", color:"#7D3C98", steps:[
      { name:"Guion IA", type:"drum", popupId:"guion-ia", owner:"Runni" },
      { name:"Revisa Guiones", type:"buffer", popupId:"lucia-revisa-guiones", owner:"Lucia" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica-guiones", owner:"Lucia" },
    ]},
    { id:"visual", title:"CREACION VISUAL", color:"#D35400", construction:true, steps:[] },
    { id:"recording", title:"GRABACION", color:"#1E8449", construction:true, steps:[] },
    { id:"editing", title:"EDICION", color:"#8E44AD", construction:true, steps:[] },
    { id:"publishing", title:"PUBLICACION", color:"#2C3E50", construction:true, steps:[] },
  ],
  runnerpro: [
    { id:"idea", title:"IDEA", color:"#1B4F72", steps:[
      { name:"Crea Idea", type:"drum", popupId:"crea-idea", owner:"Runni" },
      { name:"Revisa Ideas", type:"buffer", popupId:"lucia-revisa", owner:"Lucia" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica", owner:"Lucia" },
    ]},
    { id:"creation", title:"CREACION GUION", color:"#7D3C98", steps:[
      { name:"Guion IA", type:"drum", popupId:"guion-ia", owner:"Runni" },
      { name:"Revisa Guiones", type:"buffer", popupId:"lucia-revisa-guiones", owner:"Lucia" },
      { name:"Aplica Cambios", type:"buffer", popupId:"lucia-aplica-guiones", owner:"Lucia" },
    ]},
    { id:"visual", title:"CREACION VISUAL", color:"#D35400", construction:true, steps:[] },
    { id:"recording", title:"GRABACION", color:"#1E8449", construction:true, steps:[] },
    { id:"editing", title:"EDICION", color:"#8E44AD", construction:true, steps:[] },
    { id:"publishing", title:"PUBLICACION", color:"#2C3E50", construction:true, steps:[] },
  ],
};

const typeLabels = { drum: "DRUM", buffer: "BUFFER", reu: "REU" };
const typeTags = { drum: "tag-drum", buffer: "tag-buffer", reu: "tag-reu" };

// ‚îÄ‚îÄ View switching ‚îÄ‚îÄ
let currentView = 'kanban';
let currentFunnel = 'general';
let currentDbView = 'overview';

// Expand state for each section (independent)
const expandState = { pipeline: true, funnel: false, databases: false };

function toggleExpand(section) {
  expandState[section] = !expandState[section];
  const map = {
    pipeline:  { list: 'pipeline-brands', arrow: 'pipeline-arrow' },
    funnel:    { list: 'funnel-embudos',  arrow: 'funnel-arrow' },
    databases: { list: 'db-views',        arrow: 'db-arrow' },
  };
  const cfg = map[section];
  if (!cfg) return;
  const list = document.getElementById(cfg.list);
  const arrow = document.getElementById(cfg.arrow);
  if (expandState[section]) {
    list.style.display = '';
    arrow.innerHTML = '&#9660;';
  } else {
    list.style.display = 'none';
    arrow.innerHTML = '&#9654;';
  }
}

function showView(view) {
  currentView = view;
  document.querySelectorAll('.sidebar-item[data-view]').forEach(i => i.classList.remove('active'));
  const item = document.querySelector(`.sidebar-item[data-view="${view}"]`);
  if (item) item.classList.add('active');

  const kanban = document.getElementById('kanban');
  const funnel = document.getElementById('funnel-frame');
  const dbFrame = document.getElementById('db-frame');
  const title = document.getElementById('main-title');

  // Hide all content areas
  kanban.style.display = 'none';
  funnel.style.display = 'none';
  dbFrame.style.display = 'none';

  // Pipeline-only buttons (Parrilla, Nueva idea)
  document.querySelectorAll('.pipeline-only-btn').forEach(b => {
    b.style.display = view === 'kanban' ? '' : 'none';
  });

  if (view === 'kanban') {
    kanban.style.display = '';
    title.textContent = 'Pipeline ‚Äî ' + brandConfig[currentBrand].label;
  } else if (view === 'funnel') {
    funnel.style.display = 'block';
    const funnelLabels = { general:'General', ceoMedia:'CEO Media', socialMedia:'Social Media', email:'Email', runClub:'Run Club', metaAds:'Meta Ads', googleAds:'Google Ads' };
    title.textContent = 'Funnel ‚Äî ' + (funnelLabels[currentFunnel] || currentFunnel);
    switchFunnel(currentFunnel);
  } else if (view === 'databases') {
    dbFrame.style.display = 'block';
    const dbLabels = { overview:'Overview', videos:'Videos', scenes:'Scenes', analytics:'Analytics', pipeline:'Pipeline' };
    title.textContent = 'Bases de datos ‚Äî ' + (dbLabels[currentDbView] || currentDbView);
    switchDbView(currentDbView);
  }
}

function switchFunnel(view) {
  currentFunnel = view;
  document.querySelectorAll('.funnel-nav').forEach(o => o.classList.remove('selected'));
  const el = document.querySelector(`.funnel-nav[data-funnel="${view}"]`);
  if (el) el.classList.add('selected');
  const funnelLabels = { general:'General', ceoMedia:'CEO Media', socialMedia:'Social Media', email:'Email', runClub:'Run Club', metaAds:'Meta Ads', googleAds:'Google Ads' };
  document.getElementById('main-title').textContent = 'Funnel ‚Äî ' + (funnelLabels[view] || view);
  const frame = document.getElementById('funnel-frame');
  if (frame && frame.contentWindow) {
    frame.contentWindow.postMessage({ type: 'setView', view: view }, '*');
  }
  if (currentView !== 'funnel') showView('funnel');
}

function switchDbView(view) {
  currentDbView = view;
  document.querySelectorAll('.db-nav').forEach(o => o.classList.remove('selected'));
  const el = document.querySelector(`.db-nav[data-db="${view}"]`);
  if (el) el.classList.add('selected');
  const dbLabels = { overview:'Overview', videos:'Videos', scenes:'Scenes', analytics:'Analytics', pipeline:'Pipeline' };
  document.getElementById('main-title').textContent = 'Bases de datos ‚Äî ' + (dbLabels[view] || view);
  const frame = document.getElementById('db-frame');
  if (frame && frame.contentWindow) {
    frame.contentWindow.postMessage({ type: 'setView', view: view }, '*');
  }
  if (currentView !== 'databases') showView('databases');
}

// ‚îÄ‚îÄ Brand switching ‚îÄ‚îÄ
function switchBrand(brand) {
  currentBrand = brand;
  document.getElementById('main-title').textContent = 'Pipeline ‚Äî ' + brandConfig[brand].label;
  document.querySelectorAll('.brand-option[data-brand]').forEach(o => o.classList.remove('selected'));
  document.querySelector(`.brand-option[data-brand="${brand}"]`).classList.add('selected');
  if (currentView !== 'kanban') showView('kanban');
  renderKanban();
}

// ‚îÄ‚îÄ Theme toggle ‚îÄ‚îÄ
let isDark = localStorage.getItem('theme') !== 'light';
function applyTheme() {
  document.body.classList.toggle('light', !isDark);
  document.getElementById('theme-toggle').textContent = isDark ? '\u263E' : '\u2600';
}
function toggleTheme() {
  isDark = !isDark;
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  applyTheme();
  const frame = document.getElementById('funnel-frame');
  if (frame && frame.contentWindow) {
    frame.contentWindow.postMessage({ type: 'setTheme', dark: isDark }, '*');
  }
}
applyTheme();

// ‚îÄ‚îÄ Kanban render ‚îÄ‚îÄ
function renderKanban() {
  const kanban = document.getElementById('kanban');
  kanban.innerHTML = '';
  const phases = brandPhases[currentBrand];
  phases.forEach(phase => {
    const col = document.createElement('div');
    col.className = 'kanban-column';

    // Header
    const header = document.createElement('div');
    header.className = 'kanban-col-header';
    header.innerHTML = `
      <span class="kanban-col-dot" style="background:${phase.color}"></span>
      <span class="kanban-col-title">${phase.title}</span>
      ${!phase.construction ? `<span class="kanban-col-count">${phase.steps.length}</span>` : ''}
    `;
    col.appendChild(header);

    if (phase.construction) {
      col.innerHTML += '<div class="kanban-construction"><span>&#128679;</span>Proximamente</div>';
    } else {
      phase.steps.forEach(step => {
        const card = document.createElement('div');
        card.className = 'kanban-card';
        card.onclick = () => openPopup(step.popupId);
        card.innerHTML = `
          <div class="kanban-card-name">${step.name}</div>
          <div class="kanban-card-meta">
            <span class="kanban-card-tag ${typeTags[step.type]}">${typeLabels[step.type]}</span>
            <span class="kanban-card-owner">${step.owner}</span>
          </div>
        `;
        col.appendChild(card);
      });
    }
    kanban.appendChild(col);
  });
}
renderKanban();

// ‚îÄ‚îÄ Popup system ‚îÄ‚îÄ
function sectionHTML(section, color, items) {
  return `<div class="section-block"><div class="section-label" style="color:${color}">${section}</div>${items.map(item => `<div class="section-item" style="background:${color}12;border:1px solid ${color}22"><span class="section-item-emoji">${item.emoji}</span><span class="section-item-text">${item.text}${item.link ? ` <a href="${item.link}" target="_blank">(Notion Prompt)</a>` : ''}</span></div>`).join('')}</div>`;
}

function getNextMonday() {
  const d = new Date(); const day = d.getDay();
  d.setDate(d.getDate() + (day === 0 ? 1 : 8 - day));
  return d.toISOString().split('T')[0];
}

// ‚îÄ‚îÄ Flowchart: auto-generated from script source ‚îÄ‚îÄ
// Fallback flows parsed from actual scripts (auto-updated via /api/cadena/flowchart when server available)
const FLOWCHART_DATA = {
  "crea-idea": [
    {id:"0",label:"Leer estrategia CEO Media"},
    {id:"1",label:"Historico propio"},
    {id:"2",label:"MoneyBall del referente (BBDD SQL)"},
    {id:"3",label:"MoneyBall MD del referente"},
    {id:"4",label:"Busqueda semantica en BBDD del referente"},
    {id:"5",label:"Generar idea con Gemini"},
    {id:"6",label:"Escribir en Notion"},
  ],
  "guion-ia": [
    {id:"0",label:"Leer estrategia CEO Media"},
    {id:"1",label:"Buscar ideas en Notion"},
    {id:"2",label:"Leer pagina Notion (idea + comentarios)"},
    {id:"3",label:"Historico propio"},
    {id:"4",label:"Busqueda semantica en BBDD del referente"},
    {id:"5",label:"Guia de estilo"},
    {id:"6",label:"MoneyBall MD"},
    {id:"7",label:"Calcular duracion target"},
    {id:"8",label:"Analizar estructura escenas del referente"},
    {id:"9",label:"Descripciones del referente"},
    {id:"10",label:"Generar guion con Gemini"},
    {id:"11",label:"Escribir guion en Notion"},
    {id:"12",label:"Actualizar estado Idea \u2192 Creacion"},
  ],
  "visual-ia": [
    {id:"0",label:"Buscar guiones en Notion"},
    {id:"1",label:"Leer guion de Notion"},
    {id:"2",label:"Cargar manual de estilo"},
    {id:"3",label:"Generar Biblia Visual"},
    {id:"4",label:"Procesar cada escena"},
    {id:"5",label:"Generar Google Doc nativo"},
    {id:"6",label:"Escribir link en Notion"},
    {id:"7",label:"Cambiar estado Creacion \u2192 Grabar"},
  ],
};

function flowchartButtonHTML(processId) {
  return `<button class="flowchart-btn" onclick="toggleFlowchart('${processId}', this)">&#9654; Ver Proceso</button><div class="flowchart-container" id="flowchart-${processId}"></div>`;
}

async function toggleFlowchart(processId, btn) {
  const container = document.getElementById('flowchart-' + processId);
  if (container.classList.contains('active')) {
    container.classList.remove('active');
    btn.innerHTML = '&#9654; Ver Proceso';
    return;
  }
  container.classList.add('active');
  btn.innerHTML = '&#9660; Ocultar Proceso';

  // Try server first (auto-updates from script source), fallback to hardcoded
  try {
    const res = await fetch('/api/cadena/flowchart/' + processId);
    if (res.ok) {
      const data = await res.json();
      if (data.steps && data.steps.length > 0) {
        container.innerHTML = renderFlowchartSVG(data.steps);
        return;
      }
    }
  } catch (e) { /* server not available, use fallback */ }

  // Fallback: use hardcoded data
  const steps = FLOWCHART_DATA[processId];
  if (steps) {
    container.innerHTML = renderFlowchartSVG(steps);
  } else {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;font-size:12px">Sin diagrama disponible</div>';
  }
}

function escapeXML(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderFlowchartSVG(steps) {
  if (!steps || steps.length === 0) return '<div style="color:#666;font-size:12px;text-align:center">Sin pasos definidos</div>';
  const nodeW = 280, nodeH = 44, gapY = 20, padX = 40, padY = 30;
  const totalH = padY * 2 + steps.length * nodeH + (steps.length - 1) * gapY;
  const totalW = nodeW + padX * 2;
  const light = document.body.classList.contains('light');
  const nodeFill = light ? '#ffffff' : '#252525';
  const nodeStroke = light ? '#d6d3ce' : '#333';
  const textColor = light ? '#37352f' : '#e0e0e0';
  const arrowColor = light ? '#c4c1bc' : '#444';
  let svg = `<svg class="flowchart-svg" viewBox="0 0 ${totalW} ${totalH}" xmlns="http://www.w3.org/2000/svg">`;
  svg += `<defs><filter id="fs" x="-4%" y="-10%" width="108%" height="130%"><feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.15"/></filter></defs>`;
  steps.forEach((step, i) => {
    const x = padX, y = padY + i * (nodeH + gapY);
    const isFirst = i === 0, isLast = i === steps.length - 1;
    const accent = isFirst ? '#27ae60' : isLast ? '#e74c3c' : nodeStroke;
    svg += `<rect x="${x}" y="${y}" width="${nodeW}" height="${nodeH}" rx="6" fill="${nodeFill}" stroke="${accent}" stroke-width="${isFirst||isLast?2:1}" filter="url(#fs)"/>`;
    const cx = x + 20, cy = y + nodeH / 2;
    svg += `<circle cx="${cx}" cy="${cy}" r="11" fill="${accent}" opacity="0.15"/>`;
    svg += `<text x="${cx}" y="${cy+1}" text-anchor="middle" dominant-baseline="central" font-size="10" font-weight="700" fill="${accent}">${escapeXML(step.id)}</text>`;
    let label = step.label; if (label.length > 38) label = label.substring(0, 36) + '\u2026';
    svg += `<text x="${cx+21}" y="${cy+1}" dominant-baseline="central" font-size="11.5" font-weight="500" fill="${textColor}" font-family="-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif">${escapeXML(label)}</text>`;
    if (i < steps.length - 1) {
      const ay1 = y + nodeH, ay2 = ay1 + gapY, ax = x + nodeW / 2;
      svg += `<line x1="${ax}" y1="${ay1}" x2="${ax}" y2="${ay2-4}" stroke="${arrowColor}" stroke-width="1.5"/>`;
      svg += `<polygon points="${ax-4},${ay2-6} ${ax+4},${ay2-6} ${ax},${ay2}" fill="${arrowColor}"/>`;
    }
  });
  svg += '</svg>';
  return svg;
}

function executeButtonHTML(apiEndpoint, label, showContext) {
  const defaultDate = getNextMonday();
  let contextHTML = '';
  if (showContext) {
    const pilares = ['veneno','victor_heras','andrea','post_personal','stories'];
    const pilarLabels = { veneno:'Veneno', victor_heras:'Victor Heras', andrea:'Andrea', post_personal:'Post Personal', stories:'Stories' };
    const contextFields = pilares.map(p =>
      `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="min-width:100px;font-size:11px;font-weight:500;color:#9a9a9a">${pilarLabels[p]}</span><input type="text" id="ctx-${apiEndpoint}-${p}" placeholder="contexto opcional" style="flex:1;background:#191919;color:#e0e0e0;border:1px solid #333;border-radius:4px;padding:6px 8px;font-size:11px;font-family:inherit"></div>`
    ).join('');
    contextHTML = `<div class="context-box"><label>Contexto por pilar <span style="font-weight:400;text-transform:none;color:#555">(opcional)</span></label>${contextFields}<div class="context-hint">Deja vacio para que la IA decida libremente.</div></div>`;
  }
  return `<div class="week-selector"><label>Semana del lunes:</label><input type="date" id="semana-${apiEndpoint}" value="${defaultDate}"></div>${contextHTML}<button class="execute-btn" id="btn-${apiEndpoint}" onclick="executeProcess('${apiEndpoint}', this)">EJECUTAR: ${label}</button><button class="cancel-btn" id="cancel-${apiEndpoint}" onclick="cancelProcess('${apiEndpoint}')">CANCELAR</button><div class="log-terminal" id="log-${apiEndpoint}"></div><div style="height:12px"></div>`;
}

const popups = {
"crea-idea": () => `<div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)"><div><div class="popup-header-title">Crea Idea ‚Äî ${brandConfig[currentBrand].label}</div><div class="popup-header-sub">40+ piezas/semana</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üìÖ",text:"Parrilla Semanal ‚Äî distribucion de formatos, frecuencias y plataformas"},{emoji:"üéôÔ∏è",text:"Embeddings BBDD Historico ‚Äî videos propios publicados"},{emoji:"üîç",text:"Embeddings BBDD Creadores Referentes ‚Äî busqueda semantica en 20K+ escenas"},{emoji:"üìä",text:"Excel Moneyball por Creador ‚Äî patrones ganadores con % exito"},{emoji:"üéØ",text:"Estrategia ‚Äî objetivo de cada tipo de video y posicionamiento de marca"},])}${sectionHTML("PROCESO","#bb86fc",[])}${flowchartButtonHTML("crea-idea")}${executeButtonHTML("crea-idea","CREA IDEA",true)}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üìù",text:"Por cada hueco de la parrilla, la IA genera una primera idea de contenido con hook, semantica, probabilidad de exito y un comentario de por que es ganadora."},])}</div>`,
"lucia-revisa": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Revisa Ideas</div><div class="popup-header-sub">Revision previa a la reunion</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ü§ñ",text:"Ideas generadas por Runni en el Calendario Social Media de Notion"},{emoji:"üìÖ",text:"Calendario de la semana con los huecos ya asignados"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"üëÄ",text:"Lucia revisa cada idea generada por la IA"},{emoji:"‚úçÔ∏è",text:"Anade comentarios en Notion sobre cada idea"},{emoji:"üí°",text:"Apunta ideas propias que se le ocurran al revisar"},{emoji:"‚ö†Ô∏è",text:"Marca las ideas que ve mas flojas"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üìã",text:"Calendario con comentarios de Lucia ‚Äî listo para la reu de validacion"},{emoji:"üí°",text:"Lista de ideas propias como alternativas o complementos"},])}</div>`,
"reu-validacion": () => `<div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)"><div><div class="popup-header-title">Reu Validacion Ideas</div><div class="popup-header-sub">Maximo 30 minutos</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"ü§ñ",text:"Ideas de Runni ya escritas en el Calendario"},{emoji:"‚úçÔ∏è",text:"Comentarios de Lucia en cada idea"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"üó£Ô∏è",text:"Reu de maximo 30 minutos"},{emoji:"‚úÖ",text:"Por cada idea: aprobar, modificar o descartar con razon concreta"},{emoji:"üìù",text:"Se apuntan cambios directos y contexto especifico"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üéôÔ∏è",text:"Reunion transcrita automaticamente"},{emoji:"üìã",text:"Lista de cambios concisos sobre cada idea"},])}</div>`,
"lucia-aplica": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Aplica Cambios</div><div class="popup-header-sub">Transcripcion de reu ‚Üí IA aplica ‚Üí Lucia revisa</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üéôÔ∏è",text:"Transcripcion de la reunion de validacion"},{emoji:"üìÖ",text:"Calendario Social Media actual"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ü§ñ",text:"Notion Prompt recibe la transcripcion + calendario ‚Üí aplica cambios"},{emoji:"üëÄ",text:"Lucia revisa los cambios aplicados por la IA"},{emoji:"‚úèÔ∏è",text:"Ajustes finales manuales si algo no cuadra"},{emoji:"üöÄ",text:"Activar Notion Prompt para fase CREACION",link:"https://www.notion.so/Guion-IA-CEO-Media-303a67fd29b280188115cd8bd2fb4c87"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üìÖ",text:"Calendario de la semana cerrado con ideas finales"},{emoji:"ü§ñ",text:"Runni empieza a rodar ‚Äî genera automaticamente Guion IA"},{emoji:"üîí",text:"Ciclo IDEA cerrado ‚Üí las ideas pasan a CREACION"},])}</div>`,
"guion-ia": () => `<div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)"><div><div class="popup-header-title">Guion IA</div><div class="popup-header-sub">6 inputs ‚Üí Runni genera guion completo</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üìÖ",text:"Parrilla Semanal"},{emoji:"üéôÔ∏è",text:"Embeddings BBDD Historico"},{emoji:"üîç",text:"Embeddings BBDD Creadores Referentes"},{emoji:"üìä",text:"Excel Moneyball por Creador"},{emoji:"üéØ",text:"Estrategia ‚Äî objetivo de cada tipo de video"},{emoji:"üí°",text:"Ideas y Comentarios del Calendario Notion"},])}${sectionHTML("PROCESO","#bb86fc",[])}${flowchartButtonHTML("guion-ia")}${executeButtonHTML("guion-ia","GUION IA")}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üìù",text:"En cada pagina de Notion: guion completo del video con hook detallado + guion narrativo"},{emoji:"üìã",text:"Descripcion de la publicacion"},])}</div>`,
"lucia-revisa-guiones": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Revisa Guiones</div><div class="popup-header-sub">Revision de cada guion generado</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üìù",text:"Guiones de Runni escritos en cada pagina de Notion"},{emoji:"üìÖ",text:"Calendario semanal con las ideas validadas"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"üëÅÔ∏è",text:"Lucia lee cada guion y compara con la idea original"},{emoji:"üí¨",text:"Anade comentarios en Notion"},{emoji:"‚ö†Ô∏è",text:"Marca los guiones que necesitan cambios fuertes"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üìã",text:"Guiones con comentarios listos para la reu de validacion"},])}</div>`,
"reu-validacion-guiones": () => `<div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)"><div><div class="popup-header-title">Reu Validacion Guiones</div><div class="popup-header-sub">Maximo 30 minutos</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üìù",text:"Guiones generados por Runni con comentarios"},{emoji:"üí¨",text:"Comentarios de Lucia en cada guion"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"üó£Ô∏è",text:"Reu de maximo 30 minutos"},{emoji:"‚úÖ",text:"Por cada guion: aprobar, modificar o descartar"},{emoji:"üìù",text:"Se apuntan cambios directos"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üéôÔ∏è",text:"Reunion transcrita automaticamente"},{emoji:"üìã",text:"Lista de cambios concisos sobre cada guion"},])}</div>`,
"lucia-aplica-guiones": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Aplica Cambios Guiones</div><div class="popup-header-sub">Aplica los cambios de la reu en los guiones</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üéôÔ∏è",text:"Transcripcion de la reu de validacion de guiones"},{emoji:"üìù",text:"Guiones actuales en Notion"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"ü§ñ",text:"Notion Prompt recibe transcripcion + guiones ‚Üí aplica cambios"},{emoji:"üëÅÔ∏è",text:"Lucia revisa los cambios aplicados"},{emoji:"‚úèÔ∏è",text:"Ajustes manuales si es necesario"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"‚úÖ",text:"Guiones cerrados y listos para crear Visual IA"},{emoji:"ü§ñ",text:"Runni empieza a rodar ‚Äî genera automaticamente Visual IA"},])}</div>`,
"visual-ia": () => `<div class="popup-header" style="background:linear-gradient(90deg,#1a6b3c,#27ae60)"><div><div class="popup-header-title">Visual IA</div><div class="popup-header-sub">Guion cerrado ‚Üí storyboard ‚Üí PDF</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üìÖ",text:"Parrilla Semanal"},{emoji:"üéôÔ∏è",text:"Embeddings BBDD Historico"},{emoji:"üîç",text:"Embeddings BBDD Creadores Referentes ‚Äî 20K+ escenas"},{emoji:"üìä",text:"Excel Moneyball por Creador"},{emoji:"üìù",text:"Guion de cada video (viene de CREACION GUION)"},])}${sectionHTML("PROCESO","#bb86fc",[])}${flowchartButtonHTML("visual-ia")}${executeButtonHTML("visual-ia","VISUAL IA")}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üé¨",text:"Google Doc con Visual y Storyboard subido a Drive, linkeado en Notion"},])}</div>`,
"revisa-visuales": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Revisa Visuales</div><div class="popup-header-sub">Revision de storyboards visuales</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üé¨",text:"Storyboards visuales PDF generados por Visual IA"},{emoji:"üìù",text:"Guiones cerrados de Notion como referencia"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"üëÅÔ∏è",text:"Revisa cada storyboard y compara con el guion cerrado"},{emoji:"üí¨",text:"Anade comentarios sobre planos, transiciones, overlays"},{emoji:"‚ö†Ô∏è",text:"Marca los que necesitan cambios fuertes"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üìã",text:"Storyboards con comentarios listos para la reu"},])}</div>`,
"reu-validacion-visuales": () => `<div class="popup-header" style="background:linear-gradient(90deg,#7d3c98,#8e44ad)"><div><div class="popup-header-title">Reu Validacion Visuales</div><div class="popup-header-sub">Maximo 30 minutos</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üé¨",text:"Storyboards visuales con comentarios de la revision"},{emoji:"üí¨",text:"Notas y ajustes propuestos"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"üó£Ô∏è",text:"Reu de maximo 30 minutos"},{emoji:"‚úÖ",text:"Por cada visual: aprobar, modificar o descartar"},{emoji:"üìù",text:"Se apuntan cambios directos"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"üéôÔ∏è",text:"Reunion transcrita automaticamente"},{emoji:"üìã",text:"Lista de cambios concisos sobre cada storyboard"},])}</div>`,
"aplica-visuales": () => `<div class="popup-header" style="background:linear-gradient(90deg,#2471a3,#2980b9)"><div><div class="popup-header-title">Aplica Cambios Visuales</div><div class="popup-header-sub">Aplica los cambios de la reu en los storyboards</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div><div class="popup-body">${sectionHTML("INPUT","#3498db",[{emoji:"üéôÔ∏è",text:"Transcripcion de la reu de validacion visual"},{emoji:"üé¨",text:"Storyboards actuales con los comentarios previos"},])}${sectionHTML("PROCESO","#bb86fc",[{emoji:"‚úèÔ∏è",text:"Aplica cambios manuales en los storyboards segun la reu"},{emoji:"üëÅÔ∏è",text:"Revision final de coherencia guion ‚Üî visual"},])}${sectionHTML("OUTPUT","#27ae60",[{emoji:"‚úÖ",text:"Storyboards cerrados y listos para grabar"},{emoji:"üîí",text:"Ciclo CREACION cerrado ‚Üí pasan a GRABACION"},])}</div>`,
};

function openPopup(popupId) {
  if (popups[popupId]) {
    document.getElementById('popup-content').innerHTML = popups[popupId]();
    document.getElementById('overlay').classList.add('active');
  }
}
function closePopup() { document.getElementById('overlay').classList.remove('active'); }

// ‚îÄ‚îÄ Execute process (SSE) ‚îÄ‚îÄ
let currentRunId = null;
let currentEventSource = null;

async function executeProcess(endpoint, btn) {
  const semanaInput = document.getElementById('semana-' + endpoint);
  const semana = semanaInput ? semanaInput.value : null;
  const logDiv = document.getElementById('log-' + endpoint);
  const cancelBtn = document.getElementById('cancel-' + endpoint);
  const label = endpoint.replace(/-/g,' ').toUpperCase();
  const context = {};
  ['veneno','victor_heras','andrea','post_personal','stories'].forEach(p => {
    const input = document.getElementById('ctx-' + endpoint + '-' + p);
    if (input && input.value.trim()) context[p] = input.value.trim();
  });
  btn.className = 'execute-btn loading'; btn.textContent = 'Ejecutando...';
  logDiv.innerHTML = ''; logDiv.classList.add('active'); cancelBtn.classList.add('active');
  try {
    const parrilla = getParrillaForScript();
    const res = await fetch('/api/cadena/run', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({process:endpoint,semana,context,parrilla,brand:currentBrand}) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Error desconocido');
    currentRunId = data.runId;
    addLogLine(logDiv, '‚ñ∂ Proceso: '+endpoint+' | Semana: '+(semana||'auto')+' | Run: '+data.runId, 'success');
    if (currentEventSource) currentEventSource.close();
    currentEventSource = new EventSource('/api/pipeline/stream/'+data.runId);
    currentEventSource.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === 'log') { addLogLine(logDiv, msg.text, msg.text.includes('‚ùå')||msg.text.includes('[stderr]')?'error':msg.text.includes('‚úÖ')?'success':''); }
      else if (msg.type === 'done') {
        currentEventSource.close(); currentEventSource=null; currentRunId=null; cancelBtn.classList.remove('active');
        if (msg.status==='completed') { btn.className='execute-btn success'; btn.textContent='Completado'; addLogLine(logDiv,'PROCESO COMPLETADO','success'); }
        else { btn.className='execute-btn error'; btn.textContent='Error (exit '+msg.exitCode+')'; addLogLine(logDiv,'PROCESO FALLIDO','error'); }
        setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},5000);
      }
    };
    currentEventSource.onerror = () => {
      currentEventSource.close(); currentEventSource=null; cancelBtn.classList.remove('active');
      btn.className='execute-btn error'; btn.textContent='Conexion perdida';
      setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},3000);
    };
  } catch(err) {
    btn.className='execute-btn error'; btn.textContent=err.message; cancelBtn.classList.remove('active');
    addLogLine(logDiv, err.message,'error');
    setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},3000);
  }
}
function addLogLine(logDiv, text, cls) {
  const line = document.createElement('div');
  line.className = 'log-line'+(cls?' '+cls:''); line.textContent = text;
  logDiv.appendChild(line); logDiv.scrollTop = logDiv.scrollHeight;
}
async function cancelProcess(endpoint) {
  if (!currentRunId) return;
  try { await fetch('/api/pipeline/cancel/'+currentRunId,{method:'POST'}); addLogLine(document.getElementById('log-'+endpoint),'Cancelado por el usuario','error'); } catch(e){}
}

// ‚îÄ‚îÄ Parrilla (editable, localStorage, pilar-based, auto-recalc) ‚îÄ‚îÄ
const notionPilares = ['üèÉüèª Educaci√≥n','‚ù§Ô∏è‚Äçüî• Community','üì±‚ö° Producto','‚ö°branding','trendyyy','Mario Mola','üóìÔ∏è Lifestyle (Sport+Work)','üèüÔ∏è Comunidad','üì£ Educar','üü† WHY','‚ù§Ô∏è‚Äçüî• Inspiracion','üìπ VLOG','üé¨ Andrea','‚ö° Beltr√°n','üìù Script','üéØ V√≠ctor Heras','üêç Veneno','üì∏ Post Personal','üìñ Stories','‚ù§Ô∏èüî• Community'];
const pilaresConFlujo = ['üêç Veneno','üéØ V√≠ctor Heras','üé¨ Andrea','üì∏ Post Personal','üìñ Stories'];
const dayNames = ['L','M','X','J','V','S','D'];

const defaultParrillas = {
  ceomedia: [
    {pilar:"üêç Veneno",qty:15,tiktok:7,ig:5,yt:0,dias:[1,1,1,1,1,1,1],intencion:"Alcance + Viralizacion"},
    {pilar:"üéØ V√≠ctor Heras",qty:14,tiktok:5,ig:5,yt:4,dias:[1,1,1,1,1,0,0],intencion:"Autoridad + Educacion + SEO"},
    {pilar:"üé¨ Andrea",qty:7,tiktok:4,ig:3,yt:0,dias:[1,0,1,0,1,0,0],intencion:"Lifestyle + Conexion"},
    {pilar:"üì∏ Post Personal",qty:2,tiktok:0,ig:2,yt:0,dias:[0,1,0,0,1,0,0],intencion:"Educacion + Guardados"},
    {pilar:"üìñ Stories",qty:7,tiktok:0,ig:7,yt:0,dias:[1,1,1,1,1,1,1],intencion:"Cercania + Dia a dia"},
  ],
  runclub: [
    {pilar:"üèüÔ∏è Comunidad",qty:0,tiktok:0,ig:0,yt:0,dias:[0,0,0,0,0,0,0],intencion:"Comunidad + Engagement"},
    {pilar:"üèÉüèª Educaci√≥n",qty:0,tiktok:0,ig:0,yt:0,dias:[0,0,0,0,0,0,0],intencion:"Educacion + Valor"},
  ],
  runnerpro: [
    {pilar:"üèÉüèª Educaci√≥n",qty:0,tiktok:0,ig:0,yt:0,dias:[0,0,0,0,0,0,0],intencion:"Educacion + SEO"},
    {pilar:"üì±‚ö° Producto",qty:0,tiktok:0,ig:0,yt:0,dias:[0,0,0,0,0,0,0],intencion:"Conversion + Features"},
  ],
};

function getParrilla(brand) {
  const key = 'parrilla_' + brand;
  const saved = localStorage.getItem(key);
  if (saved) {
    try {
      const rows = JSON.parse(saved);
      // Ensure dias array exists on every row (migrate old data)
      const defaults = defaultParrillas[brand] || [];
      rows.forEach((r, i) => {
        if (!r.dias) r.dias = (defaults[i] && defaults[i].dias) ? [...defaults[i].dias] : [0,0,0,0,0,0,0];
      });
      return rows;
    } catch(e){}
  }
  return JSON.parse(JSON.stringify(defaultParrillas[brand] || []));
}
function saveParrilla(brand, rows) {
  localStorage.setItem('parrilla_' + brand, JSON.stringify(rows));
}

function openParrilla() {
  const bl = brandConfig[currentBrand].label;
  const rows = getParrilla(currentBrand);

  const rowsHTML = rows.map((r, i) => {
    const hasFlujo = pilaresConFlujo.includes(r.pilar);
    const statusHTML = hasFlujo
      ? '<span class="parrilla-status ready">Flujo activo</span>'
      : '<span class="parrilla-status pending">Por crear</span>';
    const diasHTML = dayNames.map((d, di) =>
      `<button class="day-tog${r.dias && r.dias[di] ? ' on' : ''}" data-row="${i}" data-day="${di}" onclick="parrillaToggleDay(${i},${di})">${d}</button>`
    ).join('');
    return `<tr data-idx="${i}">
      <td><select class="p-pilar" onchange="parrillaChanged()">${notionPilares.map(p => `<option value="${p}"${p===r.pilar?' selected':''}>${p}</option>`).join('')}</select></td>
      <td><input type="number" class="p-qty p-num" value="${r.qty}" min="0" onchange="parrillaQtyChanged(${i})" oninput="parrillaQtyChanged(${i})"></td>
      <td><input type="number" class="p-tiktok p-num" value="${r.tiktok}" min="0" onchange="parrillaNetChanged(${i},'tiktok')" oninput="parrillaNetChanged(${i},'tiktok')"></td>
      <td><input type="number" class="p-ig p-num" value="${r.ig}" min="0" onchange="parrillaNetChanged(${i},'ig')" oninput="parrillaNetChanged(${i},'ig')"></td>
      <td><input type="number" class="p-yt p-num" value="${r.yt}" min="0" onchange="parrillaNetChanged(${i},'yt')" oninput="parrillaNetChanged(${i},'yt')"></td>
      <td><div class="day-toggles">${diasHTML}</div></td>
      <td><input class="p-intencion" value="${r.intencion}" onchange="parrillaChanged()"></td>
      <td style="text-align:center">${statusHTML}</td>
      <td><button class="parrilla-del" onclick="parrillaDeleteRow(${i})" title="Eliminar fila">&#10005;</button></td>
    </tr>`;
  }).join('');

  // Totals
  const totQty = rows.reduce((s,r) => s + (parseInt(r.qty)||0), 0);
  const totTk = rows.reduce((s,r) => s + (parseInt(r.tiktok)||0), 0);
  const totIg = rows.reduce((s,r) => s + (parseInt(r.ig)||0), 0);
  const totYt = rows.reduce((s,r) => s + (parseInt(r.yt)||0), 0);

  document.getElementById('popup-content').innerHTML = `
    <div class="popup-header" style="background:#2a2a2a"><div><div class="popup-header-title">Parrilla ‚Äî ${bl}</div><div class="popup-header-sub">Edita cantidades ¬∑ Se recalcula automaticamente ¬∑ Guardado en tu navegador</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div>
    <div class="popup-body" style="overflow-x:auto">
      <table class="parrilla-table" id="parrilla-table">
        <tr>
          <th style="min-width:200px">Pilar</th>
          <th style="text-align:center;width:70px">Qty/Sem</th>
          <th style="text-align:center;width:70px">TikTok</th>
          <th style="text-align:center;width:70px">Insta</th>
          <th style="text-align:center;width:70px">YouTube</th>
          <th style="width:210px">Dias</th>
          <th style="min-width:200px">Intencion</th>
          <th style="width:80px;text-align:center">Estado</th>
          <th style="width:28px"></th>
        </tr>
        ${rowsHTML}
        <tr class="parrilla-total">
          <td>TOTAL</td>
          <td style="text-align:center">${totQty}</td>
          <td style="text-align:center">${totTk}</td>
          <td style="text-align:center">${totIg}</td>
          <td style="text-align:center">${totYt}</td>
          <td colspan="4"></td>
        </tr>
      </table>
      <div style="display:flex;align-items:center;gap:8px;margin-top:12px">
        <button class="parrilla-add-row" onclick="parrillaAddRow()" style="margin-top:0">+ Anadir pilar</button>
        <button class="parrilla-save-btn" id="parrilla-save-btn" onclick="parrillaGuardar()">&#10003; Guardar</button>
      </div>
    </div>`;
  document.getElementById('overlay').classList.add('active');
}

// When qty changes: redistribute tiktok/ig keeping yt, tiktok gets half (rounded), ig gets the rest
function parrillaQtyChanged(idx) {
  const rows = readParrillaFromDOM();
  const r = rows[idx];
  const qty = parseInt(r.qty) || 0;
  const yt = parseInt(r.yt) || 0;
  const remaining = Math.max(0, qty - yt);
  r.tiktok = Math.round(remaining / 2);
  r.ig = remaining - r.tiktok;
  saveParrilla(currentBrand, rows);
  // Update DOM inputs without full re-render
  const tr = document.querySelector(`tr[data-idx="${idx}"]`);
  tr.querySelector('.p-tiktok').value = r.tiktok;
  tr.querySelector('.p-ig').value = r.ig;
  updateParrillaTotals(rows);
}

// When tiktok, ig, or yt changes: recalculate the other (ig = qty - tiktok - yt)
function parrillaNetChanged(idx, field) {
  const rows = readParrillaFromDOM();
  const r = rows[idx];
  const qty = parseInt(r.qty) || 0;
  const tk = parseInt(r.tiktok) || 0;
  const ig = parseInt(r.ig) || 0;
  const yt = parseInt(r.yt) || 0;

  if (field === 'tiktok') {
    r.ig = Math.max(0, qty - tk - yt);
    document.querySelector(`tr[data-idx="${idx}"] .p-ig`).value = r.ig;
  } else if (field === 'ig') {
    r.tiktok = Math.max(0, qty - ig - yt);
    document.querySelector(`tr[data-idx="${idx}"] .p-tiktok`).value = r.tiktok;
  } else if (field === 'yt') {
    const remaining = Math.max(0, qty - yt);
    r.tiktok = Math.round(remaining / 2);
    r.ig = remaining - r.tiktok;
    document.querySelector(`tr[data-idx="${idx}"] .p-tiktok`).value = r.tiktok;
    document.querySelector(`tr[data-idx="${idx}"] .p-ig`).value = r.ig;
  }
  saveParrilla(currentBrand, rows);
  updateParrillaTotals(rows);
}

function parrillaToggleDay(rowIdx, dayIdx) {
  const rows = readParrillaFromDOM();
  if (!rows[rowIdx].dias) rows[rowIdx].dias = [0,0,0,0,0,0,0];
  rows[rowIdx].dias[dayIdx] = rows[rowIdx].dias[dayIdx] ? 0 : 1;
  saveParrilla(currentBrand, rows);
  const btn = document.querySelector(`button.day-tog[data-row="${rowIdx}"][data-day="${dayIdx}"]`);
  btn.classList.toggle('on');
}

function parrillaChanged() {
  const rows = readParrillaFromDOM();
  saveParrilla(currentBrand, rows);
  updateParrillaTotals(rows);
}

function readParrillaFromDOM() {
  const table = document.getElementById('parrilla-table');
  const trs = table.querySelectorAll('tr[data-idx]');
  const rows = [];
  trs.forEach((tr, i) => {
    const dayBtns = tr.querySelectorAll('.day-tog');
    const dias = Array.from(dayBtns).map(b => b.classList.contains('on') ? 1 : 0);
    rows.push({
      pilar: tr.querySelector('.p-pilar').value,
      qty: parseInt(tr.querySelector('.p-qty').value) || 0,
      tiktok: parseInt(tr.querySelector('.p-tiktok').value) || 0,
      ig: parseInt(tr.querySelector('.p-ig').value) || 0,
      yt: parseInt(tr.querySelector('.p-yt').value) || 0,
      dias: dias.length === 7 ? dias : [0,0,0,0,0,0,0],
      intencion: tr.querySelector('.p-intencion').value,
    });
  });
  return rows;
}

function updateParrillaTotals(rows) {
  const totalRow = document.querySelector('.parrilla-total');
  if (!totalRow) return;
  const tds = totalRow.querySelectorAll('td');
  tds[1].textContent = rows.reduce((s,r) => s + (parseInt(r.qty)||0), 0);
  tds[2].textContent = rows.reduce((s,r) => s + (parseInt(r.tiktok)||0), 0);
  tds[3].textContent = rows.reduce((s,r) => s + (parseInt(r.ig)||0), 0);
  tds[4].textContent = rows.reduce((s,r) => s + (parseInt(r.yt)||0), 0);
}

function parrillaAddRow() {
  const rows = getParrilla(currentBrand);
  rows.push({pilar: notionPilares[0], qty:0, tiktok:0, ig:0, yt:0, dias:[0,0,0,0,0,0,0], intencion:""});
  saveParrilla(currentBrand, rows);
  openParrilla();
}

function parrillaDeleteRow(idx) {
  const rows = getParrilla(currentBrand);
  rows.splice(idx, 1);
  saveParrilla(currentBrand, rows);
  openParrilla();
}

function parrillaGuardar() {
  const rows = readParrillaFromDOM();
  saveParrilla(currentBrand, rows);
  const btn = document.getElementById('parrilla-save-btn');
  btn.classList.add('saved');
  btn.innerHTML = '&#10003; Guardado';
  setTimeout(() => { btn.classList.remove('saved'); btn.innerHTML = '&#10003; Guardar'; }, 2000);
}

function getParrillaForScript() { return getParrilla(currentBrand); }

// ‚îÄ‚îÄ Nueva Idea ‚îÄ‚îÄ
const CALENDARIO_DB = '13da67fd-29b2-801f-bac3-c72d4fb45bf2';
function getNotionKey() {
  let key = localStorage.getItem('notion_key');
  if (!key) { key = prompt('Introduce tu Notion API Key (se guarda en tu navegador):'); if (key) localStorage.setItem('notion_key', key); }
  return key;
}

function tagHTML(group, values, color, bg, multi, preselected) {
  return values.map(v => {
    const sel = preselected && preselected.includes(v) ? ' selected' : '';
    return `<span class="tag-pill${sel}" data-group="${group}" data-value="${v}" data-multi="${multi}" style="--tag-color:${color};--tag-bg:${bg}" onclick="toggleTag(this)">${v}</span>`;
  }).join('');
}
function toggleTag(el) {
  const multi = el.dataset.multi === 'true';
  if (multi) { el.classList.toggle('selected'); }
  else { document.querySelectorAll(`.tag-pill[data-group="${el.dataset.group}"]`).forEach(t=>t.classList.remove('selected')); el.classList.add('selected'); }
}
function getTagValues(group) { return Array.from(document.querySelectorAll(`.tag-pill[data-group="${group}"].selected`)).map(t=>t.dataset.value); }

function openNuevaIdea() {
  const bc = brandConfig[currentBrand];
  const pilares = ['üèÉüèª Educaci√≥n','‚ù§Ô∏è‚Äçüî• Community','üì±‚ö° Producto','‚ö°branding','trendyyy','Mario Mola','üóìÔ∏è Lifestyle (Sport+Work)','üèüÔ∏è Comunidad','üì£ Educar','üü† WHY','‚ù§Ô∏è‚Äçüî• Inspiracion','üìπ VLOG','üé¨ Andrea','‚ö° Beltr√°n','üìù Script','üéØ V√≠ctor Heras','üêç Veneno','üì∏ Post Personal','üìñ Stories','‚ù§Ô∏èüî• Community'];
  const perfiles = ['cristobal running','RunnerPro','cristobal redondo','Runclub','Meta ADS','Mono Blanco','Raul IA','Lucia IA'];
  const redes = ['Instagram','TikTok','YouTube','LinkedIn','X','Threads','Crist√≥bal','Podcast','Strava','Stories','Meta ADS'];
  const tipos = ['Guion','Script','V√≠deo','Historia','Carrusel','LinkedIn Post','Texto','Cortos'];

  document.getElementById('popup-content').innerHTML = `
    <div class="popup-header" style="background:#2a2a2a"><div><div class="popup-header-title">Nueva idea ‚Äî ${bc.label}</div><div class="popup-header-sub">Crea una entrada en el Calendario Social Media de Notion</div></div><button class="popup-close" onclick="closePopup()">&#10005;</button></div>
    <div class="popup-body">
      <div class="idea-form-field" style="margin-bottom:14px"><label>Nombre / Idea del video</label><input type="text" id="idea-nombre" placeholder="ej: Tutorial plan de entreno 10K para principiantes" style="font-size:14px;padding:10px 12px"></div>
      <div class="idea-form-field" style="margin-bottom:14px"><label>Pilar de contenido</label><div class="tag-group">${tagHTML('pilar',pilares,'#bb86fc','#bb86fc18',false,[bc.defaultPilar])}</div></div>
      <div class="idea-form-field" style="margin-bottom:14px"><label>Perfil</label><div class="tag-group">${tagHTML('perfil',perfiles,'#f39c12','#f39c1218',false,[bc.profile])}</div></div>
      <div class="idea-form-field" style="margin-bottom:14px"><label>Red Social</label><div class="tag-group">${tagHTML('red',redes,'#5dade2','#5dade218',true,bc.defaultRedes)}</div></div>
      <div class="idea-form-field" style="margin-bottom:14px"><label>Tipo de contenido</label><div class="tag-group">${tagHTML('tipo',tipos,'#e74c3c','#e74c3c18',true,['V√≠deo'])}</div></div>
      <div class="idea-form-row"><div class="idea-form-field"><label>Fecha publicacion</label><input type="date" id="idea-fecha"></div></div>
      <div class="context-extras"><label>Comentarios extra <span style="font-weight:400;text-transform:none;color:#444">(no se sube a Notion)</span></label><textarea id="idea-contexto" placeholder="Apuntes, referencias, tono deseado..."></textarea><div class="hint">Solo notas internas, no crea campo en Notion.</div></div>
      <button class="idea-submit-btn" id="idea-submit-btn" onclick="submitIdea()">Crear en Notion</button>
      <div class="idea-result" id="idea-result"></div>
    </div>`;
  document.getElementById('overlay').classList.add('active');
}

async function submitIdea() {
  const btn = document.getElementById('idea-submit-btn');
  const result = document.getElementById('idea-result');
  const nombre = document.getElementById('idea-nombre').value.trim();
  if (!nombre) { result.className='idea-result show error'; result.textContent='Pon un nombre o idea para el video'; return; }
  const pilarArr = getTagValues('pilar'), perfilArr = getTagValues('perfil'), redes = getTagValues('red'), tipos = getTagValues('tipo');
  const fecha = document.getElementById('idea-fecha').value;
  if (!pilarArr.length) { result.className='idea-result show error'; result.textContent='Selecciona un pilar de contenido'; return; }
  if (!perfilArr.length) { result.className='idea-result show error'; result.textContent='Selecciona un perfil'; return; }
  btn.disabled = true; btn.textContent = 'Creando en Notion...'; result.className='idea-result';
  const props = {
    "Nombre":{title:[{text:{content:nombre}}]},
    "‚ö´Perfil (vac√≠o = RunnerPro)":{multi_select:perfilArr.map(n=>({name:n}))},
    "‚ö´Red Social":{multi_select:redes.map(n=>({name:n}))},
    "üü£Tipo de contenido":{multi_select:tipos.map(n=>({name:n}))},
    "üü£Pilar de contenido":{select:{name:pilarArr[0]}},
    "‚ö´Estado":{status:{name:"Idea"}},
  };
  if (fecha) props["‚ö´Publicaci√≥n"] = {date:{start:fecha}};
  try {
    const res = await fetch('https://api.notion.com/v1/pages',{method:'POST',headers:{'Authorization':'Bearer '+getNotionKey(),'Notion-Version':'2022-06-28','Content-Type':'application/json'},body:JSON.stringify({parent:{database_id:CALENDARIO_DB},properties:props})});
    const data = await res.json();
    if (res.ok) {
      btn.className='idea-submit-btn success'; btn.textContent='Creado en Notion!';
      result.className='idea-result show success';
      result.innerHTML = '<strong>'+nombre+'</strong> ‚Äî <a href="'+data.url+'" target="_blank" style="color:#27ae60;text-decoration:underline">Abrir en Notion</a>';
      setTimeout(()=>{btn.className='idea-submit-btn';btn.textContent='Crear en Notion';btn.disabled=false;},4000);
    } else { throw new Error(data.message||'Error de Notion'); }
  } catch(err) {
    btn.className='idea-submit-btn error'; btn.textContent='Error';
    result.className='idea-result show error'; result.textContent=err.message;
    setTimeout(()=>{btn.className='idea-submit-btn';btn.textContent='Crear en Notion';btn.disabled=false;},3000);
  }
}

// Escape to close
document.addEventListener('keydown', e => { if (e.key==='Escape') closePopup(); });

// Auto-reconnect
(async function reconnectActive() {
  try {
    const res = await fetch('/api/cadena/active'); const data = await res.json();
    if (!data.runId) return;
    const endpoint = data.process; openPopup(endpoint);
    await new Promise(r=>setTimeout(r,100));
    const btn=document.getElementById('btn-'+endpoint), logDiv=document.getElementById('log-'+endpoint), cancelBtn=document.getElementById('cancel-'+endpoint);
    const label=endpoint.replace(/-/g,' ').toUpperCase();
    if (!btn||!logDiv) return;
    logDiv.innerHTML=''; logDiv.classList.add('active');
    if (data.status==='running') {
      btn.className='execute-btn loading'; btn.textContent='Ejecutando...';
      if(cancelBtn) cancelBtn.classList.add('active');
      currentRunId=data.runId;
      addLogLine(logDiv,'Reconectado al proceso en curso...','success');
      if(currentEventSource) currentEventSource.close();
      currentEventSource=new EventSource('/api/pipeline/stream/'+data.runId);
      currentEventSource.onmessage=(event)=>{const msg=JSON.parse(event.data);if(msg.type==='log'){addLogLine(logDiv,msg.text,msg.text.includes('‚ùå')?'error':msg.text.includes('‚úÖ')?'success':'');}else if(msg.type==='done'){currentEventSource.close();currentEventSource=null;currentRunId=null;if(cancelBtn)cancelBtn.classList.remove('active');if(msg.status==='completed'){btn.className='execute-btn success';btn.textContent='Completado';addLogLine(logDiv,'PROCESO COMPLETADO','success');}else{btn.className='execute-btn error';btn.textContent='Error (exit '+msg.exitCode+')';addLogLine(logDiv,'PROCESO FALLIDO','error');}setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},5000);}};
      currentEventSource.onerror=()=>{currentEventSource.close();currentEventSource=null;if(cancelBtn)cancelBtn.classList.remove('active');btn.className='execute-btn error';btn.textContent='Conexion perdida';setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},3000);};
    } else {
      (data.output||[]).forEach(line=>{addLogLine(logDiv,line,line.includes('‚ùå')?'error':line.includes('‚úÖ')?'success':'');});
      if(data.exitCode===0||data.status==='completed'){btn.className='execute-btn success';btn.textContent='Completado';addLogLine(logDiv,'PROCESO COMPLETADO','success');}
      else{btn.className='execute-btn error';btn.textContent='Error (exit '+(data.exitCode||'?')+')';addLogLine(logDiv,'PROCESO FALLIDO','error');}
      setTimeout(()=>{btn.className='execute-btn';btn.textContent='EJECUTAR: '+label;},5000);
    }
  } catch(e){}
})();
</script></body></html>
