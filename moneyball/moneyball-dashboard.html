<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MoneyBall Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1419;--bg2:#111518;--bg3:#1a1f25;
  --text:#e8e8e8;--text2:#888;--text3:#555;
  --green:#27ae60;--blue:#3498db;--purple:#8e44ad;
  --orange:#e67e22;--red:#e74c3c;--yellow:#f1c40f;
  --radius:14px;--radius-sm:8px;
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--blue);text-decoration:none}
a:hover{text-decoration:underline}

/* Nav */
#nav{display:flex;background:var(--bg2);border-bottom:2px solid #333;position:sticky;top:0;z-index:100}
.nav-item{padding:14px 22px;cursor:pointer;transition:all .2s;border-bottom:3px solid transparent;font-size:13px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text2)}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:var(--bg3);border-bottom-color:var(--green);color:var(--green)}
.nav-title{padding:14px 22px;font-size:14px;font-weight:800;color:var(--green);letter-spacing:1px}

/* Layout */
.view{display:none;padding:24px;max-width:1400px;margin:0 auto}
.view.active{display:block}

/* Cards grid */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
.card{background:var(--bg2);border-radius:var(--radius);padding:20px;border:2px solid #333;transition:all .25s;cursor:pointer}
.card:hover{transform:scale(1.02);border-color:#fff;box-shadow:0 0 20px rgba(39,174,96,.2)}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.card-header h3{font-size:16px;font-weight:700}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;letter-spacing:.5px}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.stat{text-align:center;padding:8px;background:var(--bg);border-radius:var(--radius-sm)}
.stat label{display:block;font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.stat value{display:block;font-size:18px;font-weight:800;color:var(--text)}
.stat.highlight value{color:var(--green)}
.pattern-tag{display:inline-block;padding:4px 10px;background:var(--bg);border-radius:6px;font-size:11px;margin:3px 3px 3px 0;color:var(--text2);border:1px solid #333}

/* Table */
.filters{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.filters select,.filters input{background:var(--bg2);color:var(--text);border:1px solid #333;border-radius:var(--radius-sm);padding:10px 14px;font-size:13px;outline:none}
.filters select:focus,.filters input:focus{border-color:var(--blue)}
.filters input{flex:1;min-width:200px}
.table-scroll{overflow-x:auto;border-radius:var(--radius-sm);border:1px solid #333}
table{width:100%;border-collapse:collapse;min-width:2400px}
thead th{padding:10px 12px;background:var(--bg2);border-bottom:2px solid #333;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);cursor:pointer;user-select:none;white-space:nowrap;position:sticky;top:0;z-index:2}
thead th:hover{color:var(--text)}
thead th.sorted{color:var(--green)}
tbody td{padding:8px 12px;border-bottom:1px solid #1a1f25;font-size:12px;vertical-align:top}
tbody tr{transition:background .15s;cursor:pointer}
tbody tr:hover{background:var(--bg3)}
.cell-trunc{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cell-wide{max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
td.num{text-align:right;font-variant-numeric:tabular-nums}

/* Pagination */
.pagination{display:flex;justify-content:center;align-items:center;gap:12px;margin-top:20px;padding:16px}
.pagination button{background:var(--bg2);color:var(--text);border:1px solid #333;border-radius:var(--radius-sm);padding:8px 18px;cursor:pointer;font-size:13px;transition:all .2s}
.pagination button:hover:not(:disabled){border-color:var(--green);color:var(--green)}
.pagination button:disabled{opacity:.3;cursor:default}
.pagination span{font-size:13px;color:var(--text2)}

/* Scenes grid */
.scenes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:16px}
.scene-card{background:var(--bg2);border-radius:var(--radius);overflow:hidden;border:1px solid #333;transition:all .25s;cursor:pointer}
.scene-card:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.4);border-color:#555}
.scene-thumb{width:100%;height:180px;background:#000;overflow:hidden;position:relative}
.scene-thumb img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
.scene-card:hover .scene-thumb img{transform:scale(1.05)}
.scene-info{padding:14px}
.scene-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.scene-desc{font-size:12px;color:var(--text2);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* Overlay / Popup */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:none;overflow-y:auto;padding:40px 20px}
.overlay.active{display:flex;justify-content:center;align-items:flex-start}
.popup{background:var(--bg3);border-radius:16px;max-width:1100px;width:100%;animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.popup-header{padding:20px 24px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center}
.popup-header h2{font-size:18px;font-weight:800}
.popup-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:4px 8px;border-radius:6px}
.popup-close:hover{background:rgba(255,255,255,.1)}
.popup-body{padding:24px}
.metrics-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.metric{background:var(--bg);border-radius:var(--radius-sm);padding:14px;text-align:center}
.metric label{display:block;font-size:10px;color:var(--text2);text-transform:uppercase;margin-bottom:4px}
.metric value{display:block;font-size:22px;font-weight:800}
.section{margin-bottom:24px}
.section h3{font-size:14px;font-weight:700;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #333}
.section p{font-size:13px;line-height:1.6;color:var(--text2)}
.tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.tag{padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600}
.transcript-box{background:var(--bg);border-radius:var(--radius-sm);padding:16px;font-size:12px;line-height:1.7;color:var(--text2);max-height:200px;overflow-y:auto;cursor:pointer}
.transcript-box.expanded{max-height:none}
.detail-scenes{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
.detail-scene{background:var(--bg);border-radius:var(--radius-sm);overflow:hidden;border:1px solid #333}
.detail-scene-thumb{height:130px;background:#000;overflow:hidden}
.detail-scene-thumb img{width:100%;height:100%;object-fit:cover}
.detail-scene-info{padding:10px;font-size:11px;color:var(--text2);line-height:1.4}
.detail-scene-info strong{color:var(--text);font-size:12px}

/* Analytics */
.analytics-header{display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
.chart-container{background:var(--bg2);border-radius:var(--radius);padding:20px;margin-bottom:20px}
.chart-container h3{font-size:14px;font-weight:700;margin-bottom:14px;color:var(--text2)}
.chart-wrap{position:relative;height:350px}

/* Compare */
.compare-controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
.compare-controls label{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg2);border-radius:var(--radius-sm);cursor:pointer;font-size:13px;border:1px solid #333;transition:all .2s}
.compare-controls label:hover{border-color:var(--blue)}
.compare-controls input[type=checkbox]{accent-color:var(--green)}
.compare-table{width:100%;border-collapse:collapse;margin-top:16px}
.compare-table th,.compare-table td{padding:12px;text-align:center;border-bottom:1px solid #333;font-size:13px}
.compare-table th{font-size:11px;text-transform:uppercase;color:var(--text2);font-weight:700}
.compare-table td:first-child{text-align:left;font-weight:700}
.radar-wrap{max-width:500px;margin:0 auto}

/* Activity */
.totals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.total-card{background:var(--bg2);border-radius:var(--radius);padding:16px;text-align:center;border:1px solid #333}
.total-card label{display:block;font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.total-card value{display:block;font-size:24px;font-weight:800}
.timeline{margin-top:16px}
.timeline-period{background:var(--bg2);border-radius:var(--radius);padding:20px;margin-bottom:12px;border-left:4px solid var(--green)}
.timeline-period-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.timeline-period-header h3{font-size:15px;font-weight:700}
.timeline-period-header .period-totals{display:flex;gap:16px}
.period-stat{font-size:12px;color:var(--text2)}
.period-stat strong{color:var(--text);font-weight:700}
.creator-rows{display:grid;gap:6px}
.creator-row{display:flex;align-items:center;gap:12px;padding:8px 12px;background:var(--bg);border-radius:var(--radius-sm);font-size:12px}
.creator-row .bar-wrap{flex:1;height:8px;background:#222;border-radius:4px;overflow:hidden}
.creator-row .bar{height:100%;border-radius:4px;transition:width .5s}
.creator-row .row-label{min-width:130px;font-weight:600}
.creator-row .row-nums{min-width:120px;text-align:right;color:var(--text2);font-size:11px}
.group-toggle{display:flex;gap:0;background:var(--bg2);border-radius:var(--radius-sm);overflow:hidden;border:1px solid #333}
.group-toggle button{padding:8px 16px;background:none;border:none;color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.group-toggle button.active{background:var(--green);color:#fff}
.group-toggle button:hover:not(.active){background:var(--bg3);color:var(--text)}

/* Loading */
.loading{text-align:center;padding:60px;color:var(--text2);font-size:14px}
.loading::after{content:'';display:block;width:30px;height:30px;border:3px solid var(--text3);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;margin:16px auto 0}
@keyframes spin{to{transform:rotate(360deg)}}

/* Empty */
.empty{text-align:center;padding:60px;color:var(--text3);font-size:14px}

/* Pipeline */
.pipeline-config{background:var(--bg2);border-radius:var(--radius);padding:20px;margin-bottom:20px;border:1px solid #333}
.config-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-bottom:16px}
.config-group{display:flex;flex-direction:column;gap:4px}
.config-group.full-width{grid-column:1/-1}
.config-group label.config-label{font-size:10px;text-transform:uppercase;color:var(--text2);letter-spacing:.5px;font-weight:700}
.config-group input,.config-group select,.config-group textarea{background:var(--bg);color:var(--text);border:1px solid #333;border-radius:var(--radius-sm);padding:8px 12px;font-size:13px;outline:none;font-family:inherit}
.config-group input:focus,.config-group select:focus,.config-group textarea:focus{border-color:var(--blue)}
.phase-toggles{display:flex;flex-wrap:wrap;gap:6px}
.phase-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;background:var(--bg);border-radius:6px;font-size:11px;cursor:pointer;border:1px solid #333;transition:all .2s;user-select:none}
.phase-btn:hover{border-color:#555}
.phase-btn.active{border-color:var(--green);background:rgba(39,174,96,.12);color:var(--green)}
.phase-btn input{display:none}
.config-actions{display:flex;gap:12px;margin-top:4px}
.run-btn{background:var(--green);color:#fff;border:none;padding:11px 28px;border-radius:var(--radius-sm);font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:.3px}
.run-btn:hover:not(:disabled){background:#2ecc71;transform:translateY(-1px)}
.run-btn:disabled{opacity:.4;cursor:default;transform:none}
.dryrun-btn{background:var(--bg3);color:var(--text);border:1px solid #555;padding:11px 20px;border-radius:var(--radius-sm);font-size:13px;cursor:pointer;transition:all .2s}
.dryrun-btn:hover:not(:disabled){border-color:var(--text2)}
.dryrun-btn:disabled{opacity:.4;cursor:default}

/* Pipeline Console */
.pipeline-console{background:#0a0d10;border-radius:var(--radius);border:1px solid #333;overflow:hidden}
.console-header{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;background:var(--bg2);border-bottom:1px solid #333}
.console-status{display:flex;align-items:center;gap:8px;font-size:13px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--text3);flex-shrink:0}
.status-dot.running{background:var(--green);animation:pulse 1.5s infinite}
.status-dot.completed{background:var(--green)}
.status-dot.failed{background:var(--red)}
.status-dot.cancelled{background:var(--orange)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.console-actions{display:flex;gap:8px}
.console-actions button{background:var(--bg);color:var(--text2);border:1px solid #333;border-radius:6px;padding:5px 14px;font-size:11px;cursor:pointer;transition:all .15s}
.console-actions button:hover:not(:disabled){border-color:var(--text2);color:var(--text)}
.console-actions button:disabled{opacity:.3;cursor:default}
.console-actions button.cancel-btn{border-color:var(--red)44;color:var(--red)}
.console-output{padding:12px 16px;font-family:'SF Mono','Menlo','Consolas',monospace;font-size:11.5px;line-height:1.7;color:#aaa;max-height:500px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;min-height:100px}
.console-output .line{margin-bottom:1px}
.console-output .line-err{color:var(--red)}
.console-output .line-ok{color:var(--green)}
.console-output .line-warn{color:var(--yellow)}
.console-output .line-head{color:var(--orange);font-weight:700}

/* Completeness Matrix */
.completeness-scroll{overflow-x:auto;margin-bottom:20px;border-radius:var(--radius-sm);border:1px solid #333}
.cmatrix{width:100%;border-collapse:collapse;min-width:900px}
.cmatrix th{padding:7px 8px;font-size:9px;text-transform:uppercase;color:var(--text2);font-weight:700;letter-spacing:.3px;text-align:center;background:var(--bg2);border-bottom:2px solid #333;white-space:nowrap;position:sticky;top:0;z-index:2}
.cmatrix th:first-child{text-align:left;min-width:120px}
.cmatrix td{padding:6px 8px;text-align:center;font-size:11px;border-bottom:1px solid #1a1f25;cursor:pointer;transition:background .15s;font-variant-numeric:tabular-nums}
.cmatrix td:hover{background:var(--bg3)}
.cmatrix td:first-child{text-align:left;font-weight:700;cursor:default}
.cmatrix td:first-child:hover{background:transparent}
.c-ok{color:var(--green)}
.c-warn{color:var(--yellow)}
.c-bad{color:var(--red)}
.c-zero{color:var(--text3)}

/* Mode Toggle */
.mode-toggle{display:flex;gap:0;background:var(--bg);border-radius:var(--radius-sm);overflow:hidden;border:1px solid #333;margin:8px 16px 8px 0;align-self:center;margin-right:auto}
.mode-toggle button{padding:6px 16px;background:none;border:none;color:var(--text2);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.5px}
.mode-toggle button.active{background:var(--orange);color:#fff}
.mode-toggle button:hover:not(.active){background:var(--bg3);color:var(--text)}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#555}
</style>
</head>
<body>

<div id="nav">
  <div class="nav-title">MONEYBALL</div>
  <div class="mode-toggle" id="mode-toggle">
    <button class="active" data-mode="organico">Orgánico</button>
    <button data-mode="meta_ads">Meta Ads</button>
  </div>
  <div class="nav-item active" data-view="overview">Overview</div>
  <div class="nav-item" data-view="videos">Videos</div>
  <div class="nav-item" data-view="scenes">Scenes</div>
  <div class="nav-item" data-view="analytics">Analytics</div>
  <div class="nav-item" data-view="compare">Compare</div>
  <div class="nav-item" data-view="activity">Activity</div>
  <div class="nav-item" data-view="pipeline" style="color:var(--orange)">Pipeline</div>
</div>

<div id="view-overview" class="view active"><div class="loading">Loading...</div></div>
<div id="view-videos" class="view"></div>
<div id="view-scenes" class="view"></div>
<div id="view-analytics" class="view"></div>
<div id="view-compare" class="view"></div>
<div id="view-activity" class="view"></div>
<div id="view-pipeline" class="view"></div>

<div id="overlay" class="overlay" onclick="closePopup()">
  <div class="popup" onclick="event.stopPropagation()"></div>
</div>

<script>
// ============ STATE ============
const S = {
  mode: 'organico',
  view: 'overview',
  creators: [],
  metaAdvertisers: [],
  colors: {},
  videos: { page: 1, creador: '', sort: 'visitas', order: 'DESC', search: '' },
  ads: { page: 1, anunciante: '', sort: 'created_at', order: 'DESC', search: '' },
  scenes: { page: 1, creador: '', video_id: 0 },
  analytics: { creador: '' },
  metaAnalytics: { anunciante: '' },
  charts: {},
  pipeline: { activeRun: null, eventSource: null, statusData: null, isBatch: false }
};

const PALETTE = ['#27ae60','#3498db','#8e44ad','#e67e22','#e74c3c','#f1c40f','#1abc9c','#c0392b','#2c3e50','#16a085','#d35400','#7d3c98'];

// ============ AUTH ============
const AUTH_TOKEN = localStorage.getItem('moneyball_token');
if (!AUTH_TOKEN) { window.location.href = '/login'; }
const AUTH_HEADERS = { 'Authorization': 'Bearer ' + AUTH_TOKEN };

// ============ UTILS ============
async function api(url) {
  const r = await fetch(url, { headers: AUTH_HEADERS });
  if (r.status === 401) { localStorage.removeItem('moneyball_token'); window.location.href = '/login'; return; }
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
function fmt(n) { return n == null ? '-' : Number(n).toLocaleString('es-ES'); }
function fmtK(n) { if (n == null) return '-'; if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return n.toString(); }
function trunc(s, len) { if (!s) return ''; return s.length > len ? s.slice(0, len) + '...' : s; }
function fmtTime(s) { const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${sec.toString().padStart(2,'0')}`; }
function getColor(c) { return S.colors[c] || '#555'; }

let _debounceTimer;
function debounce(fn, ms) { clearTimeout(_debounceTimer); _debounceTimer = setTimeout(fn, ms); }

function getFrameUrl(videoId, fotogramas) {
  if (Array.isArray(fotogramas) && fotogramas.length > 0) {
    const f = fotogramas[0];
    // Extract relative path after escenas_frames/
    const marker = 'escenas_frames/';
    const idx = f.indexOf(marker);
    if (idx !== -1) return '/frames/' + f.slice(idx + marker.length);
    // Fallback: just the filename
    const name = f.includes('/') ? f.split('/').pop() : f;
    return `/frames/video_${videoId}/${name}`;
  }
  return `/frames/video_${videoId}/frame_001.jpg`;
}

// ============ NAV ============
document.querySelectorAll('.nav-item').forEach(el => {
  el.addEventListener('click', () => switchView(el.dataset.view));
});

// Mode toggle
document.querySelectorAll('#mode-toggle button').forEach(btn => {
  btn.addEventListener('click', () => {
    if (S.mode === btn.dataset.mode) return;
    S.mode = btn.dataset.mode;
    document.querySelectorAll('#mode-toggle button').forEach(b => b.classList.toggle('active', b.dataset.mode === S.mode));
    updateTabsForMode();
    // Clear view caches so they reload with new mode
    document.querySelectorAll('.view').forEach(v => delete v.dataset.loaded);
    loadView(S.view);
  });
});

function updateTabsForMode() {
  const isMeta = S.mode === 'meta_ads';
  document.querySelectorAll('.nav-item').forEach(tab => {
    const v = tab.dataset.view;
    if (v === 'videos') tab.textContent = isMeta ? 'Ads' : 'Videos';
    if (v === 'scenes') tab.style.display = isMeta ? 'none' : '';
  });
  // If on hidden tab, go to overview
  if (isMeta && S.view === 'scenes') switchView('overview');
}

function switchView(v) {
  S.view = v;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === v));
  document.querySelectorAll('.view').forEach(n => n.classList.toggle('active', n.id === 'view-' + v));
  loadView(v);
}

function loadView(v) {
  const map = { overview: loadOverview, videos: loadVideos, scenes: loadScenes, analytics: loadAnalytics, compare: loadCompare, activity: loadActivity, pipeline: loadPipeline };
  if (map[v]) map[v]();
}

// ============ OVERVIEW ============
async function loadOverview() {
  if (S.mode === 'meta_ads') return loadOverviewMeta();
  const el = document.getElementById('view-overview');
  if (el.dataset.loaded && S.creators.length) return;
  el.innerHTML = '<div class="loading">Loading creators...</div>';
  try {
    const data = await api('/api/creators');
    S.creators = data.creators;
    S.creators.forEach((c, i) => { S.colors[c.creador] = PALETTE[i % PALETTE.length]; });
    if (!S.analytics.creador && S.creators.length) S.analytics.creador = S.creators[0].creador;

    el.innerHTML = `
      <h2 style="margin-bottom:4px">Creators Overview</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:16px">${S.creators.reduce((a,c)=>a+c.total_videos,0)} videos &middot; ${S.creators.reduce((a,c)=>a+c.total_escenas,0)} scenes &middot; ${S.creators.length} creators</p>
      <div class="cards-grid">${S.creators.map(creatorCard).join('')}</div>
    `;
    el.dataset.loaded = '1';
  } catch (e) { el.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

function pctColor(pct) {
  if (pct >= 80) return 'var(--green)';
  if (pct >= 50) return 'var(--yellow)';
  return 'var(--red)';
}

function creatorCard(c) {
  const col = getColor(c.creador);
  return `
  <div class="card" style="border-color:${col}55" onclick="goToCreator('${c.creador}')">
    <div class="card-header" style="flex-direction:column;align-items:flex-start;gap:8px">
      <h3>${c.creador}</h3>
      <div style="display:flex;gap:6px">
        <span class="badge" style="background:${col}33;color:${col}">${c.total_videos} videos</span>
        <span class="badge" style="background:var(--blue)22;color:var(--blue)">${fmt(c.total_escenas)} scenes</span>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat"><label>Avg Views</label><value>${fmtK(c.avg_visitas)}</value></div>
      <div class="stat"><label>Avg Likes</label><value>${fmtK(c.avg_likes)}</value></div>
      <div class="stat"><label>Avg Comments</label><value>${fmtK(c.avg_comentarios)}</value></div>
    </div>
    <div class="stats-row" style="margin-bottom:0">
      <div class="stat"><label>BBDD Videos</label><value style="font-size:15px;color:${pctColor(c.video_complete_pct)}">${c.video_complete_pct}%</value></div>
      <div class="stat"><label>BBDD Scenes</label><value style="font-size:15px;color:${pctColor(c.scene_complete_pct)}">${c.scene_complete_pct}%</value></div>
    </div>
  </div>`;
}

function goToCreator(c) {
  S.videos.creador = c;
  S.videos.page = 1;
  switchView('videos');
}

// ============ VIDEOS ============
async function loadVideos() {
  if (S.mode === 'meta_ads') return loadAds();
  const el = document.getElementById('view-videos');
  const { page, creador, sort, order, search } = S.videos;
  const params = new URLSearchParams({ page, limit: 50, sort, order });
  if (creador) params.set('creador', creador);
  if (search) params.set('search', search);

  el.innerHTML = videosFiltersHTML() + '<div class="loading">Loading videos...</div>';
  bindVideoFilters();

  try {
    const data = await api('/api/videos?' + params);
    el.innerHTML = videosFiltersHTML() + videosTableHTML(data) + paginationHTML(data, 'videosPage');
    bindVideoFilters();
  } catch (e) { el.innerHTML = videosFiltersHTML() + `<div class="empty">Error: ${e.message}</div>`; bindVideoFilters(); }
}

function videosFiltersHTML() {
  const opts = S.creators.map(c => `<option value="${c.creador}" ${S.videos.creador===c.creador?'selected':''}>${c.creador}</option>`).join('');
  return `
  <div class="filters">
    <select id="f-creador"><option value="">All Creators</option>${opts}</select>
    <select id="f-sort">
      <option value="visitas" ${S.videos.sort==='visitas'?'selected':''}>Views</option>
      <option value="likes" ${S.videos.sort==='likes'?'selected':''}>Likes</option>
      <option value="comentarios" ${S.videos.sort==='comentarios'?'selected':''}>Comments</option>
      <option value="fecha_publicacion" ${S.videos.sort==='fecha_publicacion'?'selected':''}>Date</option>
    </select>
    <select id="f-order">
      <option value="DESC" ${S.videos.order==='DESC'?'selected':''}>Desc</option>
      <option value="ASC" ${S.videos.order==='ASC'?'selected':''}>Asc</option>
    </select>
    <input id="f-search" type="text" placeholder="Search hook, transcript, description..." value="${S.videos.search}">
  </div>`;
}

function bindVideoFilters() {
  const cr = document.getElementById('f-creador');
  const so = document.getElementById('f-sort');
  const or = document.getElementById('f-order');
  const se = document.getElementById('f-search');
  if (cr) cr.onchange = () => { S.videos.creador = cr.value; S.videos.page = 1; loadVideos(); };
  if (so) so.onchange = () => { S.videos.sort = so.value; S.videos.page = 1; loadVideos(); };
  if (or) or.onchange = () => { S.videos.order = or.value; S.videos.page = 1; loadVideos(); };
  if (se) se.oninput = () => debounce(() => { S.videos.search = se.value; S.videos.page = 1; loadVideos(); }, 400);
}

function videosTableHTML(data) {
  if (!data.videos.length) return '<div class="empty">No videos found</div>';
  const rows = data.videos.map(v => `
    <tr onclick="openVideo(${v.id})">
      <td><span class="badge" style="background:${getColor(v.creador)}33;color:${getColor(v.creador)}">${v.creador}</span></td>
      <td style="color:var(--text2);white-space:nowrap">${v.fecha_publicacion || '-'}</td>
      <td class="cell-wide" title="${(v.hook||'').replace(/"/g,'&quot;')}">${trunc(v.hook, 60)}</td>
      <td class="num" style="font-weight:700">${fmtK(v.visitas)}</td>
      <td class="num">${fmtK(v.likes)}</td>
      <td class="num">${fmtK(v.comentarios)}</td>
      <td>${v.duracion || '-'}</td>
      <td class="cell-trunc" title="${(v.descripcion||'').replace(/"/g,'&quot;')}">${trunc(v.descripcion, 50) || '-'}</td>
      <td class="cell-trunc" title="${(v.transcripcion||'').replace(/"/g,'&quot;')}">${trunc(v.transcripcion, 50) || '-'}</td>
      <td class="cell-trunc" title="${(v.visual||'').replace(/"/g,'&quot;')}">${trunc(v.visual, 50) || '-'}</td>
      <td class="cell-trunc" title="${(v.tematica||'').replace(/"/g,'&quot;')}">${v.tematica || '-'}</td>
      <td class="cell-trunc" title="${(v.formula_hook||'').replace(/"/g,'&quot;')}"><span class="pattern-tag">${trunc(v.formula_hook,30) || '-'}</span></td>
      <td class="cell-trunc" title="${(v.semantica_inicio||'').replace(/"/g,'&quot;')}">${v.semantica_inicio || '-'}</td>
      <td class="cell-trunc" title="${(v.semantica_ruta||'').replace(/"/g,'&quot;')}">${trunc(v.semantica_ruta, 35) || '-'}</td>
      <td class="cell-trunc" title="${(v.semantica_cluster||'').replace(/"/g,'&quot;')}">${trunc(v.semantica_cluster, 30) || '-'}</td>
      <td class="cell-trunc" title="${(v.visual_inicio||'').replace(/"/g,'&quot;')}">${v.visual_inicio || '-'}</td>
      <td class="cell-trunc" title="${(v.visual_ruta||'').replace(/"/g,'&quot;')}">${trunc(v.visual_ruta, 35) || '-'}</td>
      <td class="cell-trunc" title="${(v.visual_cluster||'').replace(/"/g,'&quot;')}">${trunc(v.visual_cluster, 30) || '-'}</td>
      <td>${v.ejecutado || '-'}</td>
      <td class="cell-trunc" title="${(v.escenas_cortes||'').replace(/"/g,'&quot;')}">${trunc(v.escenas_cortes, 40) || '-'}</td>
      <td>${v.referente_para || '-'}</td>
    </tr>`).join('');

  return `<div class="table-scroll"><table>
    <thead><tr>
      <th>Creator</th><th>Date</th><th>Hook</th><th>Views</th><th>Likes</th><th>Cmts</th><th>Dur</th>
      <th>Descripcion</th><th>Transcripcion</th><th>Visual</th>
      <th>Tematica</th><th>Formula Hook</th><th>Sem. Inicio</th><th>Sem. Ruta</th><th>Sem. Cluster</th>
      <th>Visual Inicio</th><th>Visual Ruta</th><th>Visual Cluster</th>
      <th>Ejecutado</th><th>Escenas Cortes</th><th>Ref. Para</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function paginationHTML(data, fnName) {
  return `<div class="pagination">
    <button onclick="${fnName}(${data.page - 1})" ${data.page <= 1 ? 'disabled' : ''}>Prev</button>
    <span>Page ${data.page} of ${data.pages} (${fmt(data.total)} total)</span>
    <button onclick="${fnName}(${data.page + 1})" ${data.page >= data.pages ? 'disabled' : ''}>Next</button>
  </div>`;
}

function videosPage(p) { S.videos.page = p; loadVideos(); }

// ============ VIDEO DETAIL ============
async function openVideo(id) {
  const overlay = document.getElementById('overlay');
  const popup = overlay.querySelector('.popup');
  overlay.classList.add('active');
  popup.innerHTML = '<div class="loading" style="padding:60px">Loading...</div>';

  try {
    const data = await api('/api/videos/' + id);
    const v = data.video;
    const col = getColor(v.creador);
    popup.innerHTML = `
      <div class="popup-header" style="background:linear-gradient(135deg,${col},${col}88)">
        <div>
          <h2>${v.creador}</h2>
          <a href="${v.url}" target="_blank" style="color:#fff;opacity:.8;font-size:12px">${trunc(v.url,60)}</a>
        </div>
        <button class="popup-close" onclick="closePopup()">&times;</button>
      </div>
      <div class="popup-body">
        <div class="metrics-row">
          <div class="metric"><label>Views</label><value style="color:var(--green)">${fmt(v.visitas)}</value></div>
          <div class="metric"><label>Likes</label><value>${fmt(v.likes)}</value></div>
          <div class="metric"><label>Comments</label><value>${fmt(v.comentarios)}</value></div>
          <div class="metric"><label>Duration</label><value style="font-size:16px">${v.duracion || '-'}</value></div>
        </div>

        <div class="section">
          <h3>Hook</h3>
          <p style="color:var(--text);font-weight:600;margin-bottom:8px">${v.hook || 'N/A'}</p>
          <div class="tags">
            ${v.formula_hook ? `<span class="tag" style="background:${col}22;color:${col};border:1px solid ${col}55">Formula: ${v.formula_hook}</span>` : ''}
            ${v.semantica_inicio ? `<span class="tag" style="background:var(--blue)22;color:var(--blue);border:1px solid var(--blue)55">Sem: ${v.semantica_inicio}</span>` : ''}
            ${v.visual_inicio ? `<span class="tag" style="background:var(--purple)22;color:var(--purple);border:1px solid var(--purple)55">Visual: ${v.visual_inicio}</span>` : ''}
          </div>
        </div>

        ${v.semantica_ruta || v.visual_ruta ? `
        <div class="section">
          <h3>Patterns</h3>
          ${v.semantica_ruta ? `<p><strong style="color:var(--text)">Semantic route:</strong> ${v.semantica_ruta}</p>` : ''}
          ${v.visual_ruta ? `<p style="margin-top:6px"><strong style="color:var(--text)">Visual route:</strong> ${v.visual_ruta}</p>` : ''}
        </div>` : ''}

        ${v.transcripcion ? `
        <div class="section">
          <h3>Transcript <span style="font-weight:400;color:var(--text2);font-size:11px">(click to expand)</span></h3>
          <div class="transcript-box" onclick="this.classList.toggle('expanded')">${v.transcripcion}</div>
        </div>` : ''}

        ${data.scenes.length ? `
        <div class="section">
          <h3>Scenes (${data.scenes.length})</h3>
          <div class="detail-scenes">
            ${data.scenes.map(s => `
              <div class="detail-scene">
                <div class="detail-scene-thumb">
                  <img src="${getFrameUrl(s.id, s.fotogramas)}" alt="Scene ${s.escena_numero}" loading="lazy"
                       onerror="this.style.display='none'">
                </div>
                <div class="detail-scene-info">
                  <strong>Scene ${s.escena_numero}</strong> &middot; ${fmtTime(s.tiempo_inicio)} - ${fmtTime(s.tiempo_fin)} (${s.duracion_seg?.toFixed(1)}s)<br>
                  ${s.escenario ? `<span style="color:var(--blue)">${trunc(s.escenario, 40)}</span><br>` : ''}
                  ${trunc(s.descripcion_completa, 100)}
                </div>
              </div>
            `).join('')}
          </div>
        </div>` : ''}
      </div>
    `;
  } catch (e) { popup.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

function closePopup() { document.getElementById('overlay').classList.remove('active'); }
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePopup(); });

// ============ SCENES ============
async function loadScenes() {
  if (S.mode === 'meta_ads') {
    document.getElementById('view-scenes').innerHTML = '<div class="empty">Scenes no disponible en modo Meta Ads</div>';
    return;
  }
  const el = document.getElementById('view-scenes');
  const { page, creador, video_id } = S.scenes;
  const params = new URLSearchParams({ page, limit: 24 });
  if (creador) params.set('creador', creador);
  if (video_id) params.set('video_id', video_id);

  el.innerHTML = scenesFiltersHTML() + '<div class="loading">Loading scenes...</div>';
  bindSceneFilters();

  try {
    const data = await api('/api/scenes?' + params);
    el.innerHTML = scenesFiltersHTML() + scenesGridHTML(data) + paginationHTML(data, 'scenesPage');
    bindSceneFilters();
  } catch (e) { el.innerHTML = scenesFiltersHTML() + `<div class="empty">Error: ${e.message}</div>`; bindSceneFilters(); }
}

function scenesFiltersHTML() {
  const opts = S.creators.map(c => `<option value="${c.creador}" ${S.scenes.creador===c.creador?'selected':''}>${c.creador}</option>`).join('');
  return `<div class="filters">
    <select id="sf-creador"><option value="">All Creators</option>${opts}</select>
    ${S.scenes.video_id ? `<span class="badge" style="background:var(--blue)22;color:var(--blue)">Video ID: ${S.scenes.video_id} <span style="cursor:pointer" onclick="S.scenes.video_id=0;S.scenes.page=1;loadScenes();">&times;</span></span>` : ''}
  </div>`;
}

function bindSceneFilters() {
  const cr = document.getElementById('sf-creador');
  if (cr) cr.onchange = () => { S.scenes.creador = cr.value; S.scenes.page = 1; loadScenes(); };
}

function scenesGridHTML(data) {
  if (!data.scenes.length) return '<div class="empty">No scenes found</div>';
  return `<div class="scenes-grid">${data.scenes.map(s => `
    <div class="scene-card" onclick="openVideo(${s.video_id})">
      <div class="scene-thumb">
        <img src="${getFrameUrl(s.video_id, s.fotogramas)}" alt="Scene" loading="lazy" onerror="this.parentElement.style.background='#222'">
      </div>
      <div class="scene-info">
        <div class="scene-meta">
          <span class="badge" style="background:${getColor(s.creador)}33;color:${getColor(s.creador)};font-size:10px">${s.creador}</span>
          <span style="font-size:11px;color:var(--text2)">${fmtTime(s.tiempo_inicio)}-${fmtTime(s.tiempo_fin)}</span>
        </div>
        ${s.escenario ? `<div style="font-size:11px;color:var(--blue);margin-bottom:4px">${trunc(s.escenario,40)}</div>` : ''}
        <div class="scene-desc">${trunc(s.descripcion_completa, 90)}</div>
      </div>
    </div>
  `).join('')}</div>`;
}

function scenesPage(p) { S.scenes.page = p; loadScenes(); }

// ============ ANALYTICS ============
async function loadAnalytics() {
  if (S.mode === 'meta_ads') return loadAnalyticsMeta();
  const el = document.getElementById('view-analytics');
  if (!S.analytics.creador && S.creators.length) S.analytics.creador = S.creators[0].creador;
  const c = S.analytics.creador;
  if (!c) { el.innerHTML = '<div class="empty">No creators loaded</div>'; return; }

  const opts = S.creators.map(cr => `<option value="${cr.creador}" ${c===cr.creador?'selected':''}>${cr.creador}</option>`).join('');
  el.innerHTML = `
    <div class="analytics-header">
      <h2>MoneyBall Analytics</h2>
      <select id="a-creador">${opts}</select>
    </div>
    <div class="chart-container"><h3>Formula Hook — Success Rate vs Avg Views</h3><div class="chart-wrap"><canvas id="chart-hooks"></canvas></div></div>
    <div class="chart-container"><h3>Semantica Inicio — Success Rate vs Avg Views</h3><div class="chart-wrap"><canvas id="chart-sem"></canvas></div></div>
    <div class="chart-container"><h3>Visual Inicio — Success Rate vs Avg Views</h3><div class="chart-wrap"><canvas id="chart-vis"></canvas></div></div>
  `;

  document.getElementById('a-creador').onchange = (e) => { S.analytics.creador = e.target.value; loadAnalytics(); };

  // Destroy old charts
  Object.values(S.charts).forEach(ch => ch.destroy());
  S.charts = {};

  const [hooks, sem, vis] = await Promise.all([
    api(`/api/analytics/hooks?creador=${encodeURIComponent(c)}`),
    api(`/api/analytics/semantica?creador=${encodeURIComponent(c)}`),
    api(`/api/analytics/visual?creador=${encodeURIComponent(c)}`)
  ]);

  renderBarChart('chart-hooks', hooks.patterns, 'formula_hook', hooks.p75);
  renderBarChart('chart-sem', sem.patterns, 'semantica_inicio', sem.p75);
  renderBarChart('chart-vis', vis.patterns, 'visual_inicio', vis.p75);
}

function renderBarChart(canvasId, patterns, labelKey, p75) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const top15 = patterns.slice(0, 15);
  const labels = top15.map(p => trunc(p[labelKey], 25));
  const barColors = top15.map(p => p.tasa_exito >= 25 ? '#27ae6099' : p.tasa_exito < 15 ? '#e74c3c99' : '#3498db99');
  const borderColors = top15.map(p => p.tasa_exito >= 25 ? '#27ae60' : p.tasa_exito < 15 ? '#e74c3c' : '#3498db');

  S.charts[canvasId] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Success Rate (%)',
          data: top15.map(p => p.tasa_exito),
          backgroundColor: barColors,
          borderColor: borderColors,
          borderWidth: 2,
          yAxisID: 'y'
        },
        {
          label: 'Avg Views (K)',
          data: top15.map(p => Math.round(p.avg_visitas / 1000)),
          backgroundColor: '#f1c40f44',
          borderColor: '#f1c40f',
          borderWidth: 2,
          yAxisID: 'y1',
          type: 'line',
          tension: 0.3,
          pointRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#e8e8e8', font: { size: 11 } } },
        tooltip: {
          callbacks: {
            afterBody: (items) => {
              const idx = items[0]?.dataIndex;
              if (idx == null) return '';
              const p = top15[idx];
              return `Count: ${p.total}\nP75: ${fmtK(p75)}`;
            }
          }
        }
      },
      scales: {
        x: { ticks: { color: '#888', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#222' } },
        y: { position: 'left', title: { display: true, text: 'Success Rate (%)', color: '#888' }, ticks: { color: '#888' }, grid: { color: '#222' }, beginAtZero: true },
        y1: { position: 'right', title: { display: true, text: 'Avg Views (K)', color: '#888' }, ticks: { color: '#f1c40f' }, grid: { display: false }, beginAtZero: true }
      }
    }
  });
}

// ============ COMPARE ============
async function loadCompare() {
  if (S.mode === 'meta_ads') return loadCompareMeta();
  const el = document.getElementById('view-compare');
  el.innerHTML = '<div class="loading">Loading comparison...</div>';

  try {
    const data = await api('/api/analytics/compare');
    const comp = data.comparison;

    el.innerHTML = `
      <h2 style="margin-bottom:16px">Creator Comparison</h2>
      <div class="chart-container">
        <h3>Performance Radar</h3>
        <div class="compare-controls" id="compare-checks">
          ${comp.map(c => `<label><input type="checkbox" value="${c.creador}" checked> <span style="color:${getColor(c.creador)}">${c.creador}</span></label>`).join('')}
        </div>
        <div class="radar-wrap"><canvas id="chart-radar"></canvas></div>
      </div>
      <div class="chart-container">
        <h3>Metrics Table</h3>
        <table class="compare-table">
          <thead><tr><th>Creator</th><th>Videos</th><th>Avg Views</th><th>P75</th><th>Max Views</th><th>Avg Likes</th><th>Avg Comments</th><th>Scenes</th><th>Hook Rate</th></tr></thead>
          <tbody>
            ${comp.map(c => `<tr>
              <td><span class="badge" style="background:${getColor(c.creador)}33;color:${getColor(c.creador)}">${c.creador}</span></td>
              <td>${fmt(c.total_videos)}</td>
              <td>${fmtK(c.avg_visitas)}</td>
              <td style="color:var(--green);font-weight:700">${fmtK(c.p75)}</td>
              <td>${fmtK(c.max_visitas)}</td>
              <td>${fmtK(c.avg_likes)}</td>
              <td>${fmtK(c.avg_comentarios)}</td>
              <td>${fmt(c.total_escenas)}</td>
              <td>${c.hook_success_rate}%</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    `;

    // Radar chart
    renderRadar(comp);

    // Bind checkbox changes
    document.getElementById('compare-checks').addEventListener('change', () => {
      const selected = [...document.querySelectorAll('#compare-checks input:checked')].map(i => i.value);
      const filtered = comp.filter(c => selected.includes(c.creador));
      if (S.charts['radar']) S.charts['radar'].destroy();
      renderRadar(filtered);
    });
  } catch (e) { el.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

function renderRadar(comp) {
  const canvas = document.getElementById('chart-radar');
  if (!canvas) return;

  const maxViews = Math.max(...comp.map(c => c.avg_visitas || 1));
  const maxLikes = Math.max(...comp.map(c => c.avg_likes || 1));
  const maxComments = Math.max(...comp.map(c => c.avg_comentarios || 1));
  const maxVideos = Math.max(...comp.map(c => c.total_videos || 1));

  S.charts['radar'] = new Chart(canvas.getContext('2d'), {
    type: 'radar',
    data: {
      labels: ['Avg Views', 'Avg Likes', 'Avg Comments', 'Volume', 'Hook Success'],
      datasets: comp.map(c => ({
        label: c.creador,
        data: [
          (c.avg_visitas / maxViews * 100).toFixed(1),
          (c.avg_likes / maxLikes * 100).toFixed(1),
          (c.avg_comentarios / maxComments * 100).toFixed(1),
          (c.total_videos / maxVideos * 100).toFixed(1),
          c.hook_success_rate
        ],
        borderColor: getColor(c.creador),
        backgroundColor: getColor(c.creador) + '22',
        borderWidth: 2,
        pointRadius: 3
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { labels: { color: '#e8e8e8', font: { size: 11 } } } },
      scales: {
        r: {
          beginAtZero: true, max: 100,
          ticks: { color: '#888', backdropColor: 'transparent' },
          grid: { color: '#333' },
          angleLines: { color: '#333' },
          pointLabels: { color: '#e8e8e8', font: { size: 11 } }
        }
      }
    }
  });
}

// ============ ACTIVITY ============
S.activity = { group: 'day' };

async function loadActivity() {
  const el = document.getElementById('view-activity');
  const g = S.activity.group;
  el.innerHTML = '<div class="loading">Loading activity...</div>';

  try {
    const data = await api(`/api/activity?group=${g}`);
    const t = data.totals;

    // Build creator breakdown per period
    const periodCreators = {};
    for (const r of data.videosAdded) {
      if (!periodCreators[r.period]) periodCreators[r.period] = {};
      if (!periodCreators[r.period][r.creador]) periodCreators[r.period][r.creador] = { added: 0, updated: 0, scenes: 0 };
      periodCreators[r.period][r.creador].added = r.videos_added;
    }
    for (const r of data.videosUpdated) {
      if (!periodCreators[r.period]) periodCreators[r.period] = {};
      if (!periodCreators[r.period][r.creador]) periodCreators[r.period][r.creador] = { added: 0, updated: 0, scenes: 0 };
      periodCreators[r.period][r.creador].updated = r.videos_updated;
    }
    for (const r of data.scenesAdded) {
      if (!periodCreators[r.period]) periodCreators[r.period] = {};
      if (!periodCreators[r.period][r.creador]) periodCreators[r.period][r.creador] = { added: 0, updated: 0, scenes: 0 };
      periodCreators[r.period][r.creador].scenes = r.scenes_added;
    }

    const maxAdded = Math.max(...data.summary.map(s => s.total_videos), 1);

    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
        <h2>Activity Log</h2>
        <div class="group-toggle">
          <button class="${g==='day'?'active':''}" onclick="S.activity.group='day';loadActivity()">Day</button>
          <button class="${g==='week'?'active':''}" onclick="S.activity.group='week';loadActivity()">Week</button>
          <button class="${g==='month'?'active':''}" onclick="S.activity.group='month';loadActivity()">Month</button>
        </div>
      </div>

      <div class="totals-grid">
        <div class="total-card"><label>Total Videos</label><value style="color:var(--green)">${fmt(t.videos)}</value></div>
        <div class="total-card"><label>Total Scenes</label><value style="color:var(--blue)">${fmt(t.scenes)}</value></div>
        <div class="total-card"><label>Creators</label><value style="color:var(--purple)">${t.creators}</value></div>
        <div class="total-card"><label>Meta Ads</label><value style="color:var(--orange)">${fmt(t.meta_ads)}</value></div>
        <div class="total-card"><label>Embeddings (V)</label><value style="color:var(--yellow)">${fmt(t.embeddings_videos)}</value></div>
        <div class="total-card"><label>Embeddings (S)</label><value style="color:var(--yellow)">${fmt(t.embeddings_scenes)}</value></div>
      </div>

      <div class="chart-container">
        <h3>Activity Over Time</h3>
        <div class="chart-wrap" style="height:250px"><canvas id="chart-activity"></canvas></div>
      </div>

      <h3 style="margin-bottom:12px;font-size:14px;color:var(--text2)">Detail by Period</h3>
      <div class="timeline">
        ${data.summary.map(s => {
          const creators = periodCreators[s.period] || {};
          const sorted = Object.entries(creators).sort((a,b) => (b[1].added + b[1].scenes) - (a[1].added + a[1].scenes));
          return `
          <div class="timeline-period">
            <div class="timeline-period-header">
              <h3>${s.period}</h3>
              <div class="period-totals">
                <span class="period-stat"><strong style="color:var(--green)">+${fmt(s.total_videos)}</strong> videos</span>
                <span class="period-stat"><strong style="color:var(--blue)">+${fmt(s.total_scenes)}</strong> scenes</span>
                ${s.total_updated ? `<span class="period-stat"><strong style="color:var(--orange)">${fmt(s.total_updated)}</strong> updated</span>` : ''}
                <span class="period-stat">${s.creators_active} creators</span>
              </div>
            </div>
            <div class="creator-rows">
              ${sorted.map(([c, d]) => {
                const total = d.added + d.scenes;
                const maxBar = Math.max(...sorted.map(([,x]) => x.added + x.scenes), 1);
                const pct = (total / maxBar * 100).toFixed(0);
                return `<div class="creator-row">
                  <span class="row-label" style="color:${getColor(c)}">${c}</span>
                  <div class="bar-wrap"><div class="bar" style="width:${pct}%;background:${getColor(c)}"></div></div>
                  <span class="row-nums">+${d.added} vids &middot; +${d.scenes} scenes${d.updated ? ` &middot; ${d.updated} upd` : ''}</span>
                </div>`;
              }).join('')}
            </div>
          </div>`;
        }).join('')}
      </div>
    `;

    // Render timeline chart
    renderActivityChart(data.summary);
  } catch (e) { el.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

function renderActivityChart(summary) {
  const canvas = document.getElementById('chart-activity');
  if (!canvas) return;
  if (S.charts['activity']) S.charts['activity'].destroy();

  const reversed = [...summary].reverse();
  S.charts['activity'] = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: reversed.map(s => s.period),
      datasets: [
        {
          label: 'Videos Added',
          data: reversed.map(s => s.total_videos),
          backgroundColor: '#27ae6099',
          borderColor: '#27ae60',
          borderWidth: 2
        },
        {
          label: 'Scenes Added',
          data: reversed.map(s => s.total_scenes),
          backgroundColor: '#3498db44',
          borderColor: '#3498db',
          borderWidth: 2,
          type: 'line',
          tension: 0.3,
          pointRadius: 4,
          yAxisID: 'y1'
        },
        {
          label: 'Videos Updated',
          data: reversed.map(s => s.total_updated),
          backgroundColor: '#e67e2266',
          borderColor: '#e67e22',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { labels: { color: '#e8e8e8', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#888' }, grid: { color: '#222' } },
        y: { position: 'left', title: { display: true, text: 'Videos', color: '#888' }, ticks: { color: '#888' }, grid: { color: '#222' }, beginAtZero: true },
        y1: { position: 'right', title: { display: true, text: 'Scenes', color: '#3498db' }, ticks: { color: '#3498db' }, grid: { display: false }, beginAtZero: true }
      }
    }
  });
}

// ============ PIPELINE ============
const ALL_PHASES = ['refresh_stats','transcripcion','semantica','visual_analysis','escenas','analyze_escenas','frames','embeddings','emb_escenas'];
const PHASE_LABELS = {
  refresh_stats: '📊 Refresh Stats', transcripcion: 'Transcripción', semantica: 'Semántica',
  visual_analysis: 'Visual Analysis', escenas: 'Escenas (parse)', analyze_escenas: 'Analyze Escenas',
  frames: 'Frames', embeddings: 'Embeddings', emb_escenas: 'Emb. Escenas'
};

async function loadPipeline() {
  if (S.mode === 'meta_ads') return loadPipelineMeta();
  const el = document.getElementById('view-pipeline');
  el.innerHTML = '<div class="loading">Loading pipeline status...</div>';

  try {
    // Fetch status + runs in parallel
    const [data, runsData] = await Promise.all([
      api('/api/pipeline/status'),
      api('/api/pipeline/runs')
    ]);
    S.pipeline.statusData = data;

    // Check if there's a running pipeline we should reconnect to
    const activeRun = runsData.runs.find(r => r.status === 'running');
    const lastRun = runsData.runs[0]; // sorted by startedAt DESC

    el.innerHTML = `
      <h2 style="margin-bottom:4px">Pipeline</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:16px">Ejecuta fases del pipeline sobre tus videos desde aquí</p>
      ${completenessHTML(data)}
      ${pipelineConfigHTML(data)}
      ${pipelineConsoleHTML()}
      ${pipelineRunsHistoryHTML(runsData.runs)}
    `;

    bindPipelineControls();

    // Auto-reconnect to active run or batch
    if (activeRun) {
      if (activeRun.isBatch) {
        // Reconnect to batch stream
        S.pipeline.activeRun = activeRun.runId;
        S.pipeline.isBatch = true;
        updatePipelineStatus('running', `Batch en ejecución — ${activeRun.workers} workers en paralelo...`);
        document.getElementById('btn-run').disabled = true;
        document.getElementById('btn-dryrun').disabled = true;
        document.getElementById('btn-cancel').disabled = false;
        connectToBatchStream(activeRun.runId);
      } else {
        S.pipeline.activeRun = activeRun.runId;
        S.pipeline.isBatch = false;
        updatePipelineStatus('running', `Pipeline en ejecución... (${activeRun.args.join(' ')})`);
        document.getElementById('btn-run').disabled = true;
        document.getElementById('btn-dryrun').disabled = true;
        document.getElementById('btn-cancel').disabled = false;
        connectToStream(activeRun.runId);
      }
    } else if (lastRun && !activeRun) {
      // Show last completed run's status
      const isBatch = lastRun.isBatch;
      const statusLabel = lastRun.status === 'completed' ? (isBatch ? 'Batch completado' : 'Completado') :
                          lastRun.status === 'failed' ? (isBatch ? 'Batch con errores' : 'Error') :
                          lastRun.status === 'cancelled' ? (isBatch ? 'Batch cancelado' : 'Cancelado') : lastRun.status;
      const timeAgo = getTimeAgo(lastRun.endedAt || lastRun.startedAt);
      updatePipelineStatus(lastRun.status, `Último: ${statusLabel} (exit ${lastRun.exitCode}) — ${timeAgo}`);
    }
  } catch (e) { el.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

function getTimeAgo(dateStr) {
  if (!dateStr) return '';
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'hace unos segundos';
  if (mins < 60) return `hace ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `hace ${hrs}h ${mins % 60}m`;
  return `hace ${Math.floor(hrs / 24)}d`;
}

function pipelineRunsHistoryHTML(runs) {
  if (!runs || runs.length === 0) return '';
  const recent = runs.slice(0, 5);
  const statusIcon = { completed: '✅', failed: '❌', cancelled: '⛔', running: '🔄' };
  const rows = recent.map(r => {
    const icon = statusIcon[r.status] || '❓';
    const time = r.startedAt ? new Date(r.startedAt).toLocaleString('es-ES', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }) : '-';
    const args = r.args.filter(a => !a.startsWith('--dry')).join(' ');
    const batchLabel = r.isBatch ? `<span style="color:var(--orange);font-size:10px;margin-left:4px">⚡${r.workers}w</span>` : '';
    return `<tr style="cursor:pointer" onclick="reconnectRun('${r.runId}', ${!!r.isBatch})">
      <td style="font-size:12px">${icon} ${r.status}${batchLabel}</td>
      <td style="font-size:11px;color:var(--text2)">${time}</td>
      <td style="font-size:11px;color:var(--text2)" class="cell-trunc" title="${args}">${trunc(args, 60)}</td>
      <td style="font-size:11px;color:var(--text2)">${r.outputLines} lines</td>
      <td style="font-size:11px;color:var(--text2)">${r.status === 'running' ? '<span style="color:var(--green)">● LIVE</span>' : `exit ${r.exitCode}`}</td>
    </tr>`;
  }).join('');

  return `
    <div style="margin-top:20px">
      <h3 style="font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px">Historial de ejecuciones</h3>
      <div class="table-scroll" style="border:1px solid #333;border-radius:var(--radius-sm)">
        <table style="width:100%;min-width:600px">
          <thead><tr>
            <th style="font-size:10px;padding:8px;text-align:left">Estado</th>
            <th style="font-size:10px;padding:8px;text-align:left">Fecha</th>
            <th style="font-size:10px;padding:8px;text-align:left">Args</th>
            <th style="font-size:10px;padding:8px;text-align:left">Output</th>
            <th style="font-size:10px;padding:8px;text-align:left">Exit</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
}

function reconnectRun(runId, isBatch) {
  S.pipeline.activeRun = runId;
  S.pipeline.isBatch = !!isBatch;
  document.getElementById('console-output').innerHTML = '';
  updatePipelineStatus('running', 'Cargando output...');
  if (isBatch) {
    connectToBatchStream(runId);
  } else {
    connectToStream(runId);
  }
}

function completenessHTML(data) {
  const fields = [
    { key: 'sin_visitas', label: 'Views' },
    { key: 'sin_likes', label: 'Likes' },
    { key: 'sin_comentarios', label: 'Cmts' },
    { key: 'sin_duracion', label: 'Dur' },
    { key: 'sin_fecha', label: 'Fecha' },
    { key: 'sin_descripcion', label: 'Desc' },
    { key: 'sin_transcripcion', label: 'Trans' },
    { key: 'sin_visual', label: 'Visual' },
    { key: 'sin_hook', label: 'Hook' },
    { key: 'sin_tematica', label: 'Tema' },
    { key: 'sin_formula_hook', label: 'F.Hook' },
    { key: 'sin_sem_inicio', label: 'Sem.I' },
    { key: 'sin_sem_ruta', label: 'Sem.R' },
    { key: 'sin_sem_cluster', label: 'Sem.C' },
    { key: 'sin_vis_inicio', label: 'Vis.I' },
    { key: 'sin_vis_ruta', label: 'Vis.R' },
    { key: 'sin_vis_cluster', label: 'Vis.C' },
    { key: 'sin_escenas', label: 'Escenas' },
    { key: 'sin_embedding', label: 'Emb' },
    { key: 'sin_analisis_escenas', label: 'An.Esc' },
    { key: 'sin_emb_escena', label: 'Emb.Esc' },
  ];

  const fieldToPhase = {
    sin_visitas: 'refresh_stats', sin_likes: 'refresh_stats', sin_comentarios: 'refresh_stats',
    sin_duracion: 'refresh_stats', sin_fecha: 'refresh_stats', sin_descripcion: 'refresh_stats',
    sin_transcripcion: 'transcripcion', sin_visual: 'transcripcion',
    sin_hook: 'semantica', sin_tematica: 'semantica', sin_formula_hook: 'semantica',
    sin_sem_inicio: 'semantica', sin_sem_ruta: 'semantica', sin_sem_cluster: 'semantica',
    sin_vis_inicio: 'visual_analysis', sin_vis_ruta: 'visual_analysis', sin_vis_cluster: 'visual_analysis',
    sin_escenas: 'escenas', sin_embedding: 'embeddings',
    sin_analisis_escenas: 'analyze_escenas', sin_emb_escena: 'emb_escenas'
  };

  const rows = data.creators.map(c => {
    const cells = fields.map(f => {
      const v = c[f.key] || 0;
      const total = f.key.includes('escena') ? (c.total_escenas || 1) : c.total;
      const pct = total > 0 ? v / total : 0;
      const cls = v === 0 ? 'c-zero' : pct > 0.5 ? 'c-bad' : pct > 0.1 ? 'c-warn' : 'c-ok';
      const phase = fieldToPhase[f.key] || '';
      return `<td class="${cls}" onclick="prefillPipeline('${c.creador}','${phase}')" title="${c.creador}: ${v}/${total} sin ${f.label}">${v === 0 ? '✓' : v}</td>`;
    }).join('');
    const col = getColor(c.creador);
    return `<tr><td><span style="color:${col}">${c.creador}</span> <span style="color:var(--text3);font-size:10px">(${c.total})</span></td>${cells}</tr>`;
  }).join('');

  return `
    <div class="completeness-scroll">
      <table class="cmatrix">
        <thead><tr>
          <th>Creator</th>
          ${fields.map(f => `<th>${f.label}</th>`).join('')}
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

function pipelineConfigHTML(data) {
  const creatorOpts = data.creators.map(c => `<option value="${c.creador}">${c.creador} (${c.total})</option>`).join('');
  const ctxOpts = data.contextFiles.map(f => `<option value="${f}">${f}</option>`).join('');

  const phaseToggles = ALL_PHASES.map(p =>
    `<div class="phase-btn active" onclick="togglePhase(this)" data-phase="${p}"><input type="checkbox" checked> ${PHASE_LABELS[p]||p}</div>`
  ).join('');

  return `
    <div class="pipeline-config">
      <h3 style="margin-bottom:14px;font-size:14px;font-weight:700">Configuración</h3>
      <div class="config-grid">
        <div class="config-group">
          <label class="config-label">Creator</label>
          <select id="p-creador"><option value="">— Todos —</option>${creatorOpts}</select>
        </div>
        <div class="config-group">
          <label class="config-label">Video IDs</label>
          <input id="p-ids" placeholder="100,101,102">
        </div>
        <div class="config-group">
          <label class="config-label">WHERE SQL</label>
          <input id="p-where" placeholder="visitas > 10000">
        </div>
        <div class="config-group">
          <label class="config-label">Limit</label>
          <input id="p-limit" type="number" placeholder="Sin límite" min="1">
        </div>
        <div class="config-group full-width">
          <label class="config-label">Fases</label>
          <div class="phase-toggles" id="p-phases">${phaseToggles}</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button style="background:var(--bg);color:var(--text2);border:1px solid #333;border-radius:6px;padding:4px 12px;font-size:10px;cursor:pointer" onclick="toggleAllPhases(true)">All</button>
            <button style="background:var(--bg);color:var(--text2);border:1px solid #333;border-radius:6px;padding:4px 12px;font-size:10px;cursor:pointer" onclick="toggleAllPhases(false)">None</button>
          </div>
        </div>
        <div class="config-group">
          <label class="config-label">Context File</label>
          <select id="p-context-file"><option value="">— Ninguno —</option>${ctxOpts}</select>
        </div>
        <div class="config-group">
          <label class="config-label">Context (inline)</label>
          <textarea id="p-context" rows="2" placeholder="Texto de contexto para los prompts de IA..." style="resize:vertical"></textarea>
        </div>
        <div class="config-group">
          <label class="config-label">Workers en paralelo</label>
          <div style="display:flex;align-items:center;gap:10px">
            <select id="p-workers" style="width:80px">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4" selected>4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
            <span style="font-size:11px;color:var(--text3)">Divide los videos entre N procesos simultáneos</span>
          </div>
        </div>
      </div>
      <div class="config-actions">
        <button class="run-btn" id="btn-run" onclick="startPipeline(false)">▶ Run Pipeline</button>
        <button class="dryrun-btn" id="btn-dryrun" onclick="startPipeline(true)">Dry Run</button>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer;margin-left:12px">
          <input type="checkbox" id="p-force-stats" style="accent-color:var(--orange)"> Force refresh stats (actualizar aunque ya tengan datos)
        </label>
      </div>
    </div>`;
}

function pipelineConsoleHTML() {
  const isRunning = S.pipeline.activeRun != null;
  return `
    <div class="pipeline-console">
      <div class="console-header">
        <div class="console-status">
          <span class="status-dot" id="p-dot"></span>
          <span id="p-status">Sin ejecución activa</span>
        </div>
        <div class="console-actions">
          <button class="cancel-btn" id="btn-cancel" onclick="cancelPipeline()" ${isRunning ? '' : 'disabled'}>Cancel</button>
          <button onclick="document.getElementById('console-output').innerHTML=''">Clear</button>
        </div>
      </div>
      <div class="console-output" id="console-output"></div>
    </div>`;
}

function bindPipelineControls() {
  // Phase toggles visual state is handled by onclick
}

function togglePhase(el) {
  el.classList.toggle('active');
  const cb = el.querySelector('input');
  cb.checked = !cb.checked;
}

function toggleAllPhases(on) {
  document.querySelectorAll('#p-phases .phase-btn').forEach(el => {
    el.classList.toggle('active', on);
    el.querySelector('input').checked = on;
  });
}

function getSelectedPhases() {
  return [...document.querySelectorAll('#p-phases .phase-btn.active')].map(el => el.dataset.phase);
}

function prefillPipeline(creador, phase) {
  const cs = document.getElementById('p-creador');
  if (cs) cs.value = creador;
  if (phase) {
    // Uncheck all, then check only this phase
    toggleAllPhases(false);
    const el = document.querySelector(`#p-phases .phase-btn[data-phase="${phase}"]`);
    if (el) { el.classList.add('active'); el.querySelector('input').checked = true; }
  }
  document.querySelector('.pipeline-config').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function startPipeline(dryRun) {
  const creador = document.getElementById('p-creador').value;
  const ids = document.getElementById('p-ids').value.trim();
  const where = document.getElementById('p-where').value.trim();

  if (!creador && !ids && !where) {
    alert('Necesitas al menos un filtro: Creator, IDs, o WHERE');
    return;
  }

  const body = {};
  if (creador) body.creador = creador;
  if (ids) body.ids = ids.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
  if (where) body.where = where;

  const phases = getSelectedPhases();
  if (phases.length < ALL_PHASES.length) body.only = phases;

  const ctx = document.getElementById('p-context').value.trim();
  if (ctx) body.context = ctx;
  const ctxFile = document.getElementById('p-context-file').value;
  if (ctxFile) body.contextFile = ctxFile;
  const limit = document.getElementById('p-limit').value;
  if (limit) body.limit = parseInt(limit);
  const workers = parseInt(document.getElementById('p-workers')?.value || '1');
  if (workers > 1) body.workers = workers;
  if (dryRun) body.dryRun = true;
  const forceStats = document.getElementById('p-force-stats')?.checked;
  if (forceStats) body.forceStats = true;

  // Disable buttons
  document.getElementById('btn-run').disabled = true;
  document.getElementById('btn-dryrun').disabled = true;
  document.getElementById('btn-cancel').disabled = false;

  // Clear console
  document.getElementById('console-output').innerHTML = '';
  const statusMsg = workers > 1
    ? (dryRun ? `Dry run (${workers} workers)...` : `Pipeline en ejecución — ${workers} workers en paralelo...`)
    : (dryRun ? 'Dry run en curso...' : 'Pipeline en ejecución...');
  updatePipelineStatus('running', statusMsg);

  try {
    const res = await fetch('/api/pipeline/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...AUTH_HEADERS },
      body: JSON.stringify(body)
    });
    const result = await res.json();

    if (!res.ok) {
      updatePipelineStatus('failed', result.error || 'Error al iniciar');
      document.getElementById('btn-run').disabled = false;
      document.getElementById('btn-dryrun').disabled = false;
      document.getElementById('btn-cancel').disabled = true;
      return;
    }

    if (result.batchId) {
      // Parallel batch — connect to merged batch stream
      S.pipeline.activeRun = result.batchId;
      S.pipeline.isBatch = true;
      appendConsoleLine(`🚀 Batch iniciado: ${result.workers} workers en paralelo`);
      for (let i = 0; i < result.workers; i++) {
        appendConsoleLine(`  Worker ${i}: mod=${result.workers} part=${i}`);
      }
      appendConsoleLine('─'.repeat(50));
      connectToBatchStream(result.batchId);
    } else {
      // Single run
      S.pipeline.activeRun = result.runId;
      S.pipeline.isBatch = false;
      connectToStream(result.runId);
    }
  } catch (e) {
    updatePipelineStatus('failed', 'Error: ' + e.message);
    document.getElementById('btn-run').disabled = false;
    document.getElementById('btn-dryrun').disabled = false;
    document.getElementById('btn-cancel').disabled = true;
  }
}

function connectToStream(runId) {
  if (S.pipeline.eventSource) {
    S.pipeline.eventSource.close();
    S.pipeline.eventSource = null;
  }

  const es = new EventSource('/api/pipeline/stream/' + runId + '?token=' + AUTH_TOKEN);
  S.pipeline.eventSource = es;

  es.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'log') {
      appendConsoleLine(data.text);
    } else if (data.type === 'done') {
      const label = data.status === 'completed' ? 'Completado' : data.status === 'cancelled' ? 'Cancelado' : 'Error';
      updatePipelineStatus(data.status, `${label} (exit ${data.exitCode})`);
      document.getElementById('btn-run').disabled = false;
      document.getElementById('btn-dryrun').disabled = false;
      document.getElementById('btn-cancel').disabled = true;
      S.pipeline.activeRun = null;
      es.close();
      S.pipeline.eventSource = null;
      // Refresh completeness matrix
      refreshCompleteness();
    }
  };

  es.onerror = (e) => {
    // If we lost connection but run was active, show reconnect hint
    if (S.pipeline.activeRun) {
      updatePipelineStatus('failed', 'Conexión perdida — recarga la página para reconectar');
    }
    es.close();
    S.pipeline.eventSource = null;
  };
}

function connectToBatchStream(batchId) {
  if (S.pipeline.eventSource) {
    S.pipeline.eventSource.close();
    S.pipeline.eventSource = null;
  }

  const es = new EventSource('/api/pipeline/stream/batch/' + batchId + '?token=' + AUTH_TOKEN);
  S.pipeline.eventSource = es;

  es.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'log') {
      appendConsoleLine(data.text);
    } else if (data.type === 'done') {
      const label = data.status === 'completed' ? 'Batch completado' : data.status === 'cancelled' ? 'Batch cancelado' : 'Batch con errores';
      updatePipelineStatus(data.status, label);
      document.getElementById('btn-run').disabled = false;
      document.getElementById('btn-dryrun').disabled = false;
      document.getElementById('btn-cancel').disabled = true;
      S.pipeline.activeRun = null;
      S.pipeline.isBatch = false;
      es.close();
      S.pipeline.eventSource = null;
      refreshCompleteness();
    }
  };

  es.onerror = (e) => {
    if (S.pipeline.activeRun) {
      updatePipelineStatus('failed', 'Conexión perdida — recarga la página para reconectar');
    }
    es.close();
    S.pipeline.eventSource = null;
  };
}

const WORKER_COLORS = ['#27ae60','#3498db','#e67e22','#e74c3c','#8e44ad','#f1c40f','#1abc9c','#d35400','#c0392b','#16a085'];

function appendConsoleLine(text) {
  const output = document.getElementById('console-output');
  if (!output) return;
  const div = document.createElement('div');
  div.className = 'line';

  if (text.includes('❌') || text.includes('Error') || text.includes('[stderr]')) div.className += ' line-err';
  else if (text.includes('✅') || text.includes('OK')) div.className += ' line-ok';
  else if (text.includes('⚠️') || text.includes('retry')) div.className += ' line-warn';
  else if (text.includes('═══') || text.includes('RESUMEN') || text.includes('Pipeline') || text.includes('Batch')) div.className += ' line-head';

  // Color-code worker prefixes [W0], [W1], etc.
  const wMatch = text.match(/^\[W(\d+)\]/);
  if (wMatch) {
    const wIdx = parseInt(wMatch[1]);
    const color = WORKER_COLORS[wIdx % WORKER_COLORS.length];
    const prefix = document.createElement('span');
    prefix.style.cssText = `color:${color};font-weight:700;margin-right:4px`;
    prefix.textContent = `[W${wIdx}]`;
    const rest = document.createTextNode(text.slice(wMatch[0].length));
    div.appendChild(prefix);
    div.appendChild(rest);
  } else {
    div.textContent = text;
  }

  output.appendChild(div);
  output.scrollTop = output.scrollHeight;
}

function updatePipelineStatus(status, text) {
  const dot = document.getElementById('p-dot');
  const label = document.getElementById('p-status');
  if (dot) { dot.className = 'status-dot ' + status; }
  if (label) label.textContent = text;
}

async function cancelPipeline() {
  if (!S.pipeline.activeRun) return;
  try {
    await fetch('/api/pipeline/cancel/' + S.pipeline.activeRun, { method: 'POST', headers: AUTH_HEADERS });
  } catch (e) {}
  updatePipelineStatus('cancelled', 'Cancelado por el usuario');
  document.getElementById('btn-run').disabled = false;
  document.getElementById('btn-dryrun').disabled = false;
  document.getElementById('btn-cancel').disabled = true;
}

async function refreshCompleteness() {
  try {
    const data = await api('/api/pipeline/status');
    S.pipeline.statusData = data;
    const scroll = document.querySelector('.completeness-scroll');
    if (scroll) scroll.outerHTML = completenessHTML(data);
  } catch (e) {}
}

// ============ META ADS VIEWS ============

async function loadOverviewMeta() {
  const el = document.getElementById('view-overview');
  el.innerHTML = '<div class="loading">Loading advertisers...</div>';
  try {
    const data = await api('/api/meta/advertisers');
    S.metaAdvertisers = data.advertisers;
    data.advertisers.forEach((a, i) => { S.colors[a.anunciante] = PALETTE[i % PALETTE.length]; });
    if (!S.metaAnalytics.anunciante && data.advertisers.length) S.metaAnalytics.anunciante = data.advertisers[0].anunciante;

    const totalAds = data.advertisers.reduce((a, c) => a + c.total_ads, 0);
    const totalActivos = data.advertisers.reduce((a, c) => a + c.activos, 0);

    el.innerHTML = `
      <h2 style="margin-bottom:4px">Advertisers Overview</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:16px">${totalAds} ads &middot; ${totalActivos} activos &middot; ${data.advertisers.length} anunciantes</p>
      <div class="cards-grid">${data.advertisers.map(advertiserCard).join('')}</div>
    `;
  } catch (e) { el.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

function advertiserCard(a) {
  const col = getColor(a.anunciante);
  return `
  <div class="card" style="border-color:${col}55" onclick="goToAdvertiser('${a.anunciante}')">
    <div class="card-header" style="flex-direction:column;align-items:flex-start;gap:8px">
      <h3>${a.anunciante}</h3>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <span class="badge" style="background:${col}33;color:${col}">${a.total_ads} ads</span>
        <span class="badge" style="background:var(--green)22;color:var(--green)">${a.activos} activos</span>
        ${a.inactivos > 0 ? `<span class="badge" style="background:var(--red)22;color:var(--red)">${a.inactivos} inactivos</span>` : ''}
      </div>
    </div>
    <div class="stats-row">
      <div class="stat"><label>Videos</label><value>${a.videos}</value></div>
      <div class="stat"><label>Images</label><value>${a.imagenes}</value></div>
      <div class="stat"><label>Carruseles</label><value>${a.carruseles}</value></div>
    </div>
    <div class="stats-row" style="margin-bottom:0">
      <div class="stat"><label>Completitud</label><value style="font-size:15px;color:${pctColor(a.complete_pct)}">${a.complete_pct}%</value></div>
      <div class="stat"><label>Desde</label><value style="font-size:12px;color:var(--text2)">${a.primera_fecha || '-'}</value></div>
      <div class="stat"><label>Hasta</label><value style="font-size:12px;color:var(--text2)">${a.ultima_fecha || '-'}</value></div>
    </div>
  </div>`;
}

function goToAdvertiser(a) {
  S.ads.anunciante = a;
  S.ads.page = 1;
  switchView('videos');
}

// --- META: Ads table ---
async function loadAds() {
  const el = document.getElementById('view-videos');
  const { page, anunciante, sort, order, search } = S.ads;
  const params = new URLSearchParams({ page, limit: 50, sort, order });
  if (anunciante) params.set('anunciante', anunciante);
  if (search) params.set('search', search);

  el.innerHTML = adsFiltersHTML() + '<div class="loading">Loading ads...</div>';
  bindAdFilters();

  try {
    const data = await api('/api/meta/ads?' + params);
    el.innerHTML = adsFiltersHTML() + adsTableHTML(data) + paginationHTML(data, 'adsPage');
    bindAdFilters();
  } catch (e) { el.innerHTML = adsFiltersHTML() + `<div class="empty">Error: ${e.message}</div>`; bindAdFilters(); }
}

function adsFiltersHTML() {
  const opts = S.metaAdvertisers.map(a => `<option value="${a.anunciante}" ${S.ads.anunciante===a.anunciante?'selected':''}>${a.anunciante}</option>`).join('');
  return `
  <div class="filters">
    <select id="af-anunciante"><option value="">All Advertisers</option>${opts}</select>
    <select id="af-sort">
      <option value="created_at" ${S.ads.sort==='created_at'?'selected':''}>Date Added</option>
      <option value="fecha_inicio" ${S.ads.sort==='fecha_inicio'?'selected':''}>Start Date</option>
      <option value="estado" ${S.ads.sort==='estado'?'selected':''}>Status</option>
      <option value="tipo_media" ${S.ads.sort==='tipo_media'?'selected':''}>Type</option>
    </select>
    <select id="af-order">
      <option value="DESC" ${S.ads.order==='DESC'?'selected':''}>Desc</option>
      <option value="ASC" ${S.ads.order==='ASC'?'selected':''}>Asc</option>
    </select>
    <input id="af-search" type="text" placeholder="Search hook, text, transcript..." value="${S.ads.search}">
  </div>`;
}

function bindAdFilters() {
  const an = document.getElementById('af-anunciante');
  const so = document.getElementById('af-sort');
  const or = document.getElementById('af-order');
  const se = document.getElementById('af-search');
  if (an) an.onchange = () => { S.ads.anunciante = an.value; S.ads.page = 1; loadAds(); };
  if (so) so.onchange = () => { S.ads.sort = so.value; S.ads.page = 1; loadAds(); };
  if (or) or.onchange = () => { S.ads.order = or.value; S.ads.page = 1; loadAds(); };
  if (se) se.oninput = () => debounce(() => { S.ads.search = se.value; S.ads.page = 1; loadAds(); }, 400);
}

function adsTableHTML(data) {
  if (!data.ads.length) return '<div class="empty">No ads found</div>';
  const rows = data.ads.map(a => {
    const statusCol = a.estado === 'activo' ? 'var(--green)' : 'var(--red)';
    const esc = s => (s||'').replace(/"/g,'&quot;');
    return `
    <tr onclick="openAd(${a.id})">
      <td class="num">${a.id}</td>
      <td><span class="badge" style="background:${getColor(a.anunciante)}33;color:${getColor(a.anunciante)}">${a.anunciante}</span></td>
      <td style="font-size:11px;color:var(--text2)">${a.ad_id || '-'}</td>
      <td><span style="color:${statusCol};font-weight:700;font-size:11px">${a.estado || '-'}</span></td>
      <td style="font-size:11px;color:var(--text2)">${a.plataformas || '-'}</td>
      <td style="color:var(--text2);white-space:nowrap">${a.fecha_inicio || '-'}</td>
      <td style="color:var(--text2);white-space:nowrap">${a.fecha_fin || '-'}</td>
      <td>${a.tipo_media || '-'}</td>
      <td class="cell-trunc" title="${esc(a.titulo)}">${trunc(a.titulo, 40) || '-'}</td>
      <td class="cell-trunc" title="${esc(a.texto_principal)}">${trunc(a.texto_principal, 50) || '-'}</td>
      <td class="cell-trunc" title="${esc(a.descripcion)}">${trunc(a.descripcion, 40) || '-'}</td>
      <td>${a.cta || '-'}</td>
      <td class="cell-trunc" title="${esc(a.hook)}">${trunc(a.hook, 40) || '-'}</td>
      <td class="cell-trunc" title="${esc(a.tematica)}">${trunc(a.tematica, 30) || '-'}</td>
      <td class="cell-trunc">${trunc(a.formula_hook, 30) || '-'}</td>
      <td class="cell-trunc">${trunc(a.semantica_inicio, 25) || '-'}</td>
      <td class="cell-trunc">${trunc(a.semantica_ruta, 25) || '-'}</td>
      <td class="cell-trunc">${trunc(a.semantica_cluster, 25) || '-'}</td>
      <td class="cell-trunc">${trunc(a.visual_inicio, 25) || '-'}</td>
      <td class="cell-trunc">${trunc(a.visual_ruta, 25) || '-'}</td>
      <td class="cell-trunc">${trunc(a.visual_cluster, 25) || '-'}</td>
      <td class="cell-trunc" title="${esc(a.nomenclatura_ad)}">${trunc(a.nomenclatura_ad, 30) || '-'}</td>
      <td class="cell-trunc" title="${esc(a.transcripcion)}">${trunc(a.transcripcion, 40) || '-'}</td>
      <td class="cell-trunc" title="${esc(a.visual)}">${trunc(a.visual, 40) || '-'}</td>
      <td class="num">${a.edad_min || '-'}</td>
      <td class="num">${a.edad_max || '-'}</td>
      <td>${a.genero_audiencia || '-'}</td>
      <td>${a.pais_audiencia || '-'}</td>
      <td class="num">${a.alcance_eu || '-'}</td>
      <td class="cell-trunc" title="${esc(a.url_destino)}">${trunc(a.url_destino, 35) || '-'}</td>
      <td>${a.instagram_handle || '-'}</td>
      <td style="font-size:11px;color:var(--text2)">${a.page_id || '-'}</td>
      <td class="cell-trunc" style="font-size:11px">${a.ad_url ? `<a href="${a.ad_url}" target="_blank" onclick="event.stopPropagation()">🔗 Link</a>` : '-'}</td>
      <td class="cell-trunc" style="font-size:11px">${a.media_url ? `<a href="${a.media_url}" target="_blank" onclick="event.stopPropagation()">📎 Media</a>` : '-'}</td>
      <td style="font-size:10px;color:var(--text3);white-space:nowrap">${a.fecha_analisis || '-'}</td>
      <td style="font-size:10px;color:var(--text3);white-space:nowrap">${a.created_at || '-'}</td>
      <td style="font-size:10px;color:var(--text3);white-space:nowrap">${a.updated_at || '-'}</td>
    </tr>`;
  }).join('');

  return `<div class="table-scroll"><table style="min-width:5000px">
    <thead><tr>
      <th>ID</th><th>Advertiser</th><th>Ad ID</th><th>Status</th><th>Plataformas</th>
      <th>F.Inicio</th><th>F.Fin</th><th>Type</th><th>Título</th><th>Text</th>
      <th>Desc</th><th>CTA</th><th>Hook</th><th>Temática</th><th>F.Hook</th>
      <th>Sem.Inicio</th><th>Sem.Ruta</th><th>Sem.Cluster</th>
      <th>Vis.Inicio</th><th>Vis.Ruta</th><th>Vis.Cluster</th>
      <th>Nomenclatura</th><th>Transcripción</th><th>Visual</th>
      <th>Edad↓</th><th>Edad↑</th><th>Género</th><th>País</th><th>Alcance EU</th>
      <th>URL Destino</th><th>Instagram</th><th>Page ID</th>
      <th>Ad URL</th><th>Media URL</th><th>F.Análisis</th><th>Created</th><th>Updated</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function adsPage(p) { S.ads.page = p; loadAds(); }

// --- META: Ad detail popup ---
async function openAd(id) {
  const overlay = document.getElementById('overlay');
  const popup = overlay.querySelector('.popup');
  overlay.classList.add('active');
  popup.innerHTML = '<div class="loading" style="padding:60px">Loading...</div>';

  try {
    const data = await api('/api/meta/ads/' + id);
    const a = data.ad;
    const col = getColor(a.anunciante);
    const screenshotUrl = `/meta-screenshots/${a.ad_id}.png`;
    const screenshotUrl2 = `/meta-screenshots/runna_${a.ad_id}.jpg`;

    popup.innerHTML = `
      <div class="popup-header" style="background:linear-gradient(135deg,${col},${col}88)">
        <div>
          <h2>${a.anunciante} — Ad #${a.id}</h2>
          <a href="${a.ad_url}" target="_blank" style="color:#fff;opacity:.8;font-size:12px">${trunc(a.ad_url, 60)}</a>
        </div>
        <button class="popup-close" onclick="closePopup()">&times;</button>
      </div>
      <div class="popup-body">
        <div class="metrics-row">
          <div class="metric"><label>Status</label><value style="color:${a.estado==='activo'?'var(--green)':'var(--red)'};font-size:16px">${a.estado || '-'}</value></div>
          <div class="metric"><label>Type</label><value style="font-size:16px">${a.tipo_media || '-'}</value></div>
          <div class="metric"><label>Start</label><value style="font-size:14px;color:var(--text2)">${a.fecha_inicio || '-'}</value></div>
          <div class="metric"><label>End</label><value style="font-size:14px;color:var(--text2)">${a.fecha_fin || 'Active'}</value></div>
        </div>
        <div class="metrics-row">
          <div class="metric"><label>Plataformas</label><value style="font-size:13px">${a.plataformas || '-'}</value></div>
          <div class="metric"><label>Ad ID</label><value style="font-size:11px;color:var(--text2)">${a.ad_id || '-'}</value></div>
          <div class="metric"><label>Page ID</label><value style="font-size:11px;color:var(--text2)">${a.page_id || '-'}</value></div>
          <div class="metric"><label>Nomenclatura</label><value style="font-size:12px;color:var(--orange)">${a.nomenclatura_ad || '-'}</value></div>
        </div>

        <div style="display:grid;grid-template-columns:300px 1fr;gap:20px;margin-bottom:24px">
          <div style="background:var(--bg);border-radius:var(--radius-sm);overflow:hidden;border:1px solid #333">
            <img src="${screenshotUrl}" alt="Ad screenshot" style="width:100%;display:block"
                 onerror="this.src='${screenshotUrl2}'; this.onerror=function(){this.style.display='none';this.parentElement.innerHTML='<div style=padding:40px;text-align:center;color:var(--text3)>No screenshot</div>'}">
          </div>
          <div>
            ${a.texto_principal ? `<div class="section"><h3>Ad Copy</h3><p>${a.texto_principal}</p></div>` : ''}
            ${a.titulo ? `<div class="section"><h3>Title</h3><p style="font-weight:700;color:var(--text)">${a.titulo}</p></div>` : ''}
            ${a.descripcion ? `<div class="section"><h3>Description</h3><p>${a.descripcion}</p></div>` : ''}
            ${a.cta ? `<div style="margin-bottom:16px"><span class="badge" style="background:var(--blue)22;color:var(--blue);padding:6px 14px;font-size:12px">CTA: ${a.cta}</span></div>` : ''}
          </div>
        </div>

        ${a.hook || a.tematica ? `<div class="section"><h3>Hook & Temática</h3>
          ${a.hook ? `<p style="color:var(--text);font-weight:600;margin-bottom:8px">${a.hook}</p>` : ''}
          ${a.tematica ? `<p style="color:var(--text2);margin-bottom:8px"><strong>Temática:</strong> ${a.tematica}</p>` : ''}
          <div class="tags" style="margin-top:8px">
            ${a.formula_hook ? `<span class="tag" style="background:${col}22;color:${col};border:1px solid ${col}55">Formula: ${a.formula_hook}</span>` : ''}
            ${a.semantica_inicio ? `<span class="tag" style="background:var(--blue)22;color:var(--blue);border:1px solid var(--blue)55">Sem.Inicio: ${a.semantica_inicio}</span>` : ''}
            ${a.semantica_ruta ? `<span class="tag" style="background:var(--blue)22;color:var(--blue);border:1px solid var(--blue)55">Sem.Ruta: ${a.semantica_ruta}</span>` : ''}
            ${a.semantica_cluster ? `<span class="tag" style="background:var(--blue)22;color:var(--blue);border:1px solid var(--blue)55">Sem.Cluster: ${a.semantica_cluster}</span>` : ''}
            ${a.visual_inicio ? `<span class="tag" style="background:var(--purple)22;color:var(--purple);border:1px solid var(--purple)55">Vis.Inicio: ${a.visual_inicio}</span>` : ''}
            ${a.visual_ruta ? `<span class="tag" style="background:var(--purple)22;color:var(--purple);border:1px solid var(--purple)55">Vis.Ruta: ${a.visual_ruta}</span>` : ''}
            ${a.visual_cluster ? `<span class="tag" style="background:var(--purple)22;color:var(--purple);border:1px solid var(--purple)55">Vis.Cluster: ${a.visual_cluster}</span>` : ''}
          </div>
        </div>` : ''}

        ${a.transcripcion ? `<div class="section"><h3>Transcription</h3><div class="transcript-box" onclick="this.classList.toggle('expanded')">${a.transcripcion}</div></div>` : ''}
        ${a.visual ? `<div class="section"><h3>Visual Analysis</h3><div class="transcript-box" onclick="this.classList.toggle('expanded')">${a.visual}</div></div>` : ''}

        ${(a.edad_min || a.edad_max || a.genero_audiencia || a.pais_audiencia || a.alcance_eu) ? `<div class="section"><h3>Audiencia</h3>
          <div class="metrics-row">
            <div class="metric"><label>Edad Min</label><value style="font-size:16px">${a.edad_min || '-'}</value></div>
            <div class="metric"><label>Edad Max</label><value style="font-size:16px">${a.edad_max || '-'}</value></div>
            <div class="metric"><label>Género</label><value style="font-size:14px">${a.genero_audiencia || '-'}</value></div>
            <div class="metric"><label>País</label><value style="font-size:14px">${a.pais_audiencia || '-'}</value></div>
          </div>
          ${a.alcance_eu ? `<p style="color:var(--text2);font-size:12px;margin-top:8px">Alcance EU: ${a.alcance_eu.toLocaleString()}</p>` : ''}
        </div>` : ''}

        ${(a.url_destino || a.instagram_handle || a.media_url) ? `<div class="section"><h3>Links</h3>
          ${a.url_destino ? `<p style="margin-bottom:6px"><strong style="color:var(--text2);font-size:11px">URL Destino:</strong> <a href="${a.url_destino}" target="_blank">${trunc(a.url_destino, 80)}</a></p>` : ''}
          ${a.instagram_handle ? `<p style="margin-bottom:6px"><strong style="color:var(--text2);font-size:11px">Instagram:</strong> ${a.instagram_handle}</p>` : ''}
          ${a.media_url ? `<p style="margin-bottom:6px"><strong style="color:var(--text2);font-size:11px">Media URL:</strong> <a href="${a.media_url}" target="_blank">${trunc(a.media_url, 80)}</a></p>` : ''}
        </div>` : ''}

        <div style="display:flex;gap:20px;font-size:10px;color:var(--text3);margin-top:16px;padding-top:12px;border-top:1px solid #333">
          ${a.fecha_analisis ? `<span>Análisis: ${a.fecha_analisis}</span>` : ''}
          ${a.created_at ? `<span>Creado: ${a.created_at}</span>` : ''}
          ${a.updated_at ? `<span>Actualizado: ${a.updated_at}</span>` : ''}
        </div>
      </div>
    `;
  } catch (e) { popup.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

// --- META: Analytics ---
async function loadAnalyticsMeta() {
  const el = document.getElementById('view-analytics');
  if (!S.metaAnalytics.anunciante && S.metaAdvertisers.length) S.metaAnalytics.anunciante = S.metaAdvertisers[0].anunciante;
  const a = S.metaAnalytics.anunciante;

  const opts = S.metaAdvertisers.map(ad => `<option value="${ad.anunciante}" ${a===ad.anunciante?'selected':''}>${ad.anunciante}</option>`).join('');
  el.innerHTML = `
    <div class="analytics-header">
      <h2>Meta Ads Analytics</h2>
      <select id="ma-anunciante"><option value="">All</option>${opts}</select>
    </div>
    <div class="chart-container"><h3>Formula Hook — Distribution</h3><div class="chart-wrap"><canvas id="chart-meta-hooks"></canvas></div></div>
    <div class="chart-container"><h3>Semantica Inicio — Distribution</h3><div class="chart-wrap"><canvas id="chart-meta-sem"></canvas></div></div>
    <div class="chart-container"><h3>Visual Inicio — Distribution</h3><div class="chart-wrap"><canvas id="chart-meta-vis"></canvas></div></div>
  `;

  document.getElementById('ma-anunciante').onchange = (e) => { S.metaAnalytics.anunciante = e.target.value; loadAnalyticsMeta(); };

  Object.values(S.charts).forEach(ch => ch.destroy());
  S.charts = {};

  const qp = a ? `?anunciante=${encodeURIComponent(a)}` : '';
  const [hooks, sem, vis] = await Promise.all([
    api('/api/meta/analytics/hooks' + qp),
    api('/api/meta/analytics/semantica' + qp),
    api('/api/meta/analytics/visual' + qp)
  ]);

  renderMetaBarChart('chart-meta-hooks', hooks.patterns, 'formula_hook');
  renderMetaBarChart('chart-meta-sem', sem.patterns, 'semantica_inicio');
  renderMetaBarChart('chart-meta-vis', vis.patterns, 'visual_inicio');
}

function renderMetaBarChart(canvasId, patterns, labelKey) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const top15 = patterns.slice(0, 15);
  if (top15.length === 0) { canvas.parentElement.innerHTML = '<div class="empty" style="padding:40px">No data yet</div>'; return; }
  const labels = top15.map(p => trunc(p[labelKey], 25));
  const data = top15.map(p => p.total);

  S.charts[canvasId] = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Count',
        data,
        backgroundColor: '#e67e2299',
        borderColor: '#e67e22',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#e8e8e8', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#888', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#222' } },
        y: { ticks: { color: '#888' }, grid: { color: '#222' }, beginAtZero: true }
      }
    }
  });
}

// --- META: Compare ---
async function loadCompareMeta() {
  const el = document.getElementById('view-compare');
  el.innerHTML = '<div class="loading">Loading comparison...</div>';

  try {
    const data = await api('/api/meta/analytics/compare');
    const comp = data.comparison;

    el.innerHTML = `
      <h2 style="margin-bottom:16px">Advertiser Comparison</h2>
      <div class="chart-container">
        <h3>Metrics Table</h3>
        <table class="compare-table">
          <thead><tr><th>Advertiser</th><th>Total Ads</th><th>Active</th><th>Inactive</th><th>Videos</th><th>Images</th><th>Carousels</th></tr></thead>
          <tbody>
            ${comp.map(c => `<tr>
              <td><span class="badge" style="background:${getColor(c.anunciante)}33;color:${getColor(c.anunciante)}">${c.anunciante}</span></td>
              <td>${fmt(c.total_ads)}</td>
              <td style="color:var(--green)">${fmt(c.activos)}</td>
              <td style="color:var(--red)">${fmt(c.total_ads - c.activos)}</td>
              <td>${fmt(c.videos)}</td>
              <td>${fmt(c.imagenes)}</td>
              <td>${fmt(c.carruseles)}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    `;
  } catch (e) { el.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

// --- META: Pipeline ---
const META_PHASES = ['download_media','transcripcion_visual','analisis_imagen','semantica','analisis_imagen_2','embeddings'];
const META_PHASE_LABELS = {
  download_media: '📥 Download Media', transcripcion_visual: '🎬 Video Paso1',
  analisis_imagen: '🖼️ Imagen Paso1', semantica: '🧠 Video Paso2',
  analisis_imagen_2: '📊 Imagen Paso2', embeddings: '🔢 Embeddings'
};

function metaPipelineConfigHTML(data) {
  const advOpts = data.advertisers.map(a => `<option value="${a.anunciante}">${a.anunciante} (${a.total})</option>`).join('');

  const phaseToggles = META_PHASES.map(p =>
    `<div class="phase-btn active" onclick="togglePhase(this)" data-phase="${p}"><input type="checkbox" checked> ${META_PHASE_LABELS[p]||p}</div>`
  ).join('');

  return `
    <div class="pipeline-config">
      <h3 style="margin-bottom:14px;font-size:14px;font-weight:700">Configuracion Meta Ads Pipeline</h3>
      <div class="config-grid">
        <div class="config-group">
          <label class="config-label">Anunciante</label>
          <select id="p-anunciante"><option value="">— Todos —</option>${advOpts}</select>
        </div>
        <div class="config-group">
          <label class="config-label">Ad IDs (DB)</label>
          <input id="p-ids" placeholder="349,350,351">
        </div>
        <div class="config-group">
          <label class="config-label">WHERE SQL</label>
          <input id="p-where" placeholder="tipo_media = 'VIDEO'">
        </div>
        <div class="config-group">
          <label class="config-label">Limit</label>
          <input id="p-limit" type="number" placeholder="Sin limite" min="1">
        </div>
        <div class="config-group full-width">
          <label class="config-label">Fases</label>
          <div class="phase-toggles" id="p-phases">${phaseToggles}</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button style="background:var(--bg);color:var(--text2);border:1px solid #333;border-radius:6px;padding:4px 12px;font-size:10px;cursor:pointer" onclick="toggleAllPhases(true)">All</button>
            <button style="background:var(--bg);color:var(--text2);border:1px solid #333;border-radius:6px;padding:4px 12px;font-size:10px;cursor:pointer" onclick="toggleAllPhases(false)">None</button>
          </div>
        </div>
        <div class="config-group">
          <label class="config-label">Workers en paralelo</label>
          <div style="display:flex;align-items:center;gap:10px">
            <select id="p-workers" style="width:80px">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4" selected>4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
            <span style="font-size:11px;color:var(--text3)">Procesos simultaneos</span>
          </div>
        </div>
      </div>
      <div class="config-actions">
        <button class="run-btn" id="btn-run" onclick="startMetaPipeline(false)">▶ Run Pipeline</button>
        <button class="dryrun-btn" id="btn-dryrun" onclick="startMetaPipeline(true)">Dry Run</button>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer;margin-left:12px">
          <input type="checkbox" id="p-force" style="accent-color:var(--orange)"> Force re-analysis
        </label>
      </div>
    </div>`;
}

async function startMetaPipeline(dryRun) {
  const anunciante = document.getElementById('p-anunciante').value;
  const ids = document.getElementById('p-ids').value.trim();
  const where = document.getElementById('p-where').value.trim();

  if (!anunciante && !ids && !where) {
    alert('Necesitas al menos un filtro: Anunciante, IDs, o WHERE');
    return;
  }

  const body = { table: 'meta_ads' };
  if (anunciante) body.anunciante = anunciante;
  if (ids) body.ids = ids.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
  if (where) body.where = where;

  const phases = [...document.querySelectorAll('#p-phases .phase-btn.active')].map(el => el.dataset.phase);
  if (phases.length < META_PHASES.length) body.only = phases;

  const limit = document.getElementById('p-limit').value;
  if (limit) body.limit = parseInt(limit);
  const workers = parseInt(document.getElementById('p-workers')?.value || '1');
  if (workers > 1) body.workers = workers;
  if (dryRun) body.dryRun = true;
  const force = document.getElementById('p-force')?.checked;
  if (force) body.force = true;

  document.getElementById('btn-run').disabled = true;
  document.getElementById('btn-dryrun').disabled = true;
  document.getElementById('btn-cancel').disabled = false;
  document.getElementById('console-output').innerHTML = '';

  const statusMsg = workers > 1
    ? (dryRun ? `Dry run (${workers} workers)...` : `Meta pipeline — ${workers} workers en paralelo...`)
    : (dryRun ? 'Dry run en curso...' : 'Meta pipeline en ejecucion...');
  updatePipelineStatus('running', statusMsg);

  try {
    const res = await fetch('/api/pipeline/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...AUTH_HEADERS },
      body: JSON.stringify(body)
    });
    const result = await res.json();

    if (!res.ok) {
      updatePipelineStatus('failed', result.error || 'Error al iniciar');
      document.getElementById('btn-run').disabled = false;
      document.getElementById('btn-dryrun').disabled = false;
      document.getElementById('btn-cancel').disabled = true;
      return;
    }

    if (result.batchId) {
      S.pipeline.activeRun = result.batchId;
      S.pipeline.isBatch = true;
      appendConsoleLine(`🚀 Meta Batch: ${result.workers} workers en paralelo`);
      appendConsoleLine('─'.repeat(50));
      connectToBatchStream(result.batchId);
    } else {
      S.pipeline.activeRun = result.runId;
      S.pipeline.isBatch = false;
      connectToStream(result.runId);
    }
  } catch (e) {
    updatePipelineStatus('failed', 'Error: ' + e.message);
    document.getElementById('btn-run').disabled = false;
    document.getElementById('btn-dryrun').disabled = false;
    document.getElementById('btn-cancel').disabled = true;
  }
}

async function loadPipelineMeta() {
  const el = document.getElementById('view-pipeline');
  el.innerHTML = '<div class="loading">Loading meta ads pipeline...</div>';

  try {
    const [data, runsData] = await Promise.all([
      api('/api/meta/pipeline/status'),
      api('/api/pipeline/runs')
    ]);

    const activeRun = runsData.runs.find(r => r.status === 'running');
    const lastRun = runsData.runs[0];

    el.innerHTML = `
      <h2 style="margin-bottom:4px">Meta Ads Pipeline</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:16px">Ejecuta el pipeline de analisis IA sobre tus Meta Ads</p>
      ${metaCompletenessHTML(data)}
      ${metaPipelineConfigHTML(data)}
      ${pipelineConsoleHTML()}
      ${pipelineRunsHistoryHTML(runsData.runs)}
    `;

    if (activeRun) {
      S.pipeline.activeRun = activeRun.runId;
      S.pipeline.isBatch = !!activeRun.isBatch;
      const msg = activeRun.isBatch ? `Batch en ejecución — ${activeRun.workers} workers...` : 'Pipeline en ejecución...';
      updatePipelineStatus('running', msg);
      document.getElementById('btn-cancel').disabled = false;
      if (activeRun.isBatch) {
        connectToBatchStream(activeRun.runId);
      } else {
        connectToStream(activeRun.runId);
      }
    } else if (lastRun) {
      const isBatch = lastRun.isBatch;
      const statusLabel = lastRun.status === 'completed' ? (isBatch ? 'Batch completado' : 'Completado') :
                          lastRun.status === 'failed' ? (isBatch ? 'Batch con errores' : 'Error') :
                          lastRun.status === 'cancelled' ? (isBatch ? 'Batch cancelado' : 'Cancelado') : lastRun.status;
      const timeAgo = getTimeAgo(lastRun.endedAt || lastRun.startedAt);
      updatePipelineStatus(lastRun.status, `Último: ${statusLabel} (exit ${lastRun.exitCode}) — ${timeAgo}`);
    }
  } catch (e) { el.innerHTML = `<div class="empty">Error: ${e.message}</div>`; }
}

function metaCompletenessHTML(data) {
  const fields = [
    { key: 'sin_url', label: 'URL' },
    { key: 'sin_estado', label: 'Estado' },
    { key: 'sin_fecha', label: 'Fecha' },
    { key: 'sin_tipo', label: 'Tipo' },
    { key: 'sin_media', label: 'Media' },
    { key: 'sin_texto', label: 'Texto' },
    { key: 'sin_titulo', label: 'Título' },
    { key: 'sin_descripcion', label: 'Desc' },
    { key: 'sin_cta', label: 'CTA' },
    { key: 'sin_transcripcion', label: 'Trans' },
    { key: 'sin_visual', label: 'Visual' },
    { key: 'sin_hook', label: 'Hook' },
    { key: 'sin_tematica', label: 'Tema' },
    { key: 'sin_formula', label: 'F.Hook' },
    { key: 'sin_sem_i', label: 'Sem.I' },
    { key: 'sin_sem_r', label: 'Sem.R' },
    { key: 'sin_sem_c', label: 'Sem.C' },
    { key: 'sin_vis_i', label: 'Vis.I' },
    { key: 'sin_vis_r', label: 'Vis.R' },
    { key: 'sin_vis_c', label: 'Vis.C' },
    { key: 'sin_nom', label: 'Nom' },
  ];

  const rows = data.advertisers.map(a => {
    const cells = fields.map(f => {
      const v = a[f.key] || 0;
      const total = a.total;
      const pct = total > 0 ? v / total : 0;
      const cls = v === 0 ? 'c-zero' : pct > 0.5 ? 'c-bad' : pct > 0.1 ? 'c-warn' : 'c-ok';
      return `<td class="${cls}" title="${a.anunciante}: ${v}/${total} sin ${f.label}">${v === 0 ? '✓' : v}</td>`;
    }).join('');
    const col = getColor(a.anunciante);
    return `<tr><td><span style="color:${col}">${a.anunciante}</span> <span style="color:var(--text3);font-size:10px">(${a.total})</span></td>${cells}</tr>`;
  }).join('');

  return `
    <div class="completeness-scroll">
      <table class="cmatrix">
        <thead><tr>
          <th>Advertiser</th>
          ${fields.map(f => `<th>${f.label}</th>`).join('')}
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

// ============ INIT ============
loadOverview();

// Listen for postMessage from parent (intranet iframe)
window.addEventListener('message', (e) => {
  if (e.data && e.data.type === 'setView' && e.data.view) {
    switchView(e.data.view);
  }
});

// Hide nav bar when embedded in iframe
if (window !== window.top) {
  const nav = document.getElementById('nav');
  if (nav) nav.style.display = 'none';
}
</script>
</body>
</html>
